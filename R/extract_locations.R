#' Extract landing locations
#'
#' @param this.catchfileno
#' @param catch.files files of fishery catch
#' @param coast.selecc selected coastal states
#'
#' @return catch.file.sites.loc
#' @export
#'
#' @examples
extract_locations <- function(this.catchfileno, catch.files, coast.selecc, locs.pesca, inegi.cost.comm.all){

  this.catchfile <- catch.files[this.catchfileno]

  catch.file <- data.table::fread(this.catchfile, skip=2)

  correct.ent <- locs.pesca %>%
    select(-NOM_LOC_REV)

  correct.loc <- locs.pesca %>%
    select(-NOM_ENT_REV) %>%
    keep_when(!is.na(NOM_LOC_REV))

  catch.file.sites <- catch.file %>%
    dplyr::mutate(`NOMBRE SITIO DESEMBARQUE` = gsub("Ã‘","Ñ", `NOMBRE SITIO DESEMBARQUE`)) %>%
    dplyr::mutate(`NOMBRE SITIO DESEMBARQUE` = dplyr::na_if(`NOMBRE SITIO DESEMBARQUE`,"")) %>%
    dplyr::filter(`NOMBRE SITIO DESEMBARQUE`!="NA")

  catch.file.sites.table <- catch.file.sites %>%
    dplyr::distinct(`NOMBRE ESTADO`, `NOMBRE SITIO DESEMBARQUE`) %>%
    dplyr::rename(NOM_ENT = `NOMBRE ESTADO`, NOM_LOC = `NOMBRE SITIO DESEMBARQUE`) %>%
    dplyr::mutate(NOM_ENT= stringi::stri_trans_general(str = NOM_ENT, id = "Latin-ASCII"), NOM_ENT = toupper(NOM_ENT)) %>%
    dplyr::mutate(NOM_LOC = stringi::stri_trans_general(str = NOM_LOC, id = "Latin-ASCII"), NOM_LOC = toupper(NOM_LOC)) %>%
    dplyr::mutate(NOM_ENT = stringr::str_trim(NOM_ENT), NOM_LOC = stringr::str_trim(NOM_LOC))

  catch.file.sites.loc <- catch.file.sites.table %>%
    dplyr::left_join(correct.ent, by =c("NOM_LOC","NOM_ENT")) %>%
    mutate(NOM_ENT = dplyr::if_else(!is.na(NOM_ENT_REV), NOM_ENT_REV, NOM_ENT)) %>%
    dplyr::left_join(correct.loc, by =c("NOM_LOC","NOM_ENT")) %>%
    mutate(NOM_LOC = dplyr::if_else(!is.na(NOM_LOC_REV), NOM_LOC_REV, NOM_LOC)) %>%
    mutate(NOM_LOC = gsub(" \\(B\\.C\\.S\\.\\)","", NOM_LOC)) %>%
    dplyr::left_join(inegi.cost.comm.all, by =c("NOM_ENT","NOM_LOC")) %>%
    dplyr::filter(NOM_ENT %in% coast.selecc) %>%
    distinct(NOM_ENT, NOM_MUN, NOM_LOC, CVE_MUN, CVE_LOC, deci_lat, deci_lon, POBTOT) %>%
    keep_when(!is.na(CVE_LOC))



  return(catch.file.sites.loc)
}
