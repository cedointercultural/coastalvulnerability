#' @param inegi.2020
#'
#' @param crs.proj.utm
#' @param crs.proj.wgs
#' @param mun.cost
#' @param ents.coast.selecc
#'
#' @title get community data
#' @description  gets location data
#' @details INPUT: 1) data
#' @details OUTPUT: 1) locations
#' @keywords function inegi
#' @usage get_community data()

get_community_data <- function(inegi.2020, crs.proj.utm, crs.proj.wgs, mun.cost, ents.coast.selecc) {

  #census data https://www.inegi.org.mx/contenidos/programas/ccpv/2020/datosabiertos/iter/iter_00_cpv2020_csv.zip

  #Decimal Degrees = degrees + (minutes/60) + (seconds/3600)

  #convert from lat long to decimal degrees
  inegi.2020.id <- inegi.2020 %>%
    dplyr::filter(!is.na(LONGITUD)) %>%
    dplyr::select(CVE_LOC, everything()) %>%
    tidyr::separate(LONGITUD,c("lon_deg","lon"),"°") %>%
    tidyr::separate(lon,c("lon_min","lon_sec"),"'") %>%
    dplyr::mutate(lon_sec = gsub("\".*\ W","",lon_sec)) %>%
    tidyr::separate(LATITUD,c("lat_deg","lat"),"°") %>%
    tidyr::separate(lat,c("lat_min","lat_sec"),"'") %>%
    dplyr::mutate(lat_sec = gsub("\".*\ N","",lat_sec)) %>%
    dplyr::mutate(across(lon_deg:lat_sec,as.numeric)) %>%
    dplyr::mutate(dec_lon= (lon_deg + (lon_min / 60) + (lon_sec / 3600))*-1,
           dec_lat=(lat_deg + (lat_min / 60) + (lat_sec / 3600))) %>%
    dplyr::mutate(deci_lon = dec_lon, deci_lat = dec_lat) %>%  #duplicate to keep with table
    dplyr::mutate(across(POBFEM:TAMLOC, as.numeric)) %>%
    dplyr::select(-"PCDISC_MOT2") # var name returns error message


#convert into spatial layer
  inegi.2020.coords <- inegi.2020.id
  sp::coordinates(inegi.2020.coords) <- c("dec_lon","dec_lat")

# define coord system and project
  sp::proj4string(inegi.2020.coords) <- crs.proj.wgs
  inegi.2020.coords.sf <- sf::st_as_sf(inegi.2020.coords)

  inegi.2020.coords.proj <- sf::st_transform(inegi.2020.coords.sf, crs.proj.utm) %>%
    dplyr::rename(CVE_ENT = ENTIDAD, CVE_MUN = MUN, CVE_LOC = LOC)

  inegi.comms <- make_code(inegi.2020.coords.proj)

  mun.codes <- mun.cost %>%
  sf::st_drop_geometry() %>%
    dplyr::mutate(mun_cve = gsub("\\[","",mun_code),
                  mun_cve = gsub("\\]","",mun_cve),
                  mun_cve = gsub("\\'","",mun_cve)) %>%
    dplyr::pull(mun_cve)

  #subset coastal municipalities and all locations
  inegi.edo.coste.all <- inegi.comms %>%
    dplyr::filter(CVE_MUN %in% mun.codes) %>%
    dplyr::mutate(id_row = 1:nrow(.)) %>%
    dplyr::select(-starts_with("lon_"),-starts_with("lat_"))

  inegi.cost.comm.all <- inegi.edo.coste.all %>%
    sf::st_drop_geometry() %>%
    dplyr::distinct(NOM_ENT, CVE_ENT, NOM_MUN, CVE_MUN, NOM_LOC, CVE_LOC, deci_lat, deci_lon, POBTOT)

  readr::write_csv(inegi.cost.comm.all,paste0(input.dir,"/processed_data/","all_coastal_communities_INEGI.csv"))

  #subset coastal municipalities with census data
  inegi.edo.coste <- inegi.edo.coste.all %>%
    dplyr::filter(!is.na(POBFEM))

  data.comm.costas <- inegi.edo.coste %>%
    sf::st_drop_geometry()

  readr::write_csv(data.comm.costas,here::here("outputs","comunidades_costeras_INEGI.csv"))

  return(inegi.edo.coste)

}
