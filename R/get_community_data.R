#' @title get community data
#' @description  gets location data
#' @details INPUT: 1) data
#' @details OUTPUT: 1) locations
#' @keywords function inegi
#' @usage get_community data()
#' @param crs.proj.utm,crs.proj.wgs, atlantic.shp, pacific.shp, est.2019, inegi.2020
#' @export
#' @return inegi.cost.wgs

get_community_data <- function(crs.proj.utm, crs.proj.wgs, atlantic.shp, pacific.shp, est.2019, inegi.2020) {

  #datos pueden ser obtenidos de https://www.inegi.org.mx/contenidos/programas/ccpv/2020/datosabiertos/iter/iter_00_cpv2020_csv.zip

  #oceanos
  atlantic.shp.proj <- sf::st_transform(atlantic.shp, crs.proj.utm)

  pacific.shp.proj <- sf::st_transform(pacific.shp, crs.proj.utm)

  #estados.mx <- cbind(est.2019, st_coordinates(st_centroid(est.2019)))

  #Decimal Degrees = degrees + (minutes/60) + (seconds/3600)

  #calcular grados decimales en base a coordenadas grados minutos segundos
  inegi.2020.id <- inegi.2020 %>%
    dplyr::filter(!is.na(LONGITUD)) %>%
    dplyr::mutate(COM_ID = paste0(ENTIDAD,"_",MUN, "_",LOC)) %>%
    dplyr::select(COM_ID, everything()) %>%
    tidyr::separate(LONGITUD,c("lon_deg","lon"),"°") %>%
    tidyr::separate(lon,c("lon_min","lon_sec"),"'") %>%
    dplyr::mutate(lon_sec = gsub("\".*\ W","",lon_sec)) %>%
    tidyr::separate(LATITUD,c("lat_deg","lat"),"°") %>%
    tidyr::separate(lat,c("lat_min","lat_sec"),"'") %>%
    dplyr::mutate(lat_sec = gsub("\".*\ N","",lat_sec)) %>%
    dplyr::mutate(across(lon_deg:lat_sec,as.numeric)) %>%
    dplyr::mutate(dec_lon= (lon_deg + (lon_min / 60) + (lon_sec / 3600))*-1,
           dec_lat=(lat_deg + (lat_min / 60) + (lat_sec / 3600))) %>%
    dplyr::mutate(across(POBFEM:TAMLOC, as.numeric)) %>%
    dplyr::select(-"PCDISC_MOT2") # poralguna razon el nombre de esta variable causa un error


  #convertir en capa geografica
  inegi.2020.coords <- inegi.2020.id

  sp::coordinates(inegi.2020.coords) <- c("dec_lon","dec_lat")

  #definir proyeccion geografica y proyectar a utm
  sp::proj4string(inegi.2020.coords) <- crs.proj.wgs
  inegi.2020.coords.sf <- sf::st_as_sf(inegi.2020.coords)
  inegi.2020.coords.proj <- sf::st_transform(inegi.2020.coords.sf, crs.proj.utm)

  #delimitar datos censales a estados costeros
  inegi.edo.coste <- inegi.2020.coords.proj %>%
    dplyr::filter(NOM_ENT %in% c("Baja California Sur", "Baja California", "Sonora", "Sinaloa", "Nayarit", "Jalisco", "Colima", "Michoacán de Ocampo", "Guerrero", "Oaxaca", "Chiapas", "Quintana Roo", "Yucatán", "Campeche", "Tabasco", "Veracruz de Ignacio de la Llave", "Tamaulipas")) %>%
    dplyr::mutate(id_row = 1:nrow(.))

  #seleccionar comunidades costeras a 30 km de la costa del Pacifico
  distance.pacific <- sf::st_distance(inegi.edo.coste, sf::st_cast(pacific.shp.proj,"POLYGON")) %>%
    dplyr::as_tibble() %>%
    dplyr::mutate(id_row = 1:nrow(.))

  rows.coast.pacific <- distance.pacific %>%
    dplyr::mutate(dist = as.numeric(value)) %>%
    dplyr::filter(dist<30000) %>%
    dplyr::pull(id_row)

  inegi.coste.pacific <- inegi.edo.coste %>%
    dplyr::filter(id_row %in% rows.coast.pacific)

  #seleccionar comunidades costeras a 30 km de la costa del Atlantico
  #https://gis.stackexchange.com/questions/343222/remove-points-that-are-close-to-a-border-when-building-a-grid

  distance.atlantic <- sf::st_distance(inegi.edo.coste, sf::st_cast(atlantic.shp.proj,"POLYGON")) %>%
    dplyr::as_tibble() %>%
    dplyr::mutate(id_row = 1:nrow(.))

  rows.coast.atlantic <- distance.atlantic %>%
    dplyr::mutate_all(as.numeric) %>%
    dplyr::mutate(min_dist = pmin(V1,V2,V3,V4,V5,V6)) %>%
    dplyr::filter(min_dist<30000) %>%
    dplyr::pull(id_row)

  inegi.coste.atlantic <- inegi.edo.coste %>%
    dplyr::filter(id_row %in% rows.coast.atlantic)


  #unir comunidades atlantico y pacifico en una sola capa
  #inegi.comm.coste <- st_combine(inegi.coste.pacific, inegi.coste.atlantic)


  data.comm.pacific <- inegi.coste.pacific %>%
    sf::st_drop_geometry() %>%
    dplyr::as_tibble()

  data.comm.atlantic <- inegi.coste.atlantic %>%
    sf::st_drop_geometry() %>%
    dplyr::as_tibble()

  data.comm.costas.all <- data.comm.atlantic %>%
    dplyr::bind_rows(data.comm.pacific) %>%
    dplyr::mutate(dec_lon= (lon_deg + (lon_min / 60) + (lon_sec / 3600))*-1,
           dec_lat=(lat_deg + (lat_min / 60) + (lat_sec / 3600)))


  data.comm.costas <- data.comm.costas.all %>%
    na.omit

  readr::write_csv(data.comm.costas,here::here("outputs","comunidades_costeras_INEGI.csv"))


   estados.shp.proj <- sf::st_transform(estados.shp, crs.proj.utm)

  tland <- tmap::tm_shape(estados.shp.proj) +
    tmap::tm_fill()+
    tmap::tm_borders()

  inegi.cost <- dplyr::bind_rows(inegi.coste.atlantic, inegi.coste.pacific) %>%
    na.omit

  inegi.cost.wgs <- sf::st_transform(inegi.cost, crs.proj.wgs)

  sf::st_write(inegi.cost.wgs, here::here("outputs","shp_files","comunidades_costeras_30km.shp"), append = FALSE)


  return(inegi.cost.wgs)

}
