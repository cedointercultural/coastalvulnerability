#' Add code based on locality, municipality and state codes
#'
#' @param this.tibble
#'
#' @return code.tibble
#' @export
#'
#' @examples
make_code <- function(this.tibble){

  if("CVE_ENT" %in% names(this.tibble)){

  code.tibble <- this.tibble %>%
    dplyr::mutate(cve_loc = as.character(CVE_LOC), cve_mun = as.character(CVE_MUN), cve_ent = as.character(CVE_ENT)) %>%
    dplyr::mutate(CVE_ENT = as.character(CVE_ENT), CVE_MUN = as.character(CVE_MUN), CVE_LOC = as.character(CVE_LOC)) %>%
    dplyr::mutate(no_loc = nchar(CVE_LOC), no_mun = nchar(CVE_MUN), no_ent = nchar(CVE_ENT)) %>%
    dplyr::mutate(CVE_ENT = dplyr::if_else(no_ent==1,paste0("0",cve_ent), cve_ent)) %>%
    dplyr::mutate(CVE_MUN = dplyr::if_else(no_mun==1, paste0(CVE_ENT,"00", cve_mun),
                                         dplyr::if_else(no_mun==2, paste0(CVE_ENT,"0", cve_mun),
                                                        dplyr::if_else(no_mun==3, paste0(CVE_ENT, cve_mun),
                                                                       dplyr::if_else(no_mun==4, paste0("0", cve_mun), cve_mun))))) %>%
    dplyr::mutate() %>%
    dplyr::mutate(CVE_LOC=dplyr::if_else(no_loc==1, paste0(CVE_MUN,"000",cve_loc),
                                         dplyr::if_else(no_loc==2, paste0(CVE_MUN, "00",cve_loc),
                                                        dplyr::if_else(no_loc==3, paste0(CVE_MUN, "0", cve_loc),
                                                                       dplyr::if_else(no_loc==4, paste0(CVE_MUN, cve_loc),
                                                                                      dplyr::if_else(no_loc==8, paste0("0",cve_loc), cve_loc)))))) %>%
    dplyr::select(CVE_ENT, CVE_LOC, CVE_MUN, everything())

  }

  if(!"CVE_ENT" %in% names(this.tibble)){

    edos.codes <- readr::read_csv("/home/atlantis/coastalvulnerability-inputs/processed_data/edos_gcyuc.csv") %>%
      dplyr::mutate(NOM_ENT = toupper(stringi::stri_trans_general(str = NOM_ENT, id = "Latin-ASCII")))

    code.tibble <- this.tibble %>%
      dplyr::rename(NOM_ENT = entidad) %>%
      dplyr::left_join(edos.codes, by = "NOM_ENT") %>%
      dplyr::mutate(CVE_ENT = as.character(CVE_ENT), CVE_MUN = as.character(CVE_MUN), CVE_LOC = as.character(CVE_LOC)) %>%
      dplyr::mutate(cve_loc = as.character(CVE_LOC), cve_mun = as.character(CVE_MUN), cve_ent = as.character(CVE_ENT)) %>%
      dplyr::mutate(no_loc = nchar(CVE_LOC), no_mun = nchar(CVE_MUN), no_ent = nchar(CVE_ENT)) %>%
      dplyr::mutate(CVE_ENT = dplyr::if_else(no_ent==1,paste0("0",cve_ent), cve_ent)) %>%
      dplyr::mutate(CVE_MUN = dplyr::if_else(no_mun==1, paste0(CVE_ENT,"00", cve_mun),
                                             dplyr::if_else(no_mun==2, paste0(CVE_ENT,"0", cve_mun),
                                                            dplyr::if_else(no_mun==3, paste0(CVE_ENT, cve_mun),
                                                                           dplyr::if_else(no_mun==4, paste0("0", cve_mun), cve_mun))))) %>%
      dplyr::mutate() %>%
      dplyr::mutate(CVE_LOC=dplyr::if_else(no_loc==1, paste0(CVE_MUN,"000",cve_loc),
                                           dplyr::if_else(no_loc==2, paste0(CVE_MUN, "00",cve_loc),
                                                          dplyr::if_else(no_loc==3, paste0(CVE_MUN, "0", cve_loc),
                                                                         dplyr::if_else(no_loc==4, paste0(CVE_MUN, cve_loc),
                                                                                        dplyr::if_else(no_loc==8, paste0("0",cve_loc), cve_loc)))))) %>%
      dplyr::select(CVE_ENT, CVE_LOC, CVE_MUN, everything())
  }

  return(code.tibble)
}
