#' Extract permit information
#'
#' @param thispermitfile.no
#' @param permit.files
#' @param inegi.cost.comm
#' @param coast.selecc
#'
#' @return this.permit.inegi
#' @export
#'
#' @description Extract permit with location information to match with catch records
#' @examples
extract_permits <- function(thispermitfile.no, permit.files, inegi.cost.comm, coast.selecc){

  this.permitfile <- permit.files[thispermitfile.no]
print(this.permitfile)

  this.permit.data <- readxl::read_xlsx(this.permitfile)

  names.data <- colnames(this.permit.data)
print(names.data)

  if("CLAVE DE RNP" %in% names.data) {

    this.permit.loc <- this.permit.data %>%
      dplyr::distinct(ENTIDAD,`CLAVE DE RNP`,LOCALIDAD) %>%
      dplyr::rename(NOM_ENT=ENTIDAD,rnp_code =`CLAVE DE RNP`, NOM_LOC =LOCALIDAD) %>%
      dplyr::mutate(NOM_ENT= stringi::stri_trans_general(str = NOM_ENT, id = "Latin-ASCII"), NOM_ENT = toupper(NOM_ENT)) %>%
      dplyr::mutate(NOM_LOC = stringi::stri_trans_general(str = NOM_LOC, id = "Latin-ASCII"), NOM_LOC = toupper(NOM_LOC))

    this.permit.inegi <- this.permit.loc %>%
      dplyr::left_join(inegi.cost.comm, by =c("NOM_ENT","NOM_LOC"), relationship = "many-to-many") %>%
      dplyr::distinct(NOM_ENT, rnp_code, NOM_LOC, ENTIDAD, MUN, LOC, CVE_MUN, CVE_LOC, COM_ID, deci_lat, deci_lon, POBTOT)%>%
      dplyr::filter(NOM_ENT %in% coast.selecc)


  }


  if("RNPA" %in% names.data) {

    this.permit.loc <- this.permit.data %>%
      dplyr::distinct(ESTADO,RNPA,MUNICIPIO,LOCALIDAD) %>%
      dplyr::rename(NOM_ENT=ESTADO, rnp_code =RNPA, NOM_MUN=MUNICIPIO, NOM_LOC =LOCALIDAD) %>%
      dplyr::mutate(NOM_ENT= stringi::stri_trans_general(str = NOM_ENT, id = "Latin-ASCII"), NOM_ENT = toupper(NOM_ENT)) %>%
      dplyr::mutate(NOM_MUN = stringi::stri_trans_general(str = NOM_MUN, id = "Latin-ASCII"), NOM_MUN = toupper(NOM_MUN)) %>%
      dplyr::mutate(NOM_LOC = stringi::stri_trans_general(str = NOM_LOC, id = "Latin-ASCII"), NOM_LOC = toupper(NOM_LOC))

    this.permit.inegi <- this.permit.loc %>%
      dplyr::left_join(inegi.cost.comm, by =c("NOM_ENT","NOM_MUN","NOM_LOC")) %>%
      dplyr::distinct(NOM_ENT, rnp_code, NOM_MUN, NOM_LOC, ENTIDAD, MUN, LOC, CVE_MUN, CVE_LOC, COM_ID, deci_lat, deci_lon, POBTOT) %>%
      dplyr::filter(NOM_ENT %in% coast.selecc)

  }

  if("RNP_TITULAR" %in% names.data) {

    this.permit.loc <- this.permit.data %>%
      dplyr::distinct(ESTADO,RNP_TITULAR,MUNICIPIO,LOCALIDAD) %>%
      dplyr::rename(NOM_ENT=ESTADO, rnp_code = RNP_TITULAR, NOM_MUN=MUNICIPIO, NOM_LOC =LOCALIDAD) %>%
      dplyr::mutate(NOM_ENT= stringi::stri_trans_general(str = NOM_ENT, id = "Latin-ASCII"), NOM_ENT = toupper(NOM_ENT)) %>%
      dplyr::mutate(NOM_MUN = stringi::stri_trans_general(str = NOM_MUN, id = "Latin-ASCII"), NOM_MUN = toupper(NOM_MUN)) %>%
      dplyr::mutate(NOM_LOC = stringi::stri_trans_general(str = NOM_LOC, id = "Latin-ASCII"), NOM_LOC = toupper(NOM_LOC))

    this.permit.inegi <- this.permit.loc %>%
      dplyr::left_join(inegi.cost.comm, by =c("NOM_ENT","NOM_MUN","NOM_LOC")) %>%
      dplyr::distinct(NOM_ENT, rnp_code, NOM_MUN, NOM_LOC, ENTIDAD, MUN, LOC, CVE_MUN, CVE_LOC, COM_ID, deci_lat, deci_lon, POBTOT)%>%
      dplyr::filter(NOM_ENT %in% coast.selecc)

  }

  return(this.permit.inegi)
}

