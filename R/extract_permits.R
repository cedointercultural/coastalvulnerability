#' Extract permit information
#'
#' @param thispermitfile.no number of permit file
#' @param permit.files fishery permits
#' @param inegi.cost.comm coastal communities with inegi data
#' @param coast.selecc selected coastal states
#'
#' @return this.permit.inegi
#' @export
#'
#' @description Extract permit with location information to match with catch records
#' @examples
extract_permits <- function(thispermitfile.no, permit.files, inegi.cost.comm, coast.selecc, locs.pesca){

  this.permitfile <- permit.files[thispermitfile.no]

  print(paste("file", this.permitfile))

  this.permit.data <- readxl::read_xlsx(this.permitfile)

  names.data <- colnames(this.permit.data)
  print(names.data)

  correct.ent <- locs.pesca %>%
    select(-NOM_LOC_REV)

  correct.loc <- locs.pesca %>%
    select(-NOM_ENT_REV) %>%
    keep_when(!is.na(NOM_LOC_REV))

  if("CLAVE DE RNP" %in% names.data) {

    this.permit.data <- this.permit.data %>%
    dplyr::rename(rnp_code =`CLAVE DE RNP`)
  }


  if("RNPA" %in% names.data){
    this.permit.data <- this.permit.data %>%
    dplyr::rename(rnp_code =`RNPA`)
  }

  if("RNP_TITULAR" %in% names.data) {

    this.permit.data <- this.permit.data %>%
      dplyr::rename(rnp_code = RNP_TITULAR)
  }

  if("RNPA ACTIVO" %in% names.data) {

    this.permit.data <- this.permit.data %>%
      dplyr::rename(rnp_code =`RNPA ACTIVO`)

  }

  if("ENTIDAD" %in% names.data){

    this.permit.data <- this.permit.data %>%
      dplyr::rename(NOM_ENT=ENTIDAD)
  }

  if("ESTADO" %in% names.data){

    this.permit.data <- this.permit.data %>%
      dplyr::rename(NOM_ENT=ESTADO)
  }

  if("NOMBRE ESTADO" %in% names.data){

    this.permit.data <- this.permit.data %>%
      dplyr::rename(NOM_ENT=`NOMBRE ESTADO`)
  }

  if("LOCALIDAD" %in% names.data){

    this.permit.data <- this.permit.data %>%
      dplyr::rename(NOM_LOC=LOCALIDAD)
  }


  if("NOMBRE OFICINA" %in% names.data){

    this.permit.data <- this.permit.data %>%
      dplyr::rename(NOM_LOC=`NOMBRE OFICINA`)
  }


  this.permit.loc <- this.permit.data %>%
    dplyr::mutate(NOM_ENT= stringi::stri_trans_general(str = NOM_ENT, id = "Latin-ASCII"), NOM_ENT = toupper(NOM_ENT), NOM_ENT = stringr::str_squish(NOM_ENT)) %>%
    dplyr::mutate(NOM_LOC = stringi::stri_trans_general(str = NOM_LOC, id = "Latin-ASCII"), NOM_LOC = toupper(NOM_LOC), NOM_LOC = stringr::str_squish(NOM_LOC)) %>%
    dplyr::mutate(NOM_LOC=gsub("A'", "N", NOM_LOC))

  this.permit.inegi <- this.permit.loc %>%
    dplyr::left_join(correct.ent, by =c("NOM_LOC","NOM_ENT")) %>%
    mutate(NOM_ENT = dplyr::if_else(!is.na(NOM_ENT_REV), NOM_ENT_REV, NOM_ENT)) %>%
    dplyr::left_join(correct.loc, by =c("NOM_LOC","NOM_ENT")) %>%
    mutate(NOM_LOC = dplyr::if_else(!is.na(NOM_LOC_REV), NOM_LOC_REV, NOM_LOC)) %>%
    dplyr::left_join(inegi.cost.comm, by =c("NOM_ENT","NOM_LOC")) %>%
    dplyr::distinct(NOM_ENT, rnp_code, NOM_MUN, NOM_LOC, CVE_MUN, CVE_LOC, deci_lat, deci_lon, POBTOT)%>%
    dplyr::filter(NOM_ENT %in% coast.selecc)


  return(this.permit.inegi)
}

