#' @title funcion para exposicion
#' @description  Calcula datos de exposicion y produce graficas espaciales, por estado y por municipio
#' @details INPUT: 1) data
#' @details OUTPUT: 1) resultados pca, 2) graficos
#' @author Hem Nalini Morzaria-Luna, hmorzarialuna@gmail.com



extract_raster <- function(thisnum, vars.expo, inegi.cost.buffer.50, cost.data.pob, r.template, crs.proj.wgs){

  data(temprange)
  print(thisnum)
  data.info <- vars.expo[thisnum,]

  data.layer <- data.info %>% dplyr::pull(value)

  print(data.layer)
  data.name <- data.info %>% dplyr::pull(var_nom)
  sc.name <- data.info %>% dplyr::pull(scenario)

  if(grepl("[.]shp$",data.layer)){

    print("shapefile")
    field.name <- data.info %>% dplyr::pull(field)

    data.shp.wgs <- sf::st_read(data.layer)%>%
      sf::st_transform(., 4326)

    if(data.name=="long_term_temperature") {

   data.shp.wgs <- data.shp.wgs %>%
  dplyr::left_join(temprange, by = "TEM_C")

   raster.data <- terra::rasterize(data.shp.wgs, r.template, field = field.name, fun=mean)
    }

    if(data.name=="long_term_precipitation") {

      data.shp.wgs <- data.shp.wgs %>%
        dplyr::left_join(preciprange, by = "PANUAL")

      raster.data <- terra::rasterize(data.shp.wgs, r.template, field = field.name, fun=mean)
    }

    if(data.name=="mangrove_change") {

      data.shp.wgs <- data.shp.wgs %>%
        dplyr::left_join(mangroveclasses, by = "CAMBIOS") %>%
        keep_when(!is.na(CAMBIOS))

      raster.data <- terra::rasterize(data.shp.wgs, r.template, field = field.name, fun=mean)
    }

# raster.data <- rasterize(data.shp.wgs, r.template, field = this.field, fun=mean)

    if(data.name=="red_tides"){

      data.spd <- as(data.shp.wgs,"Spatial")

      # Create an empty grid where n is the total number of cells
      grd              <- as.data.frame(sp::spsample(data.spd, "regular", n=(2182 * 3799)))
      names(grd)       <- c("X", "Y")
      sp::coordinates(grd) <- c("X", "Y")
      sp::gridded(grd)     <- TRUE  # Create SpatialPixel object
      sp::fullgrid(grd)    <- TRUE  # Create SpatialGrid object

      # Add data.spd projection information to the empty grid
      sp::proj4string(data.spd) <- crs.proj.wgs
      sp::proj4string(grd) <- crs.proj.wgs

      # Interpolate the grid cells using a power value of 2 (idp=2.0)
      P.idw <- gstat::idw(DENSIDAD ~ 1, data.spd, newdata=grd, idp=2.0)

      # Convert to raster object
      raster.data <- terra::rast(P.idw)
      #https://mgimond.github.io/Spatial/interpolation-in-r.html#idw
      }

  } else if (grepl("[.]tif$",data.layer)){

    raster.data <- terra::rast(data.layer)

    if(grepl("Lambert", terra::crs(raster.data))){

     raster.data  <- terra::project(raster.data, "EPSG:4326")

    }


  }


    buffer.com <- exactextractr::exact_extract(raster.data, inegi.cost.buffer.50, 'mean') %>%
      tidyr::as_tibble()


    if("mean.var1.pred" %in% names(buffer.com))
    {

      names(buffer.com) <- c("value","value.var")
    }


    buffer.data <- buffer.com %>%
      dplyr::bind_cols(cost.data.pob) %>%

      mutate(variable = data.name,
             scenario = sc.name,
             index_var = 1:nrow(.))  %>%
      mutate(value=dplyr::if_else(is.nan(value),0,value)) %>%
      mutate(value=dplyr::if_else(is.na(value),0,value)) %>%
      select(CVE_MUN, CVE_LOC, value,variable,scenario)

  #print(buffer.data %>% pull(value) %>% is.na(.) %>% any())
  #print(buffer.data %>% pull(value) %>% is.nan(.) %>% any())

  readr::write_csv(buffer.data,paste0(input.dir,"/processed_data/exposure/",paste(data.name,"rasterdata.csv",sep="_")))
}
