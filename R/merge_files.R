#' Merge indicator files
#'
#' @param indicator.list
#' @param cost.data.pob
#'
#' @return ind.pob.sc
#' @export
#'
#' @examples
merge_files <- function(indicator.list, cost.data.pob, indicator.name){

   if(indicator.name=="sensitivity"){

    this.data <- readr::read_csv(indicator.list[1])
    this.ind.num <- 2:length(indicator.list)

    comm.cost <- cost.data.pob %>%
      dplyr::left_join(this.data, by = c("CVE_LOC","CVE_MUN"))

    cost.data.pob.ind <- comm.cost

    for(eachfile in this.ind.num){

      print(eachfile)
      this.new.data <- readr::read_csv(indicator.list[eachfile])
      print(indicator.list[eachfile])

      if("POBTOT" %in% colnames(this.new.data)){

        cost.data.pob.ind <- cost.data.pob.ind %>%
          dplyr::left_join(this.new.data, by = c("CVE_LOC","CVE_MUN","POBTOT"))

      } else {

        cost.data.pob.ind <- cost.data.pob.ind %>%
          dplyr::left_join(this.new.data, by = c("CVE_LOC","CVE_MUN"))

      }

    }


    var <- dplyr::sym(paste0("tot_",indicator.name))

    max.col <- ncol(cost.data.pob.ind)

    cost.data.vals <- cost.data.pob.ind %>%
      replace(is.na(.), 0) %>%
      mutate(!!var := rowSums(dplyr::across(10:max.col), na.rm=TRUE)) %>%
      keep_when(!!var>0)

    cost.data.index <- cost.data.vals %>%
      dplyr::select(CVE_ENT:deci_lat)

    cost.data.ind <- cost.data.vals %>%
      select(CVE_MUN, CVE_LOC, 10:(max.col+1))

    readr::write_csv(cost.data.index, here::here("data-raw", paste0(indicator.name,"_coastal_comm.csv")))

    print(colnames(cost.data.ind))
    readr::write_csv(cost.data.ind, here::here("data-raw", paste0(var,".csv")))

  }

  if(indicator.name=="adaptive capacity"){

    comm.cost <- readr::read_csv(here::here("data-raw","sensitivity_coastal_comm.csv"))

    loc.codes.cost <- comm.cost %>%
      dplyr::pull(CVE_LOC)

    this.data <- readr::read_csv(indicator.list[1]) %>%
      keep_when(CVE_LOC %in% loc.codes.cost)

    this.ind.num <- 2:length(indicator.list)


    for(eachfile in this.ind.num){

      print(eachfile)
      this.new.data <- readr::read_csv(indicator.list[eachfile]) %>%
      keep_when(CVE_LOC %in% loc.codes.cost)

      print(indicator.list[eachfile])

      this.data <- this.data %>%
        dplyr::left_join(this.new.data, by = c("CVE_LOC","CVE_MUN"))

      }

    var <- dplyr::sym(paste0("tot_",indicator.name))

    print(colnames(this.data))

  readr::write_csv(this.data, here::here("data-raw", paste0(var,".csv")))

  }




  if(indicator.name=="exposure"){

    this.ind.num <- 1:length(indicator.list)

    comm.cost <- readr::read_csv(here::here("data-raw","sensitivity_coastal_comm.csv"))

    loc.codes.cost <- comm.cost %>%
      dplyr::pull(CVE_LOC)

    ind.list <- list()

    for(eachfile in this.ind.num){

      this.data <- readr::read_csv(indicator.list[eachfile])

      new.data <- this.data %>%
        keep_when(CVE_LOC %in% loc.codes.cost)

      ind.list[[eachfile]] <- new.data

    }


    ind.data.set <- ind.list %>%
      dplyr::bind_rows()

    sc.list <- c("historical","ssp126","ssp585")

    base.vals <- ind.data.set %>%
      keep_when(scenario == "base") %>%
      select(-scenario) %>%
      tidyr::pivot_wider(names_from = variable, values_from = value)


    for(eachscenario in sc.list){

      print(eachscenario)

      cost.data.vals <- ind.data.set %>%
        keep_when(scenario == eachscenario) %>%
        select(-scenario) %>%
        tidyr::pivot_wider(names_from = variable, values_from = value) %>%
        dplyr::left_join(base.vals, by = c("CVE_MUN","CVE_LOC"))

      var <- dplyr::sym(paste("tot",indicator.name, eachscenario, sep="_"))

      print(colnames(cost.data.vals))

      readr::write_csv(cost.data.vals, here::here("data-raw",paste0(var,".csv")))

    }


    #used to check for duplicate pairs
#    expo.vals.comms %>%
#    dplyr::summarise(n = dplyr::n(), .by = c(CVE_LOC, variable))  %>%
#      dplyr::filter(n > 1L)
    }
  }

  #specify dynamic variable
  #  https://stackoverflow.com/questions/53823024/filtering-tables-with-a-character-variable-as-a-column-name-in-dplyr-r/53823143
  # https://stackoverflow.com/questions/26003574/use-dynamic-name-for-new-column-variable-in-dplyr
  #can also use
  #   mutate("tot_{indicator.name}" := rowSums(dplyr::across(1:ncol(scaled.cols)), na.rm=TRUE))


# var <- dplyr::sym(this.varname)

# cost.data.pob.ind <- this.data %>%
#   keep_when(CVE_LOC %in% loc.codes.cost) %>%
#   dplyr::mutate(!!var := value) %>%
#   select({var},scenario)


