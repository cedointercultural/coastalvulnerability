#' Calculate vulnerability
#'
#' @param indicator.name.sens
#' @param indicator.name.exp
#' @param indicator.name.adap
#' @param cost.data.comms
#' @param file.ind
#'
#' @return
#' @export
#'
#' @examples calc_vul(indicator.name.sens="sensitivity", indicator.name.exp= "exposure_historical", indicator.name.adap= "adaptive_capacity", cost.data.comms, file.ind = "historical")
calc_vul <- function(indicator.name.sens, indicator.name.exp, indicator.name.adap, cost.data.comms, file.ind){

  sens.data <- readr::read_csv(here::here("outputs","analysis",paste0("comp_score_", indicator.name.sens,".csv")))
  exp.data <- readr::read_csv(here::here("outputs","analysis",paste0("comp_score_", indicator.name.exp,".csv")))
  adap.data <- readr::read_csv(here::here("outputs","analysis",paste0("comp_score_", indicator.name.adap,".csv")))

  mun.codes <- unique(sens.data$CVE_MUN)

  list.topsis <- list()

  for(eachmun in 1:length(mun.codes)){

    this.mun <- mun.codes[eachmun]
print(eachmun)
print(this.mun)

    index.data <- sens.data %>%
      keep_when(CVE_MUN==this.mun) %>%
      select(CVE_MUN, CVE_LOC)

    sens.thismun <- sens.data %>%
      keep_when(CVE_MUN==this.mun) %>%
      select(tot_score_sc) %>%
      dplyr::rename(sens_tot_score = tot_score_sc)

    exp.thismun <- exp.data %>%
      keep_when(CVE_MUN==this.mun) %>%
      select(tot_score_sc) %>%
      dplyr::rename(exp_tot_score = tot_score_sc)

    adap.thismun <- adap.data %>%
      keep_when(CVE_MUN==this.mun) %>%
      select(tot_score_sc) %>%
      dplyr::rename(adap_tot_score = tot_score_sc)

    #calculate vulnerability as (sensitivity+exposure)-adaptive capacity

      topsis.res.sc <- dplyr::bind_cols(sens.thismun, exp.thismun, adap.thismun) %>%
          mutate(vul_score = (sens_tot_score + exp_tot_score)-adap_tot_score) %>%
        dplyr::bind_cols(index.data)

     print(range(topsis.res.sc$vul_score))


    list.topsis[[eachmun]] <- topsis.res.sc

  } #close looping over municipalities

  topsis.mun <- list.topsis %>%
    dplyr::bind_rows() %>%
    dplyr::left_join(cost.data.comms, by = c("CVE_MUN", "CVE_LOC"))


    readr::write_csv(topsis.mun, here::here("outputs","analysis",paste0(file.ind,"_sum_vul_results.csv")))

    return(topsis.mun)


  } #close function

  #d <- matrix(rpois(12, 5), nrow = 4)
 # w <- c(1, 1, 2)
 # i <- c("+", "-", "+")
#  topsis(d, w, i)


