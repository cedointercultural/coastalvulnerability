#' Scale variable
#'
#' @param datatable
#' @param sspscenario
#'
#' @return num.scale data with scaled total
#' @export
#'
#' @examples scaled.exp <- scale_var(this.data)
scale_var_munold <- function(this.data, indicator.name){

#  var <- dplyr::sym(paste0("tot_", indicator.name))

#extract municipalities with more than 4 locations

  mun.summary <- this.data %>%
    select(CVE_MUN, CVE_LOC) %>%
    mutate(index_no = 1) %>%
    group_by(CVE_MUN) %>%
    summarise(tot_locs = sum(index_no))

  mun.nom <- mun.summary %>%
    keep_when(tot_locs > 2) %>%
    distinct(CVE_MUN) %>%
    dplyr::pull(CVE_MUN)

  mun.loc.data <- this.data %>%
    keep_when(CVE_MUN %in% mun.nom)

  max.col <- ncol(mun.loc.data)

  list.mun <- list()


   for(eachmun in 1:length(mun.nom)){

    this.mun.code <-mun.nom[eachmun]

    this.mun.loc.data <- mun.loc.data %>%
    keep_when(CVE_MUN == this.mun.code)

    this.mun.loc.index <- this.mun.loc.data %>%
      select(CVE_MUN, CVE_LOC)

    list.cols <- list()

    #skips code columns CVE_LOC & CVE_MUN
      for(eachcol in 1:ncol(this.mun.loc.data)){

        print(eachcol)
        this.col <- this.mun.loc.data[,eachcol]

        scaled.this.col <- this.col %>%
          dplyr::mutate_if(is.numeric,~ scales::rescale(., to = c(0, 1)))

        this.col.nom <- colnames(scaled.this.col)

        if(!this.col.nom %in% c("CVE_MUN","CVE_LOC")){

          this.direction <- id.cols %>%
            keep_when(indicator == this.col.nom) %>%
            .$direction

          if(this.direction=="higher_positive"){

            scaled.this.col <- 1-scaled.this.col
          }


        }

        #scaling using caret package
        #process.num <- caret::preProcess(this.col, method=c("range"))
        #scaled.this.col <- stats::predict(process.num, this.col)

        list.cols[[eachcol]] <- scaled.this.col

      }

    scaled.cols <- list.cols %>%
      dplyr::bind_cols()

    list.mun[[eachmun]] <-scaled.cols

  }

scaled.mun.vals <- list.mun %>%
  dplyr::bind_rows()

scaled.vals <-  this.data %>%
  keep_when(!CVE_MUN %in% mun.nom) %>%
  dplyr::bind_rows(scaled.mun.vals)

  return(scaled.vals)
}
