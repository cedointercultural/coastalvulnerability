#' Calculate vulnerability
#'
#' @param indicator.name.sens
#' @param indicator.name.exp
#' @param indicator.name.adap
#' @param cost.data.comms
#' @param file.ind
#'
#' @return
#' @export
#'
#' @examples calc_topsis(indicator.name.sens="sensitivity", indicator.name.exp= "exposure_historical", indicator.name.adap= "adaptive_capacity", cost.data.comms, file.ind = "historical")
calc_topsis <- function(indicator.name.sens, indicator.name.exp, indicator.name.adap, cost.data.comms, file.ind){

  sens.data <- readr::read_csv(here::here("outputs","analysis",paste0("comp_score_", indicator.name.sens,".csv")))
  exp.data <- readr::read_csv(here::here("outputs","analysis",paste0("comp_score_", indicator.name.exp,".csv")))
  adap.data <- readr::read_csv(here::here("outputs","analysis",paste0("comp_score_", indicator.name.adap,".csv")))

  mun.codes <- unique(sens.data$CVE_MUN)

  list.topsis <- list()

  for(eachmun in 1:length(mun.codes)){

    this.mun <- mun.codes[eachmun]
print(eachmun)
print(this.mun)

    index.data <- sens.data %>%
      keep_when(CVE_MUN==this.mun) %>%
      select(CVE_MUN, CVE_LOC)

    sens.thismun <- sens.data %>%
      keep_when(CVE_MUN==this.mun) %>%
      select(-(CVE_MUN:component), -tot_score, -tot_score_sc)

    exp.thismun <- exp.data %>%
      keep_when(CVE_MUN==this.mun) %>%
      select(-(CVE_MUN:component), -tot_score, -tot_score_sc)

    adap.thismun <- adap.data %>%
      keep_when(CVE_MUN==this.mun) %>%
      select(-(CVE_MUN:component), -tot_score, -tot_score_sc)

    #calculate topsis
    risk.matrix <- dplyr::bind_cols(sens.thismun, exp.thismun, adap.thismun) %>%
      as.matrix()


    if(nrow(risk.matrix)>2){

      topsis.w <- rep(1,(ncol(sens.thismun)+ncol(exp.thismun)+ncol(adap.thismun))) #
      topsis.i <- c(rep("-", ncol(sens.thismun)), rep("-", ncol(exp.thismun)), rep("+",ncol(adap.thismun)))
      topsis.res <- topsis::topsis(risk.matrix, topsis.w, topsis.i)

      topsis.res.sc <- topsis.res %>%
        select(score) %>%
        dplyr::rename(tot_vulscore = score) %>%
        dplyr::mutate_if(is.numeric,~ scales::rescale(., to = c(0, 1))) %>%
        dplyr::bind_cols(index.data,.)


    } else if(nrow(risk.matrix)<3){

      topsis.res.sc <- risk.matrix %>%
        tidyr::as_tibble() %>%
        mutate(tot_vulscore = rowMeans(dplyr::across(1:ncol(risk.matrix)), na.rm=TRUE)) %>%
        select(tot_vulscore) %>%
        dplyr::bind_cols(index.data,.)

    }

    print(range(topsis.res.sc$tot_vulscore))


    list.topsis[[eachmun]] <- topsis.res.sc

  } #close looping over municipalities

  topsis.mun <- list.topsis %>%
    dplyr::bind_rows() %>%
    dplyr::left_join(cost.data.comms, by = c("CVE_MUN", "CVE_LOC"))


    readr::write_csv(topsis.mun, here::here("outputs","analysis",paste0(file.ind,"_topsis_vul_results.csv")))

    return(topsis.mun)


  } #close function

  #d <- matrix(rpois(12, 5), nrow = 4)
 # w <- c(1, 1, 2)
 # i <- c("+", "-", "+")
#  topsis(d, w, i)


