
#' Extract denue data for coastal communities
#'
#' @param eachdenue
#' @param denue.inegi
#' @param denue.inegi.full
#' @param input.dir
#' @param inegi.comm.codes
#'
#' @return
#' @export
#'
#' @examples
extract_denue <- function(eachdenue, denue.inegi,denue.inegi.full, input.dir, inegi.comm.codes){

  thispattern <- denue.inegi[eachdenue] %>%
    stringr::str_split("denue_inegi") %>%
    unlist() %>%
    .[2] %>%
    stringr::str_replace(".csv","")

  this.activity <- unidades.denue %>%
    dplyr::filter(stringr::str_detect(link,thispattern)) %>%
    dplyr::pull(economic_activity)

  print(this.activity)
  print(thispattern)

  this.denue <- denue.inegi.full[eachdenue] %>%
    data.table::fread(encoding = "Latin-1") %>%
    dplyr::as_tibble() %>%
    dplyr::rename(ENTIDAD=cve_ent, MUN=cve_mun, LOC=cve_loc) %>%
    dplyr::mutate(index_no=1, index = 1:nrow(.)) %>%
    dplyr::mutate(actividad = this.activity) %>%
    dplyr::mutate(COM_ID = paste0(ENTIDAD,"_",MUN, "_",LOC))

  this.denue.code <- make_code(this.denue)

  if(thispattern=="_11_"){

    fish.act <- c("Piscicultura y otra acuicultura, excepto camaronicultura","Pesca y captura de peces, crustáceos, moluscos y otras especies",
                  "Camaronicultura","Pesca de sardina y anchoveta","Pesca de camarón","Pesca de túnidos")

    # Otros servicios relacionados con la agricultura
    # 2 Piscicultura y otra acuicultura, excepto camaronicultura
    # 3 Beneficio de productos agrícolas
    # 4 Pesca y captura de peces, crustáceos, moluscos y otras especies
    # 5 Servicios relacionados con la cría y explotación de animales
    # 6 Servicios de fumigación agrícola
    # 7 Camaronicultura
    # 8 Pesca de sardina y anchoveta
    # 9 Pesca de camarón
    # 10 Despepite de algodón
    # 11 Pesca de túnidos
    # 12 Servicios relacionados con el aprovechamiento forestal

    this.denue.activity <- this.denue.code %>%
      dplyr::filter(CVE_LOC %in% inegi.comm.codes) %>%
      dplyr::filter(nombre_act %in% fish.act) %>%
      dplyr::group_by(CVE_LOC, actividad, COM_ID) %>%
      dplyr::summarise(neg_tot = sum(index_no))

    readr::write_csv(this.denue.activity, paste0(input.dir,"/denue/denue_fisheries_coms_cost.csv"))

    this.denue.activity <- this.denue.code %>%
      dplyr::filter(CVE_LOC %in% inegi.comm.codes) %>%
      dplyr::filter(!nombre_act %in% fish.act) %>%
      dplyr::group_by(CVE_LOC, actividad, COM_ID) %>%
      dplyr::summarise(neg_tot = sum(index_no))


  }

  this.denue.activity <- this.denue.code %>%
    dplyr::filter(CVE_LOC %in% inegi.comm.codes) %>%
    dplyr::filter(!nombre_act %in% fish.act) %>%
    dplyr::group_by(CVE_LOC, actividad, COM_ID) %>%
    dplyr::summarise(neg_tot = sum(index_no))

  readr::write_csv(this.denue.activity, paste0(input.dir,"/denue/denue",thispattern,"coms_cost.csv"))

}
