#' Merge indicator files
#'
#' @param indicator.list
#' @param cost.data.pob
#'
#' @return ind.pob.sc
#' @export
#'
#' @examples
select_files <- function(this.ind.num, indicator.list, cost.data.pob, indicator.name){

  this.data <- readr::read_csv(indicator.list[this.ind.num])

  if(indicator.name=="adaptive capacity"){

    comm.cost <- cost.data.pob %>%
      dplyr::left_join(this.data, by = c("CVE_LOC","CVE_MUN"))

    cost.data.pob.ind <- comm.cost

    for(eachfile in 2:length(indicator.list)){

      print(eachfile)
      this.new.data <- readr::read_csv(indicator.list[eachfile])
      print(indicator.list[eachfile])

      if("CVE_ENT" %in% colnames(this.new.data)){

        cost.data.pob.ind <- cost.data.pob.ind %>%
          dplyr::left_join(this.new.data, by = c("CVE_ENT","CVE_MUN","CVE_LOC"))


      } else {

        cost.data.pob.ind <- cost.data.pob.ind %>%
        dplyr::left_join(this.new.data, by = c("CVE_LOC","CVE_MUN"))

      }

    }

    var <- dplyr::sym(paste0("tot_",indicator.name))

    max.col <- ncol(cost.data.pob.ind)

    cost.data.vals <- cost.data.pob.ind %>%
      replace(is.na(.), 0) %>%
      mutate(!!var := rowSums(dplyr::across(10:max.col), na.rm=TRUE)) %>%
      keep_when(!!var>0)

  readr::write_csv(cost.data.vals, here::here("data-raw", paste0(var,".csv")))

  }

  if(indicator.name=="sensitivity"){

    comm.cost <- cost.data.pob %>%
     dplyr::left_join(this.data, by = c("CVE_LOC","CVE_MUN"))

   cost.data.pob.ind <- comm.cost

  for(eachfile in 2:length(indicator.list)){

    print(eachfile)
    this.new.data <- readr::read_csv(indicator.list[eachfile])
    print(indicator.list[eachfile])

    if("POBTOT" %in% colnames(this.new.data)){

      cost.data.pob.ind <- cost.data.pob.ind %>%
        dplyr::left_join(this.new.data, by = c("CVE_LOC","CVE_MUN","POBTOT"))


    } else {

      cost.data.pob.ind <- cost.data.pob.ind %>%
        dplyr::left_join(this.new.data, by = c("CVE_LOC","CVE_MUN"))

        }

  }


    var <- dplyr::sym(paste0("tot_",indicator.name))

    max.col <- ncol(cost.data.pob.ind)

    cost.data.vals <- cost.data.pob.ind %>%
      replace(is.na(.), 0) %>%
      mutate(!!var := rowSums(dplyr::across(10:max.col), na.rm=TRUE)) %>%
      keep_when(!!var>0)

    cost.data.index <- cost.data.vals %>%
      dplyr::select(CVE_ENT:deci_lat)

    readr::write_csv(cost.data.index, here::here("data-raw", paste0(indicator.name,"_coastal_comm.csv")))

    readr::write_csv(cost.data.vals, here::here("data-raw", paste0(var,".csv")))

  }


  if(indicator.name=="exposure"){

    comm.cost <- readr::read_csv(here::here("data-raw","sensitivity_coastal_comm.csv"))

    loc.codes.cost <- comm.cost %>%
      dplyr::pull(CVE_LOC)

    exp.list <- list()

    for(eachfile in 1:length(indicator.list)){

      this.data <- readr::read_csv(indicator.list[eachfile])

      new.data <- this.data %>%
        keep_when(CVE_LOC %in% loc.codes.cost)

      exp.list[[eachfile]] <- new.data

    }

    exp.data.set <- exp.list %>%
      dplyr::bind_rows()

    sc.list <- exp.data.set %>%
      distinct(scenario) %>%
      dplyr::pull(scenario)

    for(eachscenario in sc.list){

      expo.vals.comms <- exp.data.set %>%
        keep_when(scenario == eachscenario) %>%
        select(-scenario) %>%
        tidyr::pivot_wider(names_from = variable, values_from = value) %>%
        dplyr::left_join(comm.cost, by = c("CVE_MUN","CVE_LOC"))

      var <- dplyr::sym(paste("tot",indicator.name, eachscenario, sep="_"))

      readr::write_csv(expo.vals.comms, here::here("data-raw",paste0(var,".csv")))

    }


    #used to check for duplicate pairs
#    expo.vals.comms %>%
#    dplyr::summarise(n = dplyr::n(), .by = c(CVE_LOC, variable))  %>%
#      dplyr::filter(n > 1L)
    }

  }

  #specify dynamic variable
  #  https://stackoverflow.com/questions/53823024/filtering-tables-with-a-character-variable-as-a-column-name-in-dplyr-r/53823143
  # https://stackoverflow.com/questions/26003574/use-dynamic-name-for-new-column-variable-in-dplyr
  #can also use
  #   mutate("tot_{indicator.name}" := rowSums(dplyr::across(1:ncol(scaled.cols)), na.rm=TRUE))


# var <- dplyr::sym(this.varname)

# cost.data.pob.ind <- this.data %>%
#   keep_when(CVE_LOC %in% loc.codes.cost) %>%
#   dplyr::mutate(!!var := value) %>%
#   select({var},scenario)


