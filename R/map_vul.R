#' Title
#'
#' @param this.data
#' @param crs.proj.wgs
#' @param crs.proj.utm
#' @param plot.title
#' @param scenario.nom
#' @param mun.cost
#'
#' @return
#' @export
#'
#' @examples
map_vul <- function(this.data, crs.proj.wgs, crs.proj.utm, plot.title="DistribuciÃ³n espacial de la vulnerabilidad actual", scenario.nom = "historical", mun.cost){

  susc.coords <- this.data
  sp::coordinates(susc.coords) <- c("deci_lon","deci_lat")

  #definir proyeccion geografica y proyectar a utm
  sp::proj4string(susc.coords) <- crs.proj.wgs
  susc.coords.sf <- sf::st_as_sf(susc.coords)
  susc.coords.proj <- sf::st_transform(susc.coords.sf, crs.proj.utm) %>%
    mutate(NOM_ENT_fac=factor(NOM_ENT, levels=ent.ord))

  world <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")
  class(world)

  #mapa por paneles

  mapa.susc1 <- ggplot2::ggplot(data = world) +
    ggplot2::geom_sf(data = mun.cost) +
    ggplot2::geom_sf(data = susc.coords.proj, ggplot2::aes(color = vul_score), size= 2, shape = 16, alpha = 0.75) +
    ggplot2::scale_colour_steps(low="#65B741", high = "#E72929", breaks = c(-1,-0.5, 0, 0.5, 1, 1.5)) +
    # geom_sf(data = est.2019, fill= NA) +
    #-117.4,30.43,-111.02,32.93
    ggplot2::coord_sf(xlim = c(-117.4, -111.02), ylim = c(30.43, 32.93), expand = FALSE) +
    ggplot2::theme(panel.grid.major = ggplot2::element_line(color = gray(0.4), linetype = "dashed", size = 0.1)) +
    ggplot2::theme_light() +
    ggplot2::theme(legend.position = "none") +
    ggplot2::labs(x = "",
                  y="Lat")


  mapa.susc2 <- ggplot2::ggplot(data = world) +
    ggplot2::geom_sf(data = mun.cost) +
    ggplot2::geom_sf(data = susc.coords.proj, ggplot2::aes(color = vul_score), size= 2, shape = 16, alpha = 0.75) +
    ggplot2::scale_colour_steps(low="#65B741", high = "#E72929", breaks = c(-1,-0.5, 0, 0.5, 1, 1.5)) +
    #-116.29,26.88,-108.2,30.45
    ggplot2::coord_sf(xlim = c(-116.29, -108.2), ylim = c(26.88, 30.45), expand = FALSE) +
    ggplot2::theme(panel.grid.major = ggplot2::element_line(color = gray(0.4), linetype = "dashed", size = 0.1)) +
    ggplot2::theme_light() +
    ggplot2::theme(legend.position = "none")

  mapa.susc3 <- ggplot2::ggplot(data = world) +
    ggplot2::geom_sf(data = mun.cost) +
    ggplot2::geom_sf(data = susc.coords.proj, ggplot2::aes(color = vul_score), size= 2, shape = 16, alpha = 0.75) +
    ggplot2::scale_colour_steps(low="#65B741", high = "#E72929", breaks = c(-1,-0.5, 0, 0.5, 1, 1.5)) +
    #-112.84,23.19,-104.97,26.88
    ggplot2::coord_sf(xlim = c(-112.84, -104.97), ylim = c(23.19, 26.88), expand = FALSE) +
    ggplot2::theme(panel.grid.major = ggplot2::element_line(color = gray(0.4), linetype = "dashed", size = 0.1)) +
    ggplot2::theme_light() +
    ggplot2::labs(x ="Lon",
                  y="Lat") +
    ggplot2::theme(legend.position = "none")


  mapa.susc4 <- ggplot2::ggplot(data = world) +
    ggplot2::geom_sf(data = mun.cost) +
    ggplot2::geom_sf(data = susc.coords.proj, ggplot2::aes(color = vul_score), size= 2, shape = 16, alpha = 0.75) +
    ggplot2::scale_colour_steps(low="#65B741", high = "#E72929", breaks = c(-1,-0.5, 0, 0.5, 1, 1.5)) +
    #-110.88,19.4,-103.01,23.19
    ggplot2::coord_sf(xlim = c(-110.88, -103.01), ylim = c(19.4, 23.19), expand = FALSE) +
    ggplot2::theme(panel.grid.major = ggplot2::element_line(color = gray(0.4), linetype = "dashed", size = 0.1)) +
    ggplot2::theme_light() +
    ggplot2::labs(x ="Lon",
                  y="",
                  color = "Vulnerabilidad") +
    ggplot2::theme(legend.position = "bottom")

  mapa.susc5 <- ggplot2::ggplot(data = world) +
    ggplot2::geom_sf(data = mun.cost) +
    ggplot2::geom_sf(data = susc.coords.proj, ggplot2::aes(color = vul_score), size= 2, shape = 16, alpha = 0.75) +
    ggplot2::scale_colour_steps(low="#65B741", high = "#E72929", breaks = c(-1,-0.5, 0, 0.5, 1, 1.5)) +
    #-89.38,17.52,-86.26,22.04
    ggplot2::coord_sf(xlim = c(-89.38, -86.26), ylim = c(17.52, 22.04), expand = FALSE) +
    ggplot2::theme(panel.grid.major = ggplot2::element_line(color = gray(0.4), linetype = "dashed", size = 0.1)) +
    ggplot2::theme_light() +
    ggplot2::labs(x ="",
                  y="Lat") +
    ggplot2::theme(legend.position = "none")


  mapa.susc6 <- ggplot2::ggplot(data = world) +
    ggplot2::geom_sf(data = mun.cost) +
    ggplot2::geom_sf(data = susc.coords.proj, ggplot2::aes(color = vul_score), size= 2, shape = 16, alpha = 0.75) +
    ggplot2::scale_colour_steps(low="#65B741", high = "#E72929", breaks = c(-1,-0.5, 0, 0.5, 1, 1.5)) +
    #-92.82,17.19,-89.38,21.66
    ggplot2::coord_sf(xlim = c(-92.82, -89.38), ylim = c(17.19, 21.66), expand = FALSE) +
    ggplot2::theme(panel.grid.major = ggplot2::element_line(color = gray(0.4), linetype = "dashed", size = 0.1)) +
    ggplot2::theme_light() +
    ggplot2::labs(x = "Lon",
                  y="Lat",
                  color = "Vulnerabilidad") +
    ggplot2::theme(legend.position = "bottom")
  #    ggplot2::labs(color = escenario.nom)

  mapa.susc.panel.1 <- mapa.susc1 + mapa.susc2 + mapa.susc3 + mapa.susc4 + patchwork::guide_area() +
    patchwork::plot_layout(guides = 'collect', ncol = 2, widths = c(2,2))+
    patchwork::plot_annotation(title=plot.title)

  ggplot2::ggsave(here::here("outputs","figures",tolower(paste0(scenario.nom,"_panel_mapa_gc.png"))), mapa.susc.panel.1, device="png", width = 7.7, height = 6)

  mapa.susc.panel.2 <- mapa.susc5 + mapa.susc6 + patchwork::guide_area() +
    patchwork::plot_layout(guides = 'collect', ncol = 2)+
    patchwork::plot_annotation(title=plot.title)


  ggplot2::ggsave(here::here("outputs","figures",tolower(paste0(scenario.nom,"_panel_mapa_yp.png"))), mapa.susc.panel.2, device="png", width = 10, height = 12)

}
