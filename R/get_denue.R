
denue.links= "links_DENUE_descarga_masiva_2023.csv"

get_denue <- function(denue.links){

  unidades.denue <- readr::read_csv(here::here("inputs",denue.links))

  links.denue <- unidades.denue %>%
    dplyr::pull(link)

  for(eachlink in links.denue){

    this.file <- str_split(eachlink,"\\/") %>%
      unlist %>%
      .[7]

    print(this.file)
    system(paste("wget",eachlink, "-P "), wait = TRUE )


  }



}


zip.files <- list.files(path="/home/atlantis/vulnerabilidadbid/", pattern="*.zip")

for(this.zip in zip.files){

  unlink("/home/atlantis/vulnerabilidadbid/conjunto_de_datos", recursive=TRUE)
  unlink("/home/atlantis/vulnerabilidadbid/diccionario_de_datos", recursive=TRUE)
  unlink("/home/atlantis/vulnerabilidadbid/metadatos", recursive=TRUE)

  system(paste0("unzip ","/home/atlantis/vulnerabilidadbid/",this.zip), wait = TRUE)

  this.csv <- list.files(path="/home/atlantis/vulnerabilidadbid/conjunto_de_datos",pattern="csv")

  file.rename(from=paste0("/home/atlantis/vulnerabilidadbid/conjunto_de_datos/",this.csv),to=paste0("/home/atlantis/vulnerabilidadbid/inputs/sensitivity/denue/",this.csv))

  unlink("/home/atlantis/vulnerabilidadbid/conjunto_de_datos", recursive=TRUE)
  unlink("/home/atlantis/vulnerabilidadbid/diccionario_de_datos", recursive=TRUE)
  unlink("/home/atlantis/vulnerabilidadbid/metadatos", recursive=TRUE)


}

denue.inegi <- list.files(path="/home/atlantis/vulnerabilidadbid/inputs/sensitivity/denue/", pattern="denue_inegi")

get_denue  <- function(thisfile) {


  thispattern <- thisfile %>%
    str_split("denue_inegi") %>%
    unlist() %>%
    .[2] %>%
    str_replace(".csv","")

  this.activity <- unidades.denue %>%
    filter(str_detect(Link,thispattern)) %>%
    pull(`Actividad econ√≥mica`)

  print(this.activity)
  print(thispattern)

  this.denue <- fread(here("inputs","sensitivity","denue",thisfile), encoding = "Latin-1") %>%
    as_tibble() %>%
    dplyr::select(cve_ent, cve_mun, cve_loc) %>%
    mutate(index_no=1, index = 1:nrow(.)) %>%
    mutate_if(is.character,as.numeric) %>%
    mutate(COM_ID= paste(`cve_ent`,`cve_mun`,`cve_loc`, sep="_"), actividad = this.activity) %>%
    group_by(COM_ID, actividad) %>%
    summarise(neg_tot = sum(index_no))
}

