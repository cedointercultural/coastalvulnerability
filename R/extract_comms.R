#' Extract target states and municipalities
#'
#' @param this.data
#' @param inegi.cost.comm
#'
#' @return this.data.selec
#' @export
#'
#' @examples
extract_comms <- function(this.data, inegi.cost.comm){


  mun.ent.codes <- readr::read_csv(paste0(input.dir,"/processed_data/","mun_ent_codes.csv"))

  ent.cost <- mun.ent.codes %>%
    dplyr::mutate(entidad=toupper(ent_nam)) %>%
    dplyr::mutate(entidad = stringi::stri_trans_general(str = entidad, id = "Latin-ASCII")) %>%
    dplyr::distinct(entidad) %>%
    dplyr::pull(entidad)

  mun.cost <- mun.ent.codes %>%
    dplyr::mutate(municipio =toupper(mun_nam)) %>%
    dplyr::mutate(municipio = stringi::stri_trans_general(str = municipio, id = "Latin-ASCII")) %>%
    dplyr::distinct(municipio) %>%
    dplyr::pull(municipio)

  mun.codes <- mun.ent.codes %>%
    dplyr::distinct(mun_cve) %>%
    dplyr::pull(mun_cve)

  if("entidad" %in% names(this.data)){

    this.data.selec <- this.data %>%
      dplyr::mutate(NOM_ENT = toupper(entidad)) %>%
      dplyr::mutate(NOM_ENT = stringi::stri_trans_general(str = NOM_ENT, id = "Latin-ASCII")) %>%
      dplyr::mutate(NOM_MUN = toupper(municipio)) %>%
      dplyr::mutate(NOM_MUN = stringi::stri_trans_general(str = NOM_MUN, id = "Latin-ASCII")) %>%
      dplyr::mutate(NOM_LOC = toupper(localidad)) %>%
      dplyr::mutate(NOM_LOC = stringi::stri_trans_general(str = NOM_LOC, id = "Latin-ASCII")) %>%
      dplyr::filter(NOM_ENT %in% ent.cost) %>%
      dplyr::filter(NOM_MUN %in% mun.cost)
  }

  if("ENTIDAD" %in% names(this.data) & !"CVE_LOC" %in% names(this.data) & !"NOM_ENT" %in% names(this.data)){

    this.data.selec <- this.data %>%
      dplyr::mutate(NOM_ENT = toupper(ENTIDAD)) %>%
      dplyr::mutate(NOM_ENT = stringi::stri_trans_general(str = NOM_ENT, id = "Latin-ASCII")) %>%
      dplyr::mutate(NOM_MUN = toupper(MUNICIPIO)) %>%
      dplyr::mutate(NOM_MUN = stringi::stri_trans_general(str = NOM_MUN, id = "Latin-ASCII")) %>%
      dplyr::mutate(NOM_LOC = stringi::stri_trans_general(str = LOCALIDAD, id = "Latin-ASCII")) %>%
      dplyr::filter(NOM_ENT %in% ent.cost) %>%
      dplyr::filter(NOM_MUN %in% mun.cost) %>%
      dplyr::left_join(inegi.cost.comm, by = c("NOM_MUN","NOM_ENT","NOM_LOC"))


  }

  if("ENTIDAD" %in% names(this.data) & "CVE_LOC" %in% names(this.data)){

    this.data.selec <- this.data %>%
      dplyr::mutate(ENTIDAD = toupper(ENTIDAD)) %>%
      dplyr::mutate(ENTIDAD = stringi::stri_trans_general(str = ENTIDAD, id = "Latin-ASCII")) %>%
      dplyr::mutate(MUNICIPIO = toupper(MUNICIPIO)) %>%
      dplyr::mutate(MUNICIPIO = stringi::stri_trans_general(str = MUNICIPIO, id = "Latin-ASCII")) %>%
      dplyr::filter(ENTIDAD %in% ent.cost) %>%
      dplyr::filter(MUNICIPIO %in% mun.cost) %>%
      dplyr::mutate(no_loc = nchar(CVE_LOC), CVE_LOC = as.character(CVE_LOC)) %>%
      dplyr::mutate(CVE_LOC = dplyr::if_else(no_loc==8,paste0("0",CVE_LOC),CVE_LOC))


  }

  if("NOM_ENT" %in% names(this.data) & !"CVE_LOC" %in% names(this.data)){

    this.data.selec <- this.data %>%
      dplyr::mutate(NOM_ENT = toupper(NOM_ENT)) %>%
      dplyr::mutate(NOM_ENT = stringi::stri_trans_general(str = NOM_ENT, id = "Latin-ASCII")) %>%
      dplyr::mutate(NOM_MUN = toupper(NOM_MUN)) %>%
      dplyr::mutate(NOM_MUN = stringi::stri_trans_general(str = NOM_MUN, id = "Latin-ASCII")) %>%
      dplyr::filter(NOM_ENT %in% ent.cost) %>%
      dplyr::filter(NOM_MUN %in% mun.cost) %>%
      dplyr::mutate(NOM_LOC = toupper(NOM_LOC)) %>%
      dplyr::mutate(NOM_LOC = stringi::stri_trans_general(str = NOM_LOC, id = "Latin-ASCII"))



  }
  if("NOMBRE ESTADO" %in% names(this.data)){

    this.data.selec <- this.data %>%
      dplyr::mutate(`NOMBRE ESTADO` = toupper(`NOMBRE ESTADO`)) %>%
      dplyr::mutate(`NOMBRE ESTADO` = stringi::stri_trans_general(str = `NOMBRE ESTADO`, id = "Latin-ASCII")) %>%
      dplyr::mutate(`NOMBRE MUNICIPIO` = toupper(`NOMBRE MUNICIPIO`)) %>%
      dplyr::mutate(`NOMBRE MUNICIPIO` = stringi::stri_trans_general(str = `NOMBRE MUNICIPIO`, id = "Latin-ASCII")) %>%
      dplyr::filter(`NOMBRE ESTADO` %in% ent.cost) %>%
      dplyr::filter(`NOMBRE MUNICIPIO` %in% mun.cost) %>%
      dplyr::mutate(CVE_LOC = as.character(`CLAVE LOCALIDAD`), no_loc = nchar(CVE_LOC)) %>%
      dplyr::mutate(CVE_LOC = dplyr::if_else(no_loc==8,paste0("0",CVE_LOC),CVE_LOC))


  }

  if("CVE_MUN" %in% names(this.data) & !"nom_mun" %in% names(this.data)){

    this.data.selec <- this.data %>%
      dplyr::filter(`CVE_MUN` %in% mun.codes)

  }
  if("nom_ent" %in% names(this.data)){

    this.data.selec <- this.data %>%
      dplyr::mutate(NOM_ENT = toupper(nom_ent)) %>%
      dplyr::mutate(NOM_ENT = stringi::stri_trans_general(str = NOM_ENT, id = "Latin-ASCII")) %>%
      dplyr::mutate(NOM_MUN = toupper(nom_mun)) %>%
      dplyr::mutate(NOM_MUN = stringi::stri_trans_general(str = NOM_MUN, id = "Latin-ASCII")) %>%
      dplyr::mutate(NOM_LOC = toupper(nom_loc)) %>%
      dplyr::mutate(NOM_LOC = stringi::stri_trans_general(str = NOM_LOC, id = "Latin-ASCII")) %>%
      dplyr::filter(NOM_ENT %in% ent.cost) %>%
      dplyr::filter(NOM_MUN %in% mun.cost) %>%
      mutate(across(where(~any(stringr::str_detect(., "^\\d+$"))), as.numeric))
  }

  return(this.data.selec)
}
