---
title: "Coastal vulnerability"

output:
  html_document

knit: (function(input, encoding) {
    rmarkdown::render(
      input = input,
      encoding = encoding,
      envir = globalenv()
    )
  })
---

Identify coastal communities

```{r}
#rebuild and load the package
devtools::load_all() # restarts and loads

```
```{r}
#set data dir
input.dir <- "~/coastalvulnerability-inputs"

```


```{r eval=FALSE, include=FALSE}
sheetlink = "https://docs.google.com/spreadsheets/d/1j9GJKPjKgpf4w3bDeS2c8uamN8-L79I1BINjpQe0lCk/edit#gid=1817952998"
# 
tabla.susc <- read_googlesheet(sheetlink, sheetname = "relacion_datos_procesados_LOC", coltypes = "cccccccccccccccccccc")
tabla.susc <- read_googlesheet(sheetlink, sheetname = "resumen_indicadores_exposicion", coltypes = "cccccccccccccccccccc")


for(i in 1:nrow(tabla.susc)){
  
  this.susc <- tabla.susc[i,]
  
}

```


```{r extract communities}

#coordinates
crs.proj.utm <- "+proj=utm +zone=12 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +datum=NAD83"
crs.proj.wgs <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"

#Gulf of California and Yucatan Peninsula states
ents.selecc <- c("['Baja California Sur']", "['Baja California']", "['Sonora']", "['Sinaloa']", "['Nayarit']", "['Jalisco']", "['Yucatán']", "['Campeche']", "['Quintana Roo']")
ents.coast.selecc <- c("Baja California Sur", "Baja California", "Sonora", "Sinaloa", "Nayarit", "Jalisco", "Yucatán", "Campeche", "Quintana Roo")

#all coastal states
#ents.coast <- c("Baja California Sur", "Baja California", "Sonora", "Sinaloa", "Nayarit", "Jalisco", "Colima", "Michoacán de Ocampo", "Guerrero", "Oaxaca", "Chiapas", "Quintana Roo", "Yucatán", "Campeche", "Tabasco", "Veracruz de Ignacio de la Llave", "Tamaulipas")

#read county (municipio) shape and subset selected states
municipios.selecc <- sf::st_read(paste0(input.dir, "/shp_files/georef-mexico-municipality-millesime.shp")) %>% 
dplyr::filter(sta_name %in% ents.selecc) 

#read atlantic ocean shp
atlantic.shp <- sf::st_read(paste0(input.dir,"/shp_files/atlantic_ocean.shp")) 
#read pacific ocean shp
pacific.shp <- sf::st_read(paste0(input.dir,"/shp_files/pacific_ocean.shp")) 

#read shp Mexico states
est.mex <- sf::st_read(paste0(input.dir,"/datos_INEGI_2020/dest2019gw.shp"))
estados.shp <- sf::st_read(paste0(input.dir,"/shp_files/ESTADOS.shp"))

#2020 Census data 
inegi.2020 <- readr::read_csv(paste0(input.dir,"/datos_INEGI_2020/conjunto_de_datos/conjunto_de_datos_iter_00_cpv2020.csv")) %>% 
  dplyr::filter(LONGITUD!=0) %>% 
  dplyr::filter(NOM_ENT %in% ents.coast.selecc)

#extract and save codes for states
ents.selecc.codes <- estados.shp %>% 
  sf::st_drop_geometry() %>% 
  dplyr::filter(NOM_ENT %in% ents.coast.selecc)

ents.selecc.codes %>% 
readr::write_csv(paste0(input.dir,"/processed_data/edos_gcyuc.csv"))

#estados.mx <- cbind(est.2019, st_coordinates(st_centroid(est.2019)))

#select counties in selected states that are coastal
#pacific 
mun.cost.pac <- municipios.selecc %>% 
   dplyr::mutate(pac_distance=sf::st_distance(., pacific.shp)) %>% 
   dplyr::filter((as.numeric(pac_distance)) < 7000)
#atlantic
mun.cost.atl <- municipios.selecc %>% 
   dplyr::mutate(atl_distance=sf::st_distance(., atlantic.shp)) %>% 
   dplyr::filter((as.numeric(atl_distance)) < 7000)

#join counties from apcific and atlantic
mun.cost <- mun.cost.atl %>% 
  dplyr::bind_rows(mun.cost.pac)

#get codes for states and target municipalities
mun.ent.codes <- mun.cost %>% 
   sf::st_drop_geometry() %>% 
  dplyr::mutate(mun_cve = gsub("\\[","",mun_code), 
         mun_cve = gsub("\\]","",mun_cve),
         mun_cve = gsub("\\'","",mun_cve)) %>% 
  dplyr::mutate(mun_nam = gsub("\\[","",mun_name), 
         mun_nam = gsub("\\]","",mun_nam),
         mun_nam = gsub("\\'","",mun_nam)) %>% 
  dplyr::mutate(ent_nam = gsub("\\[","",sta_name), 
         ent_nam = gsub("\\]","",ent_nam),
         ent_nam = gsub("\\'","",ent_nam)) %>% 
   dplyr::mutate(ent_cve = gsub("\\[","",sta_code), 
         ent_cve = gsub("\\]","",ent_cve),
         ent_cve = gsub("\\'","",ent_cve)) %>% 
  dplyr::select(mun_cve,mun_nam, ent_cve, ent_nam)

mun.ent.codes %>% readr::write_csv(paste0(input.dir,"/processed_data/","mun_ent_codes.csv"))


#get community data, output is spatial data layer
inegi.cost <- get_community_data(inegi.2020, crs.proj.utm, crs.proj.wgs, mun.cost, ents.coast.selecc)

inegi.cost.buffer <-  inegi.cost %>% 
  dplyr::select(id_row:POBTOT) %>% 
  sf::st_buffer(dist=10000)

sf::st_write(inegi.cost.buffer, paste0(input.dir,"/shp_files/","inegi_comm_buffer.shp"), delete_layer = TRUE)

inegi.cost.buffer.50 <-  inegi.cost %>% 
  dplyr::select(id_row:POBTOT) %>% 
  sf::st_buffer(dist=50000)

sf::st_write(inegi.cost.buffer.50, paste0(input.dir,"/shp_files/","inegi_comm_buffer_50k.shp"), delete_layer = TRUE)

inegi.cost.comm <- inegi.cost %>% 
  sf::st_drop_geometry() %>% 
  dplyr::select(CVE_ENT:NOM_LOC, POBTOT, deci_lon, deci_lat) %>% 
  dplyr::distinct(CVE_ENT, CVE_LOC, CVE_MUN, NOM_ENT, NOM_MUN, NOM_LOC, POBTOT, deci_lon, deci_lat)

#get location codes for target locations

inegi.cost.comm %>% readr::write_csv(here::here("outputs","inegi_coast_comm.csv"))
inegi.cost.comm %>% readr::write_csv(paste0(input.dir,"/processed_data/","inegi_coast_comm.csv"))

sf::st_write(mun.cost, here::here("outputs","shp_files","mun_cost.shp"), delete_layer = TRUE)

make_map(mun.cost, inegi.cost, estados.shp, crs.proj.utm, thistitle="Total population",thisoutput=here::here("outputs","figures","map_locs_en.png"))

make_map(mun.cost, inegi.cost, estados.shp, crs.proj.utm, thistitle="Población total",thisoutput=here::here("outputs","figures","map_locs_sp.png"))


```

Download DENUE data economic units registered in Mexico by economic activity https://en.www.inegi.org.mx/app/mapa/denue/
Data updated November 2023
```{r get denue data}

inegi.comms  <-  readr::read_csv(here::here("outputs","inegi_coast_comm.csv")) 

inegi.comm.codes  <-  inegi.comms %>% 
  dplyr::pull(CVE_LOC)

denue.links= "links_DENUE_descarga_masiva_2023.csv"

unidades.denue <- readr::read_csv(paste0(input.dir,"/", denue.links))

#only run once to download, unzip files and aggregate data

#actividad.denue <- get_denue(unidades.denue, input.dir) 
#unzip_denue(input.dir)

#denue.inegi <- list.files(path=paste0(input.dir,"/denue/conjunto_de_datos"), pattern="denue_inegi_*.*")
#denue.inegi.full <- list.files(path=paste0(input.dir,"/denue/conjunto_de_datos"), pattern="denue_inegi_*.*", full.names = TRUE)

#list.denue <- 1:length(denue.inegi.full)

#lapply(list.denue, extract_denue, denue.inegi, denue.inegi.full, input.dir, inegi.comm.codes, inegi.comms)

denue.cost.comms <- list.files(path=paste0(input.dir,"/processed_data/denue"), pattern="denue_*.*", full.names = TRUE) 

# remove fisheries
denue.other.act <- denue.cost.comms[!denue.cost.comms %in% c("/home/atlantis/coastalvulnerability-inputs/processed_data/denue/denue_fisheries_ecactiv.csv")]  

denue.other <- lapply(denue.other.act, combine_denue)
  
denue.other.comm <- denue.other %>% 
  dplyr::bind_rows() %>% 
  dplyr::rename(CVE_ENT = ENTIDAD) %>% 
  make_code()

denue.other.comm %>% readr::write_csv(paste0(input.dir,"/processed_data/adaptive_capacity/","denue_other_ecactiv.csv"))

denue.other.tot <- denue.other.comm %>% 
  dplyr::group_by(NOM_ENT,NOM_MUN, CVE_MUN, NOM_LOC, CVE_LOC) %>% 
  dplyr::summarise(tot_denue = sum(neg_tot))

readr::write_csv(denue.other.tot, paste0(input.dir,"/processed_data/adaptive_capacity/","denue_tot_ecactiv.csv"))

#schools and other educational resources  
denue.educa <- denue.other.comm %>% 
  dplyr::filter(grepl("educación", nombre_act, ignore.case = TRUE) | grepl("educativos", nombre_act, ignore.case = TRUE) | grepl("Escuelas", nombre_act, ignore.case = TRUE) | grepl("Biblioteca", nombre_act, ignore.case = TRUE))
 
denue.educa.tot <- denue.educa %>% 
  dplyr::mutate(activity = "education") %>% 
  dplyr::group_by(CVE_MUN, CVE_LOC, COM_ID, activity) %>% 
  dplyr::summarise(tot_eddenue = sum(neg_tot)) %>% 
  dplyr::left_join(inegi.comms, by =c("CVE_MUN", "CVE_LOC", "COM_ID")) %>% 
  dplyr::mutate(edu_pcapita = tot_eddenue/ POBTOT)

readr::write_csv(denue.educa.tot, paste0(input.dir,"/processed_data/adaptive_capacity/","denue_education_ecactiv.csv"))

#fishery and aquaculture businesses
denue.fish <- readr::read_csv("/home/atlantis/coastalvulnerability-inputs/processed_data/denue/denue_fisheries_ecactiv.csv")

denue.fish.tot <- denue.fish %>% 
  dplyr::group_by(CVE_MUN, CVE_LOC, COM_ID) %>% 
  dplyr::summarise(tot_denue = sum(neg_tot)) 

readr::write_csv(denue.fish.tot, paste0(input.dir,"/processed_data/adaptive_capacity/","denue_fishaqtot_ecactiv.csv"))

aqua.act <- c("Camaronicultura","Piscicultura y otra acuicultura, excepto camaronicultura")			

fishery.act <- c("Pesca de camarón","Pesca de sardina y anchoveta","Pesca de túnidos","Pesca y captura de peces, crustáceos, moluscos y otras especies")
				
denue.fish.num <- denue.fish %>% 
  dplyr::filter(nombre_act %in% fishery.act) %>% 
  dplyr::mutate(activity = "fisheries economic units") %>% 
  dplyr::group_by(CVE_MUN, CVE_LOC, activity) %>% 
  dplyr::summarise(tot_denue_fish = sum(neg_tot))  %>% 
  dplyr::left_join(inegi.comms, by =c("CVE_MUN", "CVE_LOC")) %>% 
  dplyr::mutate(fish_pcapita = tot_denue_fish/ POBTOT) %>% 
  dplyr::left_join(denue.other.tot, by= c("NOM_ENT","NOM_MUN","CVE_MUN","NOM_LOC","CVE_LOC")) %>% 
  dplyr::mutate(prop_uefish = tot_denue_fish / tot_denue) %>% 
  dplyr::select(CVE_LOC, CVE_MUN, tot_denue_fish, fish_pcapita, prop_uefish) %>% 
  replace(is.na(.), 0) 

readr::write_csv(denue.fish.num, paste0(input.dir,"/processed_data/sensitivity/","denue_fisheries_ecactiv.csv"))

denue.aqua.num <- denue.fish %>% 
  dplyr::filter(nombre_act %in% aqua.act) %>% 
  dplyr::mutate(activity = "aquaculture economic units") %>% 
  dplyr::group_by(CVE_MUN, CVE_LOC, COM_ID, activity) %>% 
  dplyr::summarise(tot_denue_aqua = sum(neg_tot)) %>% 
  dplyr::left_join(inegi.comms, by =c("CVE_MUN", "CVE_LOC")) %>% 
  dplyr::mutate(aqua_pcapita = tot_denue_aqua/ POBTOT) %>% 
  dplyr::left_join(denue.other.tot, by= c("NOM_ENT","NOM_MUN","CVE_MUN","NOM_LOC","CVE_LOC")) %>% 
  dplyr::mutate(prop_ueaqua = tot_denue_aqua / tot_denue) %>% 
  dplyr::select(CVE_LOC, CVE_MUN, tot_denue_aqua, aqua_pcapita, prop_ueaqua) %>% 
  replace(is.na(.), 0) 


readr::write_csv(denue.aqua.num, paste0(input.dir,"/processed_data/sensitivity/","denue_aqua_ecactiv.csv"))




```


```{r road access}

crs.proj.utm <- "+proj=utm +zone=12 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +datum=NAD83"
crs.proj.wgs <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"

ext.carr.proj <- sf::st_read("~/coastalvulnerability-inputs/adaptive_capacity/road_access/carre1mgw.shp") %>% 
sf::st_transform(., 6367)

length.mt <- ext.carr.proj %>% 
  sf::st_length() %>% 
  sf::st_drop_geometry() %>% 
  as.numeric() %>% 
  tidyr::as_tibble() %>% 
  dplyr::rename(length_m=value)

ext.carr.proj.dis <- ext.carr.proj %>% 
  dplyr::bind_cols(length.mt)

#estimate road access within community buffer

inegi.cost.buffer.proj <- sf::st_read(paste0(input.dir,"/shp_files/","inegi_comm_buffer.shp")) %>% 
sf::st_transform(., 6367)

carretera.loc <- sf::st_intersection(ext.carr.proj.dis, inegi.cost.buffer.proj)

length.loc <- carretera.loc %>% 
  sf::st_length() %>% 
  sf::st_drop_geometry() %>% 
  as.numeric() %>% 
  tidyr::as_tibble() %>% 
  dplyr::rename(length_loc=value)

ext.carr.proj.loc <- carretera.loc %>% 
  dplyr::bind_cols(length.loc)

carretera.loc.sum <- tidyr::as_tibble(ext.carr.proj.loc) %>% 
  sf::st_drop_geometry() %>% 
  dplyr::mutate(CVE_ENT = cve_ent, CVE_MUN = cve_mun, CVE_LOC = cve_loc) %>% 
  make_code() %>% 
  dplyr::group_by(CVE_ENT, CVE_MUN, CVE_LOC) %>% 
  dplyr::summarise(tot_length_loc_km = (sum(length_m)/1000)) %>% 
  replace(is.na(.), 0) 


readr::write_csv(carretera.mun.sum, paste0(input.dir,"/processed_data/adaptive_capacity/length_road_access_buffer.csv"))


```

Employment centers
```{r}

emp.cent <- readxl::read_xlsx("~/coastalvulnerability-inputs/adaptive_capacity/employment_centers/cct_2021.xlsx") 

inegi.table <- "inegi_coast_comm.csv"
inegi.comms <- fix_inegi(inegi.table)

inegi.comm.codes  <-  inegi.comms %>% 
  dplyr::pull(CVE_LOC)

emp.cent.code <- emp.cent %>% 
  dplyr::rename(CVE_ENT= INMUEBLE_CV_ENT, NOM_ENT = INMUEBLE_C_NOM_ENT, CVE_MUN = INMUEBLE_CV_MUN, NOM_MUN= INMUEBLE_C_NOM_MUN, NOM_LOC=INMUEBLE_C_NOM_LOC) %>% 
  dplyr::filter(NOM_ENT!="NA") %>% 
  dplyr::filter(CVE_LOC %in% inegi.comm.codes) %>% 
  dplyr::mutate(NOM_MUN = stringi::stri_trans_general(str = NOM_MUN, id = "Latin-ASCII")) %>% 
  dplyr::mutate(NOM_LOC = stringi::stri_trans_general(str = NOM_LOC, id = "Latin-ASCII")) %>% 
  make_code()
  
emp.cent.code.sum <- emp.cent.code %>% 
  dplyr::mutate(id_row = 1) %>% 
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(tot_emp = sum(id_row)) %>% 
  dplyr::left_join(inegi.comms, by= c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::mutate(prop_emp = tot_emp/POBTOT) %>% 
  dplyr::select(CVE_ENT, CVE_MUN, CVE_LOC, tot_emp, prop_emp) %>% 
  replace(is.na(.), 0) 

readr::write_csv(emp.cent.code.sum, paste0(input.dir,"/processed_data/adaptive_capacity/employment_centers.csv"))


```

Infrastructure indicators
```{r}

inf.ind <- readxl::read_xlsx("~/coastalvulnerability-inputs/adaptive_capacity/access_infrastructure/Base_indicadores_loc_PATP_abril_2023.xlsx") 

inegi.table <- "inegi_coast_comm.csv"
inegi.comms <- fix_inegi(inegi.table)

inegi.comm.codes  <-  inegi.comms %>% 
  dplyr::pull(CVE_LOC)

inf.ind.codes <- inf.ind %>% 
  dplyr::mutate(CVE_MUN = `Clave municipio`, CVE_LOC = `Clave localidad`) %>% 
    dplyr::select(CVE_MUN, CVE_LOC, r_1erN_auto, r_2doN_auto, r_3erN_auto, r_preescolar_auto, r_primaria_auto, r_secundaria_auto, r_CID) %>% 
  dplyr::rename(acc_1health=r_1erN_auto, acc_2health=r_2doN_auto, acc_3health=r_3erN_auto, acc_presc=r_preescolar_auto, acc_elem=r_primaria_auto, acc_sec = r_secundaria_auto, acc_dev=r_CID)

names.categ <- colnames(inf.ind.codes)
num.cols <- 3:length(names.categ)

new.tibble <- inf.ind.codes[,1:2]

new.inf.codes <- lapply(num.cols, add_varcategory, names.categ, inf.ind.codes)

#NAs correspond to not available values in the original table. These are mostly islands, where the corresponding centers are too far but distance was not measured, so we assigned the highest values

inf.table <- new.inf.codes %>% 
  dplyr::bind_cols(new.tibble, .) %>% 
  dplyr::filter(CVE_LOC %in% inegi.comm.codes) %>% 
  replace(is.na(.), 0) 

inf.table.max <- inf.table %>%
  dplyr::summarise(acc_1healthMax=max(acc_1health), acc_2healthMax=max(acc_2health), acc_3healthMax=max(acc_3health), acc_prescMax=max(acc_presc), acc_elemMax=max(acc_elem),
                   acc_secMax = max(acc_sec), acc_devMax=max(acc_dev))

inf.table.rev <- inf.table %>% 
  dplyr::mutate(acc_1health = dplyr::if_else(acc_1health==0, inf.table.max$acc_1healthMax, acc_1health)) %>% 
  dplyr::mutate(acc_2health = dplyr::if_else(acc_2health==0, inf.table.max$acc_2healthMax, acc_2health)) %>% 
  dplyr::mutate(acc_3health = dplyr::if_else(acc_3health==0, inf.table.max$acc_3healthMax, acc_3health)) %>% 
  dplyr::mutate(acc_presc = dplyr::if_else(acc_presc==0, inf.table.max$acc_prescMax, acc_presc)) %>% 
 dplyr::mutate(acc_elem = dplyr::if_else(acc_elem==0, inf.table.max$acc_elemMax, acc_elem)) %>% 
 dplyr::mutate(acc_sec = dplyr::if_else(acc_sec==0, inf.table.max$acc_secMax, acc_sec)) %>% 
 dplyr::mutate(acc_dev = dplyr::if_else(acc_dev==0, inf.table.max$acc_devMax, acc_dev))


readr::write_csv(inf.table.rev, paste0(input.dir,"/processed_data/adaptive_capacity/access_infrastructure.csv"))

```

Poverty indicators and marginalization index
```{r}

inegi.table <- "inegi_coast_comm.csv"
inegi.comms <- fix_inegi(inegi.table)

inegi.comm.codes  <-  inegi.comms %>% 
  dplyr::pull(CVE_LOC)

pov.ind.1 <- readxl::read_xls("~/coastalvulnerability-inputs/adaptive_capacity/poverty_marginalization/IML_2020.xls", sheet = 2) 

pov.ind.comms.1 <- pov.ind.1 %>% 
  dplyr::filter(CVE_LOC %in% inegi.comm.codes)

pov.ind.2 <- readxl::read_xls("~/coastalvulnerability-inputs/adaptive_capacity/poverty_marginalization/IML_2020.xls", sheet = 3) 

pov.ind.comms.2 <- pov.ind.2 %>% 
  dplyr::filter(CVE_LOC %in% inegi.comm.codes)

pov.code <- pov.ind.comms.1 %>% 
  dplyr::bind_rows(pov.ind.comms.2) %>% 
  dplyr::rename(CVE_ENT= ENT, CVE_MUN = MUN) %>% 
  make_code()
  
pov.table <- pov.code %>% 
  dplyr::select(CVE_LOC, CVE_MUN, ANALF:IM_2020)

readr::write_csv(pov.table, paste0(input.dir,"/processed_data/adaptive_capacity/poverty_indices.csv"))


```


Fisheries subsidies

```{r fisheries subsidies, echo=TRUE, message=TRUE, warning=FALSE}

inegi.cost.comm  <- readr::read_csv(paste0(input.dir,"/processed_data/","inegi_coast_comm.csv")) %>% 
  dplyr::mutate(NOM_ENT = stringi::stri_trans_general(str = NOM_ENT, id = "Latin-ASCII")) %>% 
  dplyr::mutate(NOM_MUN = stringi::stri_trans_general(str = NOM_MUN, id = "Latin-ASCII")) %>% 
  dplyr::mutate(NOM_LOC = stringi::stri_trans_general(str = NOM_LOC, id = "Latin-ASCII")) %>% 
  dplyr::mutate(NOM_ENT=toupper(NOM_ENT)) %>%
  dplyr::mutate(NOM_MUN=toupper(NOM_MUN)) %>%
  dplyr::mutate(NOM_LOC=toupper(NOM_LOC))

cost.codes.ent <- inegi.cost.comm %>%
  dplyr::distinct(CVE_ENT, NOM_ENT) 

cost.codes.mun <- inegi.cost.comm %>%
  dplyr::distinct(CVE_ENT, NOM_MUN, CVE_MUN) 

cost.codes.loc <- inegi.cost.comm %>%
   dplyr::distinct(NOM_ENT, CVE_ENT, NOM_MUN, CVE_MUN, NOM_LOC, CVE_LOC) 
 
#gas subsidies
gas.subsidy<- readxl::read_xlsx(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/padron_beneficiarios_combustible_2011-2019.xlsx")) %>% 
  dplyr::mutate(cve_ent = as.numeric(cve_ent), cve_mun = as.numeric(cve_mun), cve_loc = as.numeric(cve_loc)) %>% 
  dplyr::mutate(entidad = dplyr::if_else(municipio=="HUATABAMPO", "SONORA", 
                                         dplyr::if_else(municipio=="ENSENADA", "BAJA CALIFORNIA",
                                                        dplyr::if_else(municipio=="CABORCA","SONORA", entidad)))) %>% 
  dplyr::mutate(municipio=dplyr::if_else(localidad=="MORONCARIT","HUATABAMPO",municipio)) %>%
  dplyr::mutate(localidad=gsub("-"," ",localidad)) %>% 
  dplyr::mutate(municipio = stringi::stri_trans_general(str = municipio, id = "Latin-ASCII")) %>% 
  dplyr::mutate(localidad = stringi::stri_trans_general(str = localidad, id = "Latin-ASCII"))

gas.subsidy.comms <- extract_comms(gas.subsidy) %>% 
  dplyr::rename(CVE_ENT = cve_ent, CVE_MUN = cve_mun, CVE_LOC=cve_loc, NOM_MUN = municipio, NOM_LOC = localidad, NOM_ENT = entidad) %>% 
  make_code()

#add municipality and location to rows missing info

gas.subsidy.comms.ent <- gas.subsidy.comms %>% 
  dplyr::select(-CVE_ENT) %>% 
  dplyr::left_join(cost.codes.ent, by=c("NOM_ENT"))

gas.subsidy.mun <- gas.subsidy.comms.ent %>% 
  dplyr::select(-CVE_MUN) %>% 
  dplyr::left_join(cost.codes.mun, by=c("CVE_ENT","NOM_MUN"))

missing.cve.loc <- gas.subsidy.mun %>% 
  dplyr::filter(is.na(CVE_LOC) & NOM_LOC!="NA") %>% 
  dplyr::select(-CVE_LOC) %>% 
  dplyr::left_join(cost.codes.loc, by=c("CVE_ENT","CVE_MUN", "NOM_LOC"))

gas.subsidy.loc <- gas.subsidy.mun %>% 
  dplyr::filter(!is.na(CVE_LOC) | NOM_LOC=="NA") %>% 
  dplyr::bind_rows(missing.cve.loc) %>% 
  dplyr::filter(!is.na(CVE_LOC))

gas.subsidy.codes <- gas.subsidy.loc %>% 
  dplyr::filter(año>=2014) %>% 
  dplyr::mutate(id_row = 1) %>% 
  dplyr::filter(monto_conapesca>0) %>% 
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(no_bengas=sum(id_row), tot_bengas=sum(monto_conapesca)) %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  dplyr::mutate(bengas_perc = (tot_bengas / POBTOT)) %>% 
  dplyr::select(CVE_LOC, CVE_MUN, no_bengas, bengas_perc)



#BIENPESCA

bienpesca.files <- c(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/bien_pescadores_y_acuicultores_2020.xlsx"),
                     paste0(input.dir,"/adaptive_capacity/fishery_subsidies/bienpesca_2021.xlsx"),
                     paste0(input.dir,"/adaptive_capacity/fishery_subsidies/bienpesca_2022.xlsx"),
                     paste0(input.dir,"/adaptive_capacity/fishery_subsidies/bienpesca_2023.xlsx"))

bpesca.subsidy.comms <- lapply(bienpesca.files, clean_bienpesca, inegi.cost.comm) %>% 
  dplyr::bind_rows()

bpesca.subsidy.codes <- bpesca.subsidy.comms %>% 
  make_code() %>% 
  extract_comms()

bpesca.subsidy.res <- bpesca.subsidy.codes %>% 
  dplyr::mutate(id_row = 1) %>% 
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(no_bpesca=sum(id_row), tot_bpesca=sum(mont_tot)) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  dplyr::mutate(bpesca_perc = (tot_bpesca / POBTOT)) %>% 
  dplyr::select(CVE_LOC, CVE_MUN, no_bpesca, bpesca_perc)


#vessel modernization

boat.subsidy<- readxl::read_xlsx(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/beneficiarios_modernizacion_barcos_2011-2019.xlsx"))

boat.subsidy.comms <- extract_comms(boat.subsidy)

boat.subsidy.table <- boat.subsidy.comms %>% 
  dplyr::filter(año>=2014) %>% 
  dplyr::filter(tipo_cobertura=="LOCAL") %>% 
  dplyr::rename(CVE_LOC = cve_inegi, CVE_MUN = cve_mun) %>% 
  dplyr::select(-cve_loc) %>% 
  dplyr::mutate(id_row = 1, monto_gob_edo = as.numeric(monto_gob_edo), monto_productor = as.numeric(monto_productor), mont_tot = (monto_productor + monto_gob_edo + monto_conapesca) )%>% 
  dplyr::filter(mont_tot!=0) %>% 
  make_code() 

boat.subsidy.codes <- boat.subsidy.table %>%
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(no_boat=sum(id_row), tot_boat=sum(mont_tot)) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  dplyr::mutate(boat_perc = (tot_boat / POBTOT)) %>% 
  dplyr::select(CVE_LOC, CVE_MUN, no_boat, boat_perc)

#subsidies for product commercialization
commerce.subsidy<- readxl::read_xlsx(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/beneficiarios_comercializacion_2014-2019.xlsx"))

commerce.subsidy.comms <- extract_comms(commerce.subsidy)

commerce.subsidy.table <- commerce.subsidy.comms %>% 
  dplyr::filter(tipo_cobertura=="LOCAL") %>% 
  dplyr::rename(CVE_LOC = cve_inegi, CVE_MUN = cve_mun) %>% 
  dplyr::select(-cve_loc) %>% 
  dplyr::mutate(mont_tot = (monto_gob_edo + monto_conapesca))%>% 
  dplyr::filter(mont_tot!=0) %>% 
  make_code() 
  
commerce.subsidy.codes <- commerce.subsidy.table %>% 
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(no_comm=sum(no_beneficiarios), tot_comm=sum(mont_tot)) %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  dplyr::mutate(comm_perc = (tot_comm / POBTOT)) %>% 
  dplyr::select(CVE_LOC, CVE_MUN, no_comm, comm_perc)


#subsidies for aquaculture
aqua.subsidy<- readxl::read_xlsx(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/beneficiarios_acuacultura_2014-2019.xlsx"))
#this file does not have project characteristics for 2019 data, that is in aquaculture_incentives_2019.xlsx

aqua.subsidy.comms <- extract_comms(aqua.subsidy)

aqua.subsidy.table <- aqua.subsidy.comms %>% 
  dplyr::filter(tipo_cobertura=="LOCAL") %>% 
  dplyr::rename(CVE_LOC = cve_inegi, CVE_MUN = cve_mun) %>% 
  dplyr::select(-cve_loc) %>% 
  dplyr::mutate(id_row = 1, mont_tot = monto_conapesca)%>% 
  dplyr::filter(mont_tot!=0) %>% 
  make_code()

aqua.subsidy.codes <- aqua.subsidy.table %>% 
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(no_aqua=sum(id_row), tot_aqua=sum(mont_tot)) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  dplyr::mutate(aqua_perc = (tot_aqua / POBTOT)) %>% 
  dplyr::select(CVE_LOC, CVE_MUN, no_aqua, aqua_perc)


#subsidies to support seafood consumption
consump.subsidy<- readxl::read_xlsx(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/beneficiarios_consumo_2014-2019.xlsx"))

consump.subsidy.comms <- extract_comms(consump.subsidy)

consump.subsidy.table <- consump.subsidy.comms %>% 
  dplyr::filter(cve_inegi!="NA") %>% 
  dplyr::rename(CVE_LOC = cve_inegi, CVE_MUN = cve_mun) %>% 
  dplyr::select(-cve_loc) %>% 
  dplyr::mutate(id_row = 1, mont_tot = monto_conapesca)%>% 
  dplyr::filter(mont_tot!=0) %>% 
  make_code()

consump.subsidy.codes <- consump.subsidy.table %>% 
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(no_cons=sum(id_row), tot_cons=sum(mont_tot)) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  dplyr::mutate(cons_perc = (tot_cons / POBTOT)) %>% 
  dplyr::select(CVE_LOC, CVE_MUN, no_cons, cons_perc)

#subsidies to support fishery value chains
value.subsidy<- readxl::read_xlsx(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/beneficiarios_cadenas_productivas_2011-2019.xlsx")) %>% 
  dplyr::filter(año>=2014)

value.subsidy.comms <- extract_comms(value.subsidy)

value.subsidy.table <- value.subsidy.comms %>% 
  dplyr::rename(CVE_LOC = cve_inegi, CVE_MUN = cve_mun) %>% 
  dplyr::select(-cve_loc) %>% 
  dplyr::mutate(id_row = 1, mont_tot = monto_conapesca)%>% 
  dplyr::filter(mont_tot!=0) %>% 
  make_code() 

value.subsidy.codes <- value.subsidy.table %>% 
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(no_value=sum(id_row), tot_value=sum(mont_tot)) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  dplyr::mutate(value_perc = (tot_value / POBTOT)) %>% 
  dplyr::select(CVE_LOC, CVE_MUN, no_value, value_perc)


#subsidies to strengthen fisheries
str.subsidy<- readxl::read_xlsx(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/beneficiarios_fortalecimiento_2011-2019.xlsx")) %>% 
  dplyr::filter(año>=2014)

str.subsidy.comms <- extract_comms(str.subsidy)

str.subsidy.table <- str.subsidy.comms %>% 
  dplyr::rename(CVE_LOC = cve_inegi, CVE_MUN = cve_mun) %>% 
  dplyr::select(-cve_loc) %>% 
  dplyr::mutate(id_row = 1, mont_tot = monto_conapesca)%>% 
  dplyr::filter(mont_tot!=0) %>% 
  make_code() 

str.subsidy.codes <- str.subsidy.table %>% 
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(no_str=sum(id_row), tot_str=sum(mont_tot)) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  dplyr::mutate(str_perc = (tot_str / POBTOT)) %>% 
  dplyr::select(CVE_LOC, CVE_MUN, no_str, str_perc)

#subsidies to strengthen inspection and surveillance
ins.subsidy<- readxl::read_xlsx(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/beneficiarios_vigilancia_2011-2019.xlsx")) %>% 
  dplyr::filter(año>=2014) %>% 
  dplyr::rename(municipio=municipio_ue)

ins.subsidy.comms <- extract_comms(ins.subsidy)

ins.subsidy.table <- ins.subsidy.comms %>% 
  dplyr::rename(CVE_LOC = cve_inegi, CVE_MUN = cve_mun_ue) %>% 
  dplyr::mutate(id_row = 1, mont_tot = monto_conapesca)%>% 
  dplyr::filter(mont_tot!=0) %>% 
  make_code() 

ins.subsidy.codes <- ins.subsidy.table %>% 
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(no_ins=sum(id_row), tot_ins=sum(mont_tot)) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  dplyr::mutate(ins_perc = (tot_ins / POBTOT)) %>% 
  dplyr::select(CVE_LOC, CVE_MUN, no_ins, ins_perc)


#subsidies to strengthen the legal framework
leg.subsidy<- readxl::read_xlsx(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/beneficiarios_ordenamiento_2011-2019.xlsx")) %>% 
  dplyr::filter(año>=2014) 

leg.subsidy.comms <- extract_comms(leg.subsidy)

leg.subsidy.table <- leg.subsidy.comms %>% 
  dplyr::rename(CVE_LOC = cve_inegi, CVE_MUN = cve_mun) %>% 
  dplyr::mutate(id_row = 1, mont_tot = monto_conapesca)%>% 
  dplyr::filter(mont_tot!=0) %>% 
  dplyr::filter(CVE_MUN!="NA") %>% 
  make_code()

leg.subsidy.codes <- leg.subsidy.table %>% 
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(no_leg=sum(id_row), tot_leg=sum(mont_tot)) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  dplyr::mutate(leg_perc = (tot_leg / POBTOT)) %>% 
  dplyr::select(CVE_LOC, CVE_MUN, no_leg, leg_perc)


#subsidies to reduce effort in industrial fishing
eff.subsidy<- readxl::read_xlsx(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/beneficiarios_reduccion_esfuerzo_2011-2018.xlsx")) %>% 
  dplyr::filter(año>=2014)

eff.subsidy.comms <- extract_comms(eff.subsidy)

eff.subsidy.table <- eff.subsidy.comms %>% 
  dplyr::rename(CVE_LOC = cve_inegi, CVE_MUN = cve_mun) %>% 
  dplyr::mutate(id_row = 1, mont_tot = monto_conapesca)%>% 
  dplyr::select(-cve_loc) %>% 
  dplyr::filter(mont_tot!=0) %>% 
  make_code()

eff.subsidy.codes <- eff.subsidy.table %>% 
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(no_eff=sum(id_row), tot_eff=sum(mont_tot)) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  dplyr::mutate(eff_perc = (tot_eff / POBTOT)) %>% 
  dplyr::select(CVE_LOC, CVE_MUN, no_eff, eff_perc)



all.fishery.subsidies <- inegi.cost.comm %>% 
  dplyr::left_join(bpesca.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(gas.subsidy.codes,by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(boat.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(commerce.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(aqua.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(consump.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(value.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(str.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(ins.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(leg.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(eff.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) 


fishery.tot.subs <- all.fishery.subsidies %>% 
  replace(is.na(.), 0) 

#use to test that all columns have value
#  dplyr::summarise(across(no_bpesca:mont_ins, sum))

readr::write_csv(fishery.tot.subs, paste0(input.dir,"/processed_data/adaptive_capacity","fisheries_subsidies.csv"))

```

Extract permit information from the Registro Nacional de Pesca y Acuacultura RNPA 
https://www.gob.mx/conapesca/documentos/registro-nacional-de-pesca-y-acuacultura-rnpa

```{r get catch, echo=TRUE, message=TRUE, warning=TRUE}

ents.coast.selecc <- toupper(c("Baja California Sur", "Baja California", "Sonora", "Sinaloa", "Nayarit", "Jalisco", "Yucatán", "Campeche", "Quintana Roo"))
coast.selecc <- stringi::stri_trans_general(str = ents.coast.selecc, id = "Latin-ASCII")

#only communities considered in the analysis
inegi.cost.comm  <- readr::read_csv(paste0(input.dir,"/processed_data/","inegi_coast_comm.csv")) %>% 
  dplyr::mutate(NOM_ENT= stringi::stri_trans_general(str = NOM_ENT, id = "Latin-ASCII"), NOM_ENT = toupper(NOM_ENT)) %>% 
  dplyr::mutate(NOM_MUN = stringi::stri_trans_general(str = NOM_MUN, id = "Latin-ASCII"), NOM_MUN = toupper(NOM_MUN)) %>% 
  dplyr::mutate(NOM_LOC = stringi::stri_trans_general(str = NOM_LOC, id = "Latin-ASCII"), NOM_LOC = toupper(NOM_LOC))

inegi.cost.mun <- inegi.cost.comm %>% 
  dplyr::distinct(NOM_MUN, CVE_MUN)

permit.files <- list.files(path = paste0(input.dir,"/sensitivity/fisheries_data"), full.names = TRUE)
no.permitfiles <- 1:length(permit.files)

permit.data.inegi <- lapply(no.permitfiles, extract_permits, permit.files, inegi.cost.comm, coast.selecc)

permit.table <- permit.data.inegi %>% 
  dplyr::bind_rows() %>% 
  dplyr::filter(!is.na(ENTIDAD)) %>% 
  dplyr::distinct(NOM_ENT, rnp_code, NOM_MUN, NOM_LOC, ENTIDAD, MUN, LOC, CVE_MUN, CVE_LOC, COM_ID, deci_lat, deci_lon, POBTOT) %>% 
  dplyr::select(-NOM_MUN) %>% 
  dplyr::left_join(inegi.cost.mun, by = "CVE_MUN")

permit.per.loc <- permit.table %>% 
  dplyr::mutate(index_no = 1) %>% 
  dplyr::group_by(NOM_ENT, NOM_MUN, NOM_LOC, ENTIDAD, MUN, LOC, CVE_MUN, CVE_LOC, COM_ID, deci_lat, deci_lon, POBTOT) %>% 
  dplyr::summarise(tot_perm=sum(index_no)) %>% 
  dplyr::mutate(perm_pcapita = tot_perm/POBTOT) %>% 
  dplyr::select(CVE_MUN, CVE_LOC, tot_perm, perm_pcapita)

readr::write_csv(permit.per.loc, paste0(input.dir,"/processed_data/sensitivity/fishery_permits.csv"))

catch.files <- list.files(path = paste0(input.dir,"/catch"), full.names = TRUE)
no.catchfiles <- 1:length(catch.files)

#match to rnpa number

catch.rnpa <- lapply(no.catchfiles,get_rnpa_catch, catch.files, coast.selecc) 

rnpa.catch.table <- catch.rnpa %>%
  dplyr::bind_rows() %>% 
  dplyr::mutate(rnp_code = as.character(rnp_code))

catch.rnpa.codes <- rnpa.catch.table %>%
  dplyr::distinct(rnp_code) 

catch.permit.table <- catch.rnpa.codes %>% 
  dplyr::left_join(permit.table, by = c("rnp_code"))

catch.loc <- catch.permit.table %>% 
  dplyr::left_join(rnpa.catch.table, by = c("rnp_code")) %>% 
  dplyr::filter(!is.na(ENTIDAD)) %>% 
  dplyr::select(-NOM_MUN) %>% 
  dplyr::left_join(inegi.cost.mun, by = "CVE_MUN") %>% 
  dplyr::group_by(NOM_ENT,NOM_MUN,CVE_MUN, NOM_LOC, CVE_LOC, COM_ID, deci_lat, deci_lon,POBTOT) %>% 
  dplyr::summarise(tot_catch_mt = sum(tot_weight_kg)/ 1000) %>% 
  dplyr::mutate(catch_percapita = tot_catch_mt/ POBTOT) %>% 
  dplyr::select(CVE_MUN, CVE_LOC, tot_catch_mt, catch_percapita)

readr::write_csv(catch.loc, paste0(input.dir,"/processed_data/sensitivity/fishery_catch.csv"))


```



Assign catch to locations

```{r}
ents.coast.selecc <- toupper(c("Baja California Sur", "Baja California", "Sonora", "Sinaloa", "Nayarit", "Jalisco", "Yucatán", "Campeche", "Quintana Roo"))
coast.selecc <- stringi::stri_trans_general(str = ents.coast.selecc, id = "Latin-ASCII")
coast.selecc.pac <- c("BAJA CALIFORNIA SUR","BAJA CALIFORNIA","SONORA","SINALOA","NAYARIT","JALISCO")

loc.pacifico <- readxl::read_xlsx(paste0(input.dir,"/Localidades_pesqueras_Pacifico.xlsx")) %>% 
  dplyr::rename(NOM_ENT= ESTADO, NOM_LOC = LOCALIDAD_REVISADA) %>% 
  dplyr::mutate(NOM_ENT= stringi::stri_trans_general(str = NOM_ENT, id = "Latin-ASCII"), NOM_ENT = toupper(NOM_ENT)) %>% 
  dplyr::mutate(NOM_LOC = stringi::stri_trans_general(str = NOM_LOC, id = "Latin-ASCII"), NOM_LOC = toupper(NOM_LOC)) %>% 
  dplyr::select(-LOCALIDAD_ORIGINAL, -ID) %>% 
  dplyr::filter(NOM_ENT %in% coast.selecc.pac)

#all coastal communities, including those with no census data
inegi.cost.comm  <- readr::read_csv(paste0(input.dir,"/processed_data/","all_coastal_communities_INEGI.csv")) %>% 
  dplyr::mutate(NOM_ENT= stringi::stri_trans_general(str = NOM_ENT, id = "Latin-ASCII"), NOM_ENT = toupper(NOM_ENT)) %>% 
  dplyr::mutate(NOM_MUN = stringi::stri_trans_general(str = NOM_MUN, id = "Latin-ASCII"), NOM_MUN = toupper(NOM_MUN)) %>% 
  dplyr::mutate(NOM_LOC = stringi::stri_trans_general(str = NOM_LOC, id = "Latin-ASCII"), NOM_LOC = toupper(NOM_LOC))

catch.files <- list.files(path = paste0(input.dir,"/catch"), full.names = TRUE)
no.catchfiles <- 1:length(catch.files)

catch.locations <- lapply(no.catchfiles, extract_locations, catch.files, coast.selecc)
  
catch.locs.all <- catch.locations %>% 
  dplyr::bind_rows() %>% 
  dplyr::distinct(NOM_ENT, NOM_LOC)

 catch.locs.inegi <-  catch.locs.all %>% 
    dplyr::mutate(NOM_LOC = gsub(" \\(B\\.C\\.S\\.\\)","", NOM_LOC)) %>%
    dplyr::mutate(NOM_LOC=dplyr::if_else(NOM_LOC=="BAHIA KINO","BAHIA DE KINO",
                                         dplyr::if_else(NOM_LOC=="PTO ADOLFO LOPEZ MATEOS","PUERTO ADOLFO LOPEZ MATEOS",
                                                 dplyr::if_else(NOM_LOC=="PUERTO VIEJO (EN SAN CARLOS)","PUERTO SAN CARLOS",
                                                                dplyr::if_else(NOM_LOC=="PUNTA FINAL (B. DE LOS ANGELES)","BAHIA DE LOS ANGELES",
                                                                               dplyr::if_else(NOM_LOC=="AGUAS LITORALES (BAHIA TORTUGAS)","BAHIA TORTUGAS", 
                                                                                              dplyr::if_else(NOM_LOC=="YAVAROS", "YAVAROS (ISLA LAS VIEJAS)", NOM_LOC))))))) %>% 
    dplyr::mutate(NOM_ENT=dplyr::if_else(NOM_LOC=="TOPOLOBAMPO","SINALOA", NOM_ENT)) %>% 
    dplyr::distinct(NOM_ENT, NOM_LOC) 
 
 catch.locs.inegi.all <- catch.locs.inegi %>% 
 dplyr::left_join(inegi.cost.comm, by = c("NOM_ENT","NOM_LOC")) %>% 
    dplyr::group_by(NOM_ENT, NOM_LOC) %>%
    dplyr::mutate(dupe = dplyr::n()>1)
  
 catch.locs.inegi.all %>% 
     dplyr::filter(is.na(ENTIDAD)) %>% 
    write_csv(paste0(input.dir,"/processed_data/localidades_captura_inegi.csv"))
 
  #subset locations in the pacific and match with landing sites
  catch.locs.pac <- catch.locs.inegi %>% 
    dplyr::filter(is.na(ENTIDAD)) %>% 
    dplyr::filter(NOM_ENT %in% coast.selecc.pac) %>% 
    dplyr::left_join(loc.pacifico, by = c("NOM_ENT","NOM_LOC"))
     
  #used to find duplicates https://stackoverflow.com/questions/6986657/find-duplicated-rows-based-on-2-columns-in-data-frame-in-r
  #there are multiple landing codes by location, so not using
  # catch.file.sites.table %>% 
  #   dplyr::group_by(NOM_ENT, NOM_LOC) %>%
  #   dplyr::mutate(dupe = dplyr::n()>1)
  # 
  
  
   
  
```


Natural protected areas

```{r}
crs.proj.utm <- "+proj=utm +zone=12 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +datum=NAD83"
crs.proj.wgs <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"

prot.area <- sf::st_read("~/coastalvulnerability-inputs/adaptive_capacity/natural_protected_areas/226_ANP_ITRF08_27022024.shp") %>% 
sf::st_transform(., 6367)

#estimate road access within community buffer

inegi.cost.buffer.proj <- sf::st_read(paste0(input.dir,"/shp_files/","inegi_comm_buffer_50k.shp")) %>% 
sf::st_transform(., 6367) %>% 
  dplyr::select(id_row:deci_ln, geometry)

prot.area.buff <- sf::st_intersection(prot.area, inegi.cost.buffer.proj)

area.int <- prot.area.buff %>% 
  sf::st_area() %>% 
  sf::st_drop_geometry() %>% 
  as.numeric() %>% 
  tidyr::as_tibble() %>% 
  dplyr::rename(area_loc_m2=value)

ext.area.proj.loc <- prot.area.buff %>% 
  dplyr::bind_cols(area.int)

area.loc.sum <- tidyr::as_tibble(ext.area.proj.loc) %>% 
  sf::st_drop_geometry() %>% 
  dplyr::mutate(CVE_ENT = cve_ent, CVE_MUN= cve_mun, CVE_LOC = cve_loc) %>% 
  make_code() %>% 
  dplyr::group_by(CVE_ENT, CVE_MUN, CVE_LOC) %>% 
  dplyr::summarise(anp_area_loc_kmsq = (sum(area_loc_m2)/1e+6)) %>% 
  replace(is.na(.), 0) 


readr::write_csv(area.loc.sum, paste0(input.dir,"/processed_data/adaptive_capacity/natural_protected_area_buffer.csv"))

```

Numero de unidades acuicolas
Hectáreas de cultivo

```{r}

inegi.cost.buffer.proj <- sf::st_read(paste0(input.dir,"/shp_files/","inegi_comm_buffer.shp")) %>% 
  sf::st_transform(., 6367) %>% 
  dplyr::select(id_row:deci_ln, geometry)

un.acuicolas.lyrs <- sf::st_layers(paste0(input.dir,"/sensitivity/aquaculture_polygons/","areas_revisadas.kml")) 

lyr.names <- un.acuicolas.lyrs$name

no.lyr.names <- 2:length(lyr.names)

unidades.acuicolas.ly0 <- sf::st_read(paste0(input.dir,"/sensitivity/aquaculture_polygons/","areas_revisadas.kml"), layer="Layer0") 

unidades.acuicolas <- unidades.acuicolas.ly0 

#used a for loop instead of a function so that the layer is updated continously
for(thislayer in no.lyr.names){
  
  this.layer.name <- lyr.names[thislayer]
  print(this.layer.name)
  
  try(this.un.aqua <- sf::st_read(paste0(input.dir,"/sensitivity/aquaculture_polygons/","areas_revisadas.kml"), layer=this.layer.name)) 
  
  selec.un.aqua <- this.un.aqua 
  
  try(unidades.acuicolas <- sf::st_union(unidades.acuicolas, selec.un.aqua))
  
}

# 
# combine_layers <- function(thislayer, lyr.names, unidades.acuicolas){
#   
#   this.layer.name <- lyr.names[thislayer]
#   print(this.layer.name)
#   
#   try(this.un.aqua <- sf::st_read(paste0(input.dir,"/sensitivity/aquaculture_polygons/","areas_revisadas.kml"), layer=this.layer.name)) 
#   
#   try(unidades.acuicolas <- sf::st_union(unidades.acuicolas, this.un.aqua))
#   
#   return(unidades.acuicolas)
# }
# 
#un.aqua.updated <- lapply(no.lyr.names, combine_layers, lyr.names, unidades.acuicolas)

inegi.cost.buffer.proj <- sf::st_read(paste0(input.dir,"/shp_files/","inegi_comm_buffer.shp")) %>% 
sf::st_transform(., 6367) %>% 
  dplyr::select(id_row:deci_ln, geometry)

ua.aqua.proj <- unidades.acuicolas %>% 
  sf::st_transform(., 6367)

ua.area.buff <- sf::st_intersection(ua.aqua.proj, inegi.cost.buffer.proj)

area.int <- ua.area.buff %>% 
  sf::st_area() %>% 
  sf::st_drop_geometry() %>% 
  as.numeric() %>% 
  tidyr::as_tibble() %>% 
  dplyr::rename(area_loc_m2=value)

ext.area.proj.loc <- ua.area.buff %>% 
  dplyr::bind_cols(area.int)

uarea.loc.sum <- tidyr::as_tibble(ext.area.proj.loc) %>% 
  sf::st_drop_geometry() %>% 
  dplyr::mutate(CVE_ENT = cve_ent, CVE_MUN= cve_mun, CVE_LOC = cve_loc) %>% 
  make_code() %>% 
  dplyr::group_by(CVE_ENT, CVE_MUN, CVE_LOC) %>% 
  dplyr::summarise(ua_area_loc_kmsq = (sum(area_loc_m2)/1e+6)) %>% 
  replace(is.na(.), 0) 


readr::write_csv(area.loc.sum, paste0(input.dir,"/processed_data/adaptive_capacity/natural_protected_area_buffer.csv"))


```


2020 census data

```{r}

inegi.cost.comm  <- readr::read_csv(paste0(input.dir,"/processed_data/","inegi_coast_comm.csv"))



```

