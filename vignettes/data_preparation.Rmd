---
title: "Coastal vulnerability"

output:
  html_document

knit: (function(input, encoding) {
    rmarkdown::render(
      input = input,
      encoding = encoding,
      envir = globalenv()
    )
  })
---
Set environment

```{r}
#rebuild and load the package
devtools::load_all() # restarts and loads

# List of packages for session
.packages = c("import")

# Install CRAN packages (if not already installed)
.inst <- .packages %in% installed.packages()
if(length(.packages[!.inst]) > 0) install.packages(.packages[!.inst])

# Load packages into session 
#lapply(.packages, require, character.only=TRUE)

#specifies what functions to import
# https://cran.r-project.org/web/packages/import/vignettes/import.html
import::from(dplyr, mutate, distinct, select, group_by, summarise, keep_when = filter)



```
Set data folder
```{r}
#set data dir
input.dir <- "~/coastalvulnerability-inputs"

```

Identify coastal communities

```{r read indicators, eval=FALSE, include=FALSE}
#googlesheet with list of indicators and tables needed in analysis
googlesheets4::gs4_deauth()
locs.pesca <- googlesheets4::read_sheet("1eJXjwlHqEzSAZaTmE_XyN93fu6EI0I8igRH4AdvXOl8", sheet="locs")
indicator.index <- googlesheets4::read_sheet("1eJXjwlHqEzSAZaTmE_XyN93fu6EI0I8igRH4AdvXOl8", sheet="vars_exposure")


```


```{r extract communities}

#coordinates
crs.proj.utm <- "+proj=utm +zone=12 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +datum=NAD83"
crs.proj.wgs <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"

#Gulf of California and Yucatan Peninsula states
ents.selecc <- c("['Baja California Sur']", "['Baja California']", "['Sonora']", "['Sinaloa']", "['Nayarit']", "['Jalisco']", "['Yucatán']", "['Campeche']", "['Quintana Roo']")
ents.coast.selecc <- c("Baja California Sur", "Baja California", "Sonora", "Sinaloa", "Nayarit", "Jalisco", "Yucatán", "Campeche", "Quintana Roo")

#all coastal states
#ents.coast <- c("Baja California Sur", "Baja California", "Sonora", "Sinaloa", "Nayarit", "Jalisco", "Colima", "Michoacán de Ocampo", "Guerrero", "Oaxaca", "Chiapas", "Quintana Roo", "Yucatán", "Campeche", "Tabasco", "Veracruz de Ignacio de la Llave", "Tamaulipas")

#read county (municipio) shape and subset selected states
municipios.selecc <- sf::st_read(paste0(input.dir, "/shp_files/georef-mexico-municipality-millesime.shp")) %>% 
keep_when(sta_name %in% ents.selecc) 

#read atlantic ocean shp
atlantic.shp <- sf::st_read(paste0(input.dir,"/shp_files/atlantic_ocean.shp")) 
#read pacific ocean shp
pacific.shp <- sf::st_read(paste0(input.dir,"/shp_files/pacific_ocean.shp")) 

#read shp Mexico states
est.mex <- sf::st_read(paste0(input.dir,"/datos_INEGI_2020/dest2019gw.shp"))
estados.shp <- sf::st_read(paste0(input.dir,"/shp_files/ESTADOS.shp"))

#2020 Census data 
inegi.2020 <- readr::read_csv(paste0(input.dir,"/datos_INEGI_2020/conjunto_de_datos/conjunto_de_datos_iter_00_cpv2020.csv")) %>% 
  keep_when(LONGITUD!=0) %>% 
  keep_when(NOM_ENT %in% ents.coast.selecc) %>% 
  dplyr::rename(CVE_ENT= ENTIDAD, CVE_MUN = MUN, CVE_LOC=LOC) %>% 
  make_code()

#extract and save codes for states
ents.selecc.codes <- estados.shp %>% 
  sf::st_drop_geometry() %>% 
  keep_when(NOM_ENT %in% ents.coast.selecc)

ents.selecc.codes %>% 
readr::write_csv(paste0(input.dir,"/processed_data/edos_gcyuc.csv"))

#estados.mx <- cbind(est.2019, st_coordinates(st_centroid(est.2019)))

#select counties in selected states that are coastal
#pacific 
mun.cost.pac <- municipios.selecc %>% 
   mutate(pac_distance=sf::st_distance(., pacific.shp)) %>% 
   keep_when((as.numeric(pac_distance)) < 10000)
#atlantic
mun.cost.atl <- municipios.selecc %>% 
   mutate(atl_distance=sf::st_distance(., atlantic.shp)) %>% 
   keep_when((as.numeric(atl_distance)) < 10000)

#join counties from apcific and atlantic
mun.cost <- mun.cost.atl %>% 
  dplyr::bind_rows(mun.cost.pac)

#get codes for states and target municipalities
mun.ent.codes <- mun.cost %>% 
   sf::st_drop_geometry() %>% 
  mutate(mun_cve = gsub("\\[","",mun_code), 
         mun_cve = gsub("\\]","",mun_cve),
         mun_cve = gsub("\\'","",mun_cve)) %>% 
  mutate(mun_nam = gsub("\\[","",mun_name), 
         mun_nam = gsub("\\]","",mun_nam),
         mun_nam = gsub("\\'","",mun_nam)) %>% 
  mutate(ent_nam = gsub("\\[","",sta_name), 
         ent_nam = gsub("\\]","",ent_nam),
         ent_nam = gsub("\\'","",ent_nam)) %>% 
   mutate(ent_cve = gsub("\\[","",sta_code), 
         ent_cve = gsub("\\]","",ent_cve),
         ent_cve = gsub("\\'","",ent_cve)) %>% 
  select(mun_cve,mun_nam, ent_cve, ent_nam)

mun.ent.codes %>% readr::write_csv(paste0(input.dir,"/processed_data/","mun_ent_codes.csv"))


#get community data, output is spatial data layer
inegi.cost <- get_community_data(inegi.2020, crs.proj.utm, crs.proj.wgs, mun.cost, ents.coast.selecc)

inegi.cost.shp <- inegi.cost %>% 
  select(CVE_LOC:POBMAS)
  
sf::st_write(inegi.cost.shp, paste0(input.dir,"/processed_data/shp_files/","inegi_comm_cost.shp"), delete_layer = TRUE)


inegi.cost.buffer <-  inegi.cost %>% 
  select(CVE_ENT:POBTOT) %>% 
  sf::st_buffer(dist=10000)

sf::st_write(inegi.cost.buffer, paste0(input.dir,"/shp_files/","inegi_comm_buffer.shp"), delete_layer = TRUE)

inegi.cost.buffer.50 <-  inegi.cost %>% 
  select(CVE_ENT:POBTOT) %>% 
  sf::st_buffer(dist=50000)

sf::st_write(inegi.cost.buffer.50, paste0(input.dir,"/shp_files/","inegi_comm_buffer_50k.shp"), delete_layer = TRUE)

inegi.cost.comm <- inegi.cost %>% 
  sf::st_drop_geometry() %>% 
  select(CVE_LOC:NOM_LOC, POBTOT, deci_lon, deci_lat) %>% 
  distinct(CVE_ENT, CVE_LOC, CVE_MUN, NOM_ENT, NOM_MUN, NOM_LOC, POBTOT, deci_lon, deci_lat)

#get location codes for target locations

inegi.cost.comm %>% readr::write_csv(here::here("outputs","inegi_coast_comm.csv"))
inegi.cost.comm %>% readr::write_csv(paste0(input.dir,"/processed_data/","inegi_coast_comm.csv"))

#save full census data for selected communities

inegi.cost.pop <- inegi.cost %>% 
  sf::st_drop_geometry()

inegi.cost.pop %>% readr::write_csv(paste0(input.dir,"/processed_data/","inegi_coast_census.csv"))


sf::st_write(mun.cost, here::here("outputs","shp_files","mun_cost.shp"), delete_layer = TRUE)

#make_map(mun.cost, inegi.cost, estados.shp, crs.proj.utm, thistitle="Total population",thisoutput=here::here("outputs","figures","map_locs_en.png"))

#make_map(mun.cost, inegi.cost, estados.shp, crs.proj.utm, thistitle="Población total",thisoutput=here::here("outputs","figures","map_locs_sp.png"))


```

Download DENUE data economic units registered in Mexico by economic activity https://en.www.inegi.org.mx/app/mapa/denue/
Data updated November 2023
```{r get denue data, echo=FALSE}

inegi.comms  <-  readr::read_csv(here::here("outputs","inegi_coast_comm.csv")) 

inegi.comm.codes  <-  inegi.comms %>% 
  dplyr::pull(CVE_LOC)

denue.links= "links_DENUE_descarga_masiva_2023.csv"

unidades.denue <- readr::read_csv(paste0(input.dir,"/", denue.links))

#only run once to download, unzip files and aggregate data

#actividad.denue <- get_denue(unidades.denue, input.dir) 
#unzip_denue(input.dir)

denue.inegi <- list.files(path=paste0(input.dir,"/denue/conjunto_de_datos"), pattern="denue_inegi_*.*")
denue.inegi.full <- list.files(path=paste0(input.dir,"/denue/conjunto_de_datos"), pattern="denue_inegi_*.*", full.names = TRUE)

list.denue <- 1:length(denue.inegi.full)

lapply(list.denue, extract_denue, denue.inegi, denue.inegi.full, input.dir, inegi.comm.codes, inegi.comms)

denue.cost.comms <- list.files(path=paste0(input.dir,"/processed_data/denue"), pattern="denue_*.*", full.names = TRUE) 

denue.all <- lapply(denue.cost.comms, combine_denue)

denue.all.comm <- denue.all %>% 
  dplyr::bind_rows() %>% 
  make_code()

denue.all.comm %>% readr::write_csv(paste0(input.dir,"/processed_data/adaptive_capacity/","denue_all_ecactiv.csv"))


# remove fisheries
denue.other.act <- denue.cost.comms[!denue.cost.comms %in% c("/home/atlantis/coastalvulnerability-inputs/processed_data/denue/denue_fisheries_ecactiv.csv")]  

denue.other <- lapply(denue.other.act, combine_denue)
  
denue.other.comm <- denue.other %>% 
  dplyr::bind_rows() %>% 
  make_code()

denue.other.comm %>% readr::write_csv(paste0(input.dir,"/processed_data/adaptive_capacity/","denue_other_ecactiv.csv"))

denue.other.tot <- denue.other.comm %>% 
  group_by(CVE_MUN, CVE_LOC, NOM_ENT,NOM_MUN, NOM_LOC) %>% 
  summarise(tot_denue = sum(neg_tot))

readr::write_csv(denue.other.tot, paste0(input.dir,"/processed_data/adaptive_capacity/","denue_tot_ecactiv.csv"))

#schools and other educational resources  
denue.educa <- denue.other.comm %>% 
  keep_when(grepl("educación", nombre_act, ignore.case = TRUE) | grepl("educativos", nombre_act, ignore.case = TRUE) | grepl("Escuelas", nombre_act, ignore.case = TRUE) | grepl("Biblioteca", nombre_act, ignore.case = TRUE))
 
denue.educa.tot <- denue.educa %>% 
  mutate(activity = "education") %>% 
  group_by(CVE_MUN, CVE_LOC, activity) %>% 
  summarise(tot_eddenue = sum(neg_tot)) %>% 
  dplyr::left_join(inegi.comms, by =c("CVE_MUN", "CVE_LOC")) %>% 
  mutate(edu_pcapita = tot_eddenue/ POBTOT)

readr::write_csv(denue.educa.tot, paste0(input.dir,"/processed_data/adaptive_capacity/","denue_education_ecactiv.csv"))

#fishery and aquaculture businesses
denue.fish <- readr::read_csv("/home/atlantis/coastalvulnerability-inputs/processed_data/denue/denue_fisheries_ecactiv.csv")

denue.fish.tot <- denue.fish %>% 
  group_by(CVE_MUN, CVE_LOC) %>% 
  summarise(tot_denue = sum(neg_tot)) 

readr::write_csv(denue.fish.tot, paste0(input.dir,"/processed_data/adaptive_capacity/","denue_fishaqtot_ecactiv.csv"))

aqua.act <- c("Camaronicultura","Piscicultura y otra acuicultura, excepto camaronicultura")			

fishery.act <- c("Pesca de camarón","Pesca de sardina y anchoveta","Pesca de túnidos","Pesca y captura de peces, crustáceos, moluscos y otras especies")
				
denue.fish.num <- denue.fish %>% 
  keep_when(nombre_act %in% fishery.act) %>% 
  mutate(activity = "fisheries economic units") %>% 
  group_by(CVE_ENT, CVE_MUN, CVE_LOC, activity) %>% 
  summarise(tot_denue_fish = sum(neg_tot))  %>% 
  dplyr::left_join(inegi.comms, by =c("CVE_ENT","CVE_MUN", "CVE_LOC")) %>% 
  mutate(fish_pcapita = tot_denue_fish/ POBTOT) %>% 
  dplyr::left_join(denue.other.tot, by= c("CVE_MUN","CVE_LOC","NOM_ENT","NOM_MUN","NOM_LOC")) %>% 
  mutate(prop_uefish = tot_denue_fish / tot_denue) %>% 
  dplyr::ungroup() %>% 
  select(CVE_LOC, CVE_MUN, tot_denue_fish, fish_pcapita, prop_uefish) %>% 
  replace(is.na(.), 0) 

readr::write_csv(denue.fish.num, paste0(input.dir,"/processed_data/sensitivity/","denue_fisheries_ecactiv.csv"))

denue.aqua.num <- denue.fish %>% 
  keep_when(nombre_act %in% aqua.act) %>% 
  mutate(activity = "aquaculture economic units") %>% 
  group_by(CVE_ENT, CVE_MUN, CVE_LOC, activity) %>% 
  summarise(tot_denue_aqua = sum(neg_tot)) %>% 
  dplyr::left_join(inegi.comms, by =c("CVE_ENT","CVE_MUN", "CVE_LOC")) %>% 
  mutate(aqua_pcapita = tot_denue_aqua/ POBTOT) %>% 
  dplyr::left_join(denue.other.tot, by= c("CVE_MUN","CVE_LOC","NOM_ENT","NOM_MUN","NOM_LOC")) %>% 
  mutate(prop_ueaqua = tot_denue_aqua / tot_denue) %>% 
  dplyr::ungroup() %>% 
  select(CVE_LOC, CVE_MUN, tot_denue_aqua, aqua_pcapita, prop_ueaqua) %>% 
  replace(is.na(.), 0) 


readr::write_csv(denue.aqua.num, paste0(input.dir,"/processed_data/sensitivity/","denue_aqua_ecactiv.csv"))




```


```{r water availability}

inegi.cost.locs <- sf::st_read(paste0(input.dir,"/processed_data/shp_files/","inegi_comm_cost.shp"))
 
 inegi.cost.locs.proj <- inegi.cost.locs %>% 
   sf::st_transform(., 6367)

aquifer.avai <- sf::st_read(paste0(input.dir,"/adaptive_capacity/water_availability/","c_acuiferos_09112023.shp")) 

aquifer.avai.proj <- aquifer.avai %>% 
  sf::st_transform(., 6367)

cost.aqui <-sf::st_join(inegi.cost.locs.proj, aquifer.avai.proj, join= sf::st_within)

aqui.table <- cost.aqui %>% 
  sf::st_drop_geometry() %>% 
  tidyr::as_tibble() %>% 
  keep_when(!is.na(OBJECTID))  %>% 
  mutate(aqui_dis = dplyr::if_else(DMA_POSITI==0, DMA_NEGATI, DMA_POSITI)) %>% 
  select(CVE_LOC, CVE_MUN, aqui_dis)


readr::write_csv(aqui.table, paste0(input.dir,"/processed_data/adaptive_capacity/water_availability.csv"))



```



```{r road access}

road.data <- readxl::read_xlsx(paste0(input.dir,"/adaptive_capacity/road_access/","GACP_Grado de accesso por carretera_2018.xlsx"))

cat.tm <- road.data %>% 
  distinct(tm_centro) %>% 
  dplyr::pull(tm_centro)

cat.pav <- road.data %>% 
  distinct(dis_pav)

cat.gr <- road.data %>% 
  distinct(gr_access)

cat.dis <- road.data %>% 
  distinct(disponibilidad) %>% 
  dplyr::pull(disponibilidad)

road.table <- road.data %>% 
   mutate(tm_serv= dplyr::if_else(tm_centro=="Menos de 1 hr.", 0.5,
                                     dplyr::if_else(tm_centro=="1 a 2 hrs.", 1.5,
                                                        dplyr::if_else(tm_centro=="2 a 3 hrs.", 2.5,
                                                                                  dplyr::if_else(tm_centro=="más de 4 hrs.", 4.5,
                                                                                                 dplyr::if_else(tm_centro=="3 a 4 hrs.", 3.5, NA)))))) %>%
  mutate(deg_access= dplyr::if_else(gr_access=="Muy alto", 1,
                                     dplyr::if_else(gr_access=="Alto", 0.75,
                                                        dplyr::if_else(gr_access=="Medio", 0.5,
                                                                                  dplyr::if_else(gr_access=="Bajo", 0.25,
                                                                                                 dplyr::if_else(gr_access=="Muy bajo", 0, NA)))))) %>% 
   mutate(pav_dis= dplyr::if_else(dis_pav==">= 2,000", 2000,
                                     dplyr::if_else(dis_pav=="<= 1,000", 1000,
                                                        dplyr::if_else(dis_pav=="> 1,000 y < 2,000", 1500, NA)))) %>% 
  mutate(dis_pub = dplyr::if_else(disponibilidad==cat.dis[1], 10,
                                     dplyr::if_else(disponibilidad==cat.dis[2], 40,
                                                        dplyr::if_else(disponibilidad==cat.dis[3], 120,
                                                                                  dplyr::if_else(disponibilidad==cat.dis[4], 105,
                                                                                                 dplyr::if_else(disponibilidad==cat.dis[5], 75, NA)))))) %>%
  keep_when(!is.na(pav_dis))
  

    
road.res <- road.table %>% 
  extract_comms() %>% 
  select(CVE_LOC, CVE_MUN, tm_serv, deg_access, pav_dis, dis_pub)
 
readr::write_csv(road.res, paste0(input.dir,"/processed_data/adaptive_capacity/road_access.csv"))


#not used data was from 1985
#note that OpenStreet Map data can be obtained from R package osmdata and could update this section
#https://cran.r-project.org/web/packages/osmdata/vignettes/osmdata.html

# crs.proj.utm <- "+proj=utm +zone=12 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +datum=NAD83"
# crs.proj.wgs <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
# 
# ext.carr.proj <- sf::st_read("~/coastalvulnerability-inputs/adaptive_capacity/road_access/carre1mgw.shp") %>% 
# sf::st_transform(., 6367)
# 
# inegi.cost.locs <- sf::st_read(paste0(input.dir,"/processed_data/shp_files/","inegi_comm_cost.shp"))
# 
# inegi.cost.locs.proj <- inegi.cost.locs %>% 
#   sf::st_transform(., 6367)
# 
# length.mt <- ext.carr.proj %>% 
#   sf::st_length() %>% 
#   sf::st_drop_geometry() %>% 
#   as.numeric() %>% 
#   tidyr::as_tibble() %>% 
#   dplyr::rename(length_m=value)
# 
# ext.carr.proj.dis <- ext.carr.proj %>% 
#   dplyr::bind_cols(length.mt)
# 
# #estimate distance to any road
# 
# inegi.carr.dist <- sf::st_distance(inegi.cost.locs.proj, ext.carr.proj.dis,  by_element = FALSE)
# 
# inegi.carr.dist.m <- inegi.carr.dist %>% 
#  apply(., 1, FUN = min)%>% 
#   tidyr::as_tibble() %>% 
#   mutate(dist_km = value/1000)
# 
# dist.table <- inegi.cost.locs %>% 
#   sf::st_drop_geometry() %>% 
#   dplyr::bind_cols(inegi.carr.dist.m) %>% 
#   select(CVE_LOC, CVE_MUN, dist_km)
#   
#   
# #estimate road density within community buffer
# 
# inegi.cost.buffer.proj <- sf::st_read(paste0(input.dir,"/shp_files/","inegi_comm_buffer.shp")) %>% 
# sf::st_transform(., 6367)
# 
# carretera.loc <- sf::st_intersection(ext.carr.proj.dis, inegi.cost.buffer.proj)
# 
# length.loc <- carretera.loc %>% 
#   sf::st_length() %>% 
#   sf::st_drop_geometry() %>% 
#   as.numeric() %>% 
#   tidyr::as_tibble() %>% 
#   dplyr::rename(length_loc=value)
# 
# ext.carr.proj.loc <- carretera.loc %>% 
#   dplyr::bind_cols(length.loc)
# 
# carretera.loc.sum <- tidyr::as_tibble(ext.carr.proj.loc) %>% 
#   sf::st_drop_geometry() %>% 
#   mutate(CVE_ENT = cve_ent, CVE_MUN = cve_mun, CVE_LOC = cve_loc) %>% 
#   make_code() %>% 
#   group_by(CVE_MUN, CVE_LOC) %>% 
#   summarise(den_loc_km = (sum(length_m)/1000)) %>% 
#   replace(is.na(.), 0) 
# 
# access.res <- dist.table %>% 
#   dplyr::left_join(carretera.loc.sum, by = c("CVELOC", "CVE_MUN"))



```

Employment centers
```{r}

emp.cent <- readxl::read_xlsx("~/coastalvulnerability-inputs/adaptive_capacity/employment_centers/cct_2021.xlsx") 

inegi.table <- "inegi_coast_comm.csv"
inegi.comms <- fix_inegi(inegi.table)

inegi.comm.codes  <-  inegi.comms %>% 
  dplyr::pull(CVE_LOC)

emp.cent.code <- emp.cent %>% 
  dplyr::rename(CVE_ENT= INMUEBLE_CV_ENT, NOM_ENT = INMUEBLE_C_NOM_ENT, CVE_MUN = INMUEBLE_CV_MUN, NOM_MUN= INMUEBLE_C_NOM_MUN, NOM_LOC=INMUEBLE_C_NOM_LOC) %>% 
  keep_when(NOM_ENT!="NA") %>% 
  keep_when(CVE_LOC %in% inegi.comm.codes) %>% 
  mutate(NOM_MUN = stringi::stri_trans_general(str = NOM_MUN, id = "Latin-ASCII")) %>% 
  mutate(NOM_LOC = stringi::stri_trans_general(str = NOM_LOC, id = "Latin-ASCII")) %>% 
  make_code()
  
emp.cent.code.sum <- emp.cent.code %>% 
  mutate(id_row = 1) %>% 
  group_by(CVE_LOC, CVE_MUN) %>% 
  summarise(tot_emp = sum(id_row)) %>% 
  dplyr::left_join(inegi.comms, by= c("CVE_LOC", "CVE_MUN")) %>% 
  mutate(prop_emp = tot_emp/POBTOT) %>% 
  select(CVE_MUN, CVE_LOC, tot_emp, prop_emp) %>% 
  replace(is.na(.), 0) 

readr::write_csv(emp.cent.code.sum, paste0(input.dir,"/processed_data/adaptive_capacity/employment_centers.csv"))


```

Infrastructure indicators
```{r}

inf.ind <- readxl::read_xlsx("~/coastalvulnerability-inputs/adaptive_capacity/access_infrastructure/Base_indicadores_loc_PATP_abril_2023.xlsx") 

inegi.table <- "inegi_coast_comm.csv"
inegi.comms <- fix_inegi(inegi.table)

inegi.comm.codes  <-  inegi.comms %>% 
  dplyr::pull(CVE_LOC)

inf.ind.codes <- inf.ind %>% 
  mutate(CVE_MUN = `Clave municipio`, CVE_LOC = `Clave localidad`) %>% 
    select(CVE_MUN, CVE_LOC, r_1erN_auto, r_2doN_auto, r_3erN_auto, r_preescolar_auto, r_primaria_auto, r_secundaria_auto, r_CID) %>% 
  dplyr::rename(acc_1health=r_1erN_auto, acc_2health=r_2doN_auto, acc_3health=r_3erN_auto, acc_presc=r_preescolar_auto, acc_elem=r_primaria_auto, acc_sec = r_secundaria_auto, acc_dev=r_CID)

names.categ <- colnames(inf.ind.codes)
num.cols <- 3:length(names.categ)

new.tibble <- inf.ind.codes[,1:2]

new.inf.codes <- lapply(num.cols, add_varcategory, names.categ, inf.ind.codes)

#NAs correspond to not available values in the original table. These are mostly islands, where the corresponding centers are too far but distance was not measured, so we assigned the highest values

inf.table <- new.inf.codes %>% 
  dplyr::bind_cols(new.tibble, .) %>% 
  keep_when(CVE_LOC %in% inegi.comm.codes) %>% 
  replace(is.na(.), 0) 

inf.table.max <- inf.table %>%
  summarise(acc_1healthMax=max(acc_1health), acc_2healthMax=max(acc_2health), acc_3healthMax=max(acc_3health), acc_prescMax=max(acc_presc), acc_elemMax=max(acc_elem),
                   acc_secMax = max(acc_sec), acc_devMax=max(acc_dev))

inf.table.rev <- inf.table %>% 
  mutate(acc_1health = dplyr::if_else(acc_1health==0, inf.table.max$acc_1healthMax, acc_1health)) %>% 
  mutate(acc_2health = dplyr::if_else(acc_2health==0, inf.table.max$acc_2healthMax, acc_2health)) %>% 
  mutate(acc_3health = dplyr::if_else(acc_3health==0, inf.table.max$acc_3healthMax, acc_3health)) %>% 
  mutate(acc_presc = dplyr::if_else(acc_presc==0, inf.table.max$acc_prescMax, acc_presc)) %>% 
 mutate(acc_elem = dplyr::if_else(acc_elem==0, inf.table.max$acc_elemMax, acc_elem)) %>% 
 mutate(acc_sec = dplyr::if_else(acc_sec==0, inf.table.max$acc_secMax, acc_sec)) %>% 
 mutate(acc_dev = dplyr::if_else(acc_dev==0, inf.table.max$acc_devMax, acc_dev))


readr::write_csv(inf.table.rev, paste0(input.dir,"/processed_data/adaptive_capacity/access_infrastructure.csv"))

```

Poverty indicators and marginalization index
```{r}

inegi.table <- "inegi_coast_comm.csv"
inegi.comms <- fix_inegi(inegi.table)

inegi.comm.codes  <-  inegi.comms %>% 
  dplyr::pull(CVE_LOC)

pov.ind.1 <- readxl::read_xls("~/coastalvulnerability-inputs/adaptive_capacity/poverty_marginalization/IML_2020.xls", sheet = 2) 

pov.ind.comms.1 <- pov.ind.1 %>% 
  keep_when(CVE_LOC %in% inegi.comm.codes)

pov.ind.2 <- readxl::read_xls("~/coastalvulnerability-inputs/adaptive_capacity/poverty_marginalization/IML_2020.xls", sheet = 3) 

pov.ind.comms.2 <- pov.ind.2 %>% 
  keep_when(CVE_LOC %in% inegi.comm.codes)

pov.code <- pov.ind.comms.1 %>% 
  dplyr::bind_rows(pov.ind.comms.2) %>% 
  dplyr::rename(CVE_ENT= ENT, CVE_MUN = MUN) %>% 
  make_code()
  
pov.table <- pov.code %>% 
  select(CVE_LOC, CVE_MUN, ANALF:IM_2020)

#Social gap index

social.ind.1 <- readxl::read_xlsx("~/coastalvulnerability-inputs/adaptive_capacity/poverty_marginalization/IRS_localidades_2020.xlsx", sheet = 1) 
social.ind.2 <- readxl::read_xlsx("~/coastalvulnerability-inputs/adaptive_capacity/poverty_marginalization/IRS_localidades_2020.xlsx", sheet = 2) 

soc.ind.comms.1 <- social.ind.1 %>% 
  keep_when(cve_loc %in% inegi.comm.codes) %>% 
  dplyr::rename(CVE_LOC = cve_loc)

soc.ind.comms.2 <- social.ind.2 %>% 
  keep_when(cve_loc %in% inegi.comm.codes) %>% 
  dplyr::rename(CVE_LOC = cve_loc)

soc.code <- soc.ind.comms.1 %>% 
  dplyr::bind_rows(soc.ind.comms.2) %>% 
  make_code()

soc.table <- soc.code %>% 
  select(CVE_LOC, CVE_MUN, social_indx)

pov.res <- soc.table %>% 
  dplyr::left_join(pov.table, by = c("CVE_LOC", "CVE_MUN"))

readr::write_csv(pov.res, paste0(input.dir,"/processed_data/adaptive_capacity/poverty_indices.csv"))


```


Fisheries subsidies

```{r fisheries subsidies, echo=TRUE, message=TRUE, warning=FALSE}

inegi.table <- "inegi_coast_comm.csv"
inegi.cost.comm <- fix_inegi(inegi.table)

cost.codes.ent <- inegi.cost.comm %>%
  distinct(CVE_ENT, NOM_ENT) 

cost.codes.mun <- inegi.cost.comm %>%
  distinct(CVE_ENT, NOM_MUN, CVE_MUN) 

cost.codes.loc <- inegi.cost.comm %>%
   distinct(NOM_ENT, CVE_ENT, NOM_MUN, CVE_MUN, NOM_LOC, CVE_LOC) 
 
#googlesheet to keep track of names that need correction
googlesheets4::gs4_deauth()
locs.pesca <- googlesheets4::read_sheet("1eJXjwlHqEzSAZaTmE_XyN93fu6EI0I8igRH4AdvXOl8")

correct.ent <- locs.pesca %>% 
  select(-NOM_LOC_REV)

correct.loc <- locs.pesca %>% 
  select(-NOM_ENT_REV) %>% 
  keep_when(!is.na(NOM_LOC_REV))

#gas subsidies
gas.subsidy<- readxl::read_xlsx(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/padron_beneficiarios_combustible_2011-2019.xlsx")) %>% 
   keep_when(año>=2014) %>% 
  mutate(localidad=gsub("-"," ",localidad)) %>% 
  mutate(NOM_MUN = stringi::stri_trans_general(str = municipio, id = "Latin-ASCII")) %>% 
  mutate(NOM_MUN = stringi::stri_trans_general(str = municipio, id = "Latin-ASCII")) %>% 
  mutate(NOM_LOC = stringi::stri_trans_general(str = localidad, id = "Latin-ASCII")) %>% 
  keep_when(tipo_cobertura=="LOCALIDAD") %>% 
  extract_comms(inegi.cost.comm) %>% 
  mutate(NOM_LOC = dplyr::if_else(grepl("BAHIA TORTUGAS", unidadeconmica), "BAHIA TORTUGAS", 
                                         dplyr::if_else(grepl("SCPP EMANCIPACION SC DE RL", unidadeconmica), "BAHIA TORTUGAS", NOM_LOC)))

gas.subsidy.comms <-  gas.subsidy %>% 
  dplyr::left_join(correct.ent, by =c("NOM_LOC","NOM_ENT")) %>% 
  mutate(NOM_ENT = dplyr::if_else(!is.na(NOM_ENT_REV), NOM_ENT_REV, NOM_ENT)) %>%
  dplyr::rename(ent_old = entidad) %>% 
  dplyr::left_join(correct.loc, by =c("NOM_LOC","NOM_ENT")) %>% 
  mutate(NOM_LOC = dplyr::if_else(!is.na(NOM_LOC_REV), NOM_LOC_REV, NOM_LOC)) %>%
  dplyr::rename(mun_old = municipio, loc_old = localidad) %>% 
  select(NOM_LOC, NOM_ENT, beneficiario, monto_conapesca) %>% 
  keep_when(monto_conapesca>0)

#some states, municipalites and locations are wrong so starting from ENT
gas.subsidy.ent <- gas.subsidy.comms %>% 
  dplyr::left_join(cost.codes.ent, by=c("NOM_ENT")) %>% 
  select(CVE_ENT, dplyr::everything())

gas.subsidy.loc <- gas.subsidy.ent %>% 
   dplyr::left_join(inegi.cost.comm, by=c("CVE_ENT","NOM_LOC","NOM_ENT")) %>% 
  select(CVE_LOC, CVE_MUN, CVE_ENT, dplyr::everything())

gas.subsidy.codes <- gas.subsidy.loc %>% 
  keep_when(!is.na(CVE_LOC)) %>% 
  mutate(id_row = 1) %>% 
  group_by(CVE_LOC, CVE_MUN) %>% 
  summarise(no_bengas=sum(id_row), tot_bengas=sum(monto_conapesca)) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  mutate(bengas_perc = (tot_bengas / POBTOT)) %>% 
  select(CVE_LOC, CVE_MUN, no_bengas, bengas_perc)


#BIENPESCA

bienpesca.files <- c(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/bien_pescadores_y_acuicultores_2020.xlsx"),
                     paste0(input.dir,"/adaptive_capacity/fishery_subsidies/bienpesca_2021.xlsx"),
                     paste0(input.dir,"/adaptive_capacity/fishery_subsidies/bienpesca_2022.xlsx"),
                     paste0(input.dir,"/adaptive_capacity/fishery_subsidies/bienpesca_2023.xlsx"))

bpesca.subsidy.comms <- lapply(bienpesca.files, clean_bienpesca, inegi.cost.comm) %>% 
  dplyr::bind_rows()

bpesca.subsidy.codes <- bpesca.subsidy.comms %>% 
  extract_comms(inegi.cost.comm) %>% 
  select(-NOM_MUN, -CVE_MUN, -cve_mun) %>% 
  dplyr::left_join(inegi.cost.comm, by = c("NOM_ENT","CVE_ENT","NOM_LOC","CVE_LOC","POBTOT")) %>%  
  make_code()
 
bpesca.subsidy.res <- bpesca.subsidy.codes %>% 
  mutate(id_row = 1) %>% 
  group_by(CVE_LOC, CVE_MUN) %>% 
  summarise(no_bpesca=sum(id_row), tot_bpesca=sum(mont_tot)) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  mutate(bpesca_perc = (tot_bpesca / POBTOT)) %>% 
  select(CVE_LOC, CVE_MUN, no_bpesca, bpesca_perc)

#subsidies to aquaculture to purchase seed
seed.files <- c(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/semilla_acuicola_2021.xlsx"),
                     paste0(input.dir,"/adaptive_capacity/fishery_subsidies/semilla_acuicola_2022.xlsx"),
                     paste0(input.dir,"/adaptive_capacity/fishery_subsidies/semilla_acuicola_2023.xlsx"))

seed.subsidy.comms <- lapply(seed.files, clean_seedfiles) %>% 
  dplyr::bind_rows()

seed.subsidy.codes <- seed.subsidy.comms %>% 
   extract_comms(inegi.cost.comm) %>% 
   make_code()

seed.subsidy.res <- seed.subsidy.codes %>% 
  mutate(id_row = 1) %>% 
  group_by(CVE_LOC, CVE_MUN) %>% 
  summarise(no_seed=sum(id_row), tot_seed=sum(`MONTO FEDERAL`)) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  mutate(seed_perc = (tot_seed / POBTOT)) %>% 
  select(CVE_LOC, CVE_MUN, no_seed, seed_perc)

#subsidies to fund genetic line improvements
gen.files <- c(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/recursos_geneticos_acuicolas_2020.xlsx"),
               paste0(input.dir,"/adaptive_capacity/fishery_subsidies/lineas_geneticas_mejoradas_2021.xlsx"),
               paste0(input.dir,"/adaptive_capacity/fishery_subsidies/lineas_geneticas_mejoradas_2022.xlsx"),
               paste0(input.dir,"/adaptive_capacity/fishery_subsidies/lineas_geneticas_mejoradas_2023.xlsx"))

gen.subsidy.comms <- lapply(gen.files, clean_seedfiles) %>% 
  dplyr::bind_rows()

gen.subsidy.codes <- gen.subsidy.comms %>% 
   extract_comms(inegi.cost.comm) %>% 
   make_code()

gen.subsidy.res <- gen.subsidy.codes %>% 
  mutate(id_row = 1) %>% 
  group_by(CVE_LOC, CVE_MUN) %>% 
  summarise(no_gen=sum(id_row), tot_gen=sum(`MONTO FEDERAL`)) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  mutate(gen_perc = (tot_gen / POBTOT)) %>% 
  select(CVE_LOC, CVE_MUN, no_gen, gen_perc)


#vessel modernization

boat.subsidy<- readxl::read_xlsx(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/beneficiarios_modernizacion_barcos_2011-2019.xlsx"))

boat.subsidy.comms <- extract_comms(boat.subsidy, inegi.cost.comm)

boat.subsidy.table <- boat.subsidy.comms %>% 
  keep_when(año>=2014) %>% 
  keep_when(tipo_cobertura=="LOCAL") %>% 
  select(-cve_loc) %>% 
  mutate(id_row = 1, monto_gob_edo = as.numeric(monto_gob_edo), monto_productor = as.numeric(monto_productor), mont_tot = (monto_productor + monto_gob_edo + monto_conapesca) )%>% 
  keep_when(mont_tot!=0) %>% 
  select(-NOM_MUN) %>% 
  dplyr::left_join(inegi.cost.comm, by = c("NOM_ENT","NOM_LOC")) %>%  
  make_code() 

boat.subsidy.codes <- boat.subsidy.table %>%
  group_by(CVE_LOC, CVE_MUN) %>% 
  summarise(no_boat=sum(id_row), tot_boat=sum(mont_tot)) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  mutate(boat_perc = (tot_boat / POBTOT)) %>% 
  select(CVE_LOC, CVE_MUN, no_boat, boat_perc)

#subsidies for product commercialization
commerce.subsidy<- readxl::read_xlsx(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/beneficiarios_comercializacion_2014-2019.xlsx"))

commerce.subsidy.comms <- extract_comms(commerce.subsidy, inegi.cost.comm)

commerce.subsidy.table <- commerce.subsidy.comms %>% 
  keep_when(tipo_cobertura=="LOCAL") %>% 
  select(-cve_loc) %>% 
  mutate(mont_tot = (monto_gob_edo + monto_conapesca))%>% 
  keep_when(mont_tot!=0) %>% 
   make_code() 
  
commerce.subsidy.codes <- commerce.subsidy.table %>% 
  group_by(CVE_LOC, CVE_MUN) %>% 
  summarise(no_comm=sum(no_beneficiarios), tot_comm=sum(mont_tot)) %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  mutate(comm_perc = (tot_comm / POBTOT)) %>% 
  select(CVE_LOC, CVE_MUN, no_comm, comm_perc)


#subsidies for aquaculture
aqua.subsidy<- readxl::read_xlsx(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/beneficiarios_acuacultura_2014-2019.xlsx"))
#this file does not have project characteristics for 2019 data, that is in aquaculture_incentives_2019.xlsx

aqua.subsidy.comms <- extract_comms(aqua.subsidy, inegi.cost.comm)

aqua.subsidy.table <- aqua.subsidy.comms %>% 
  keep_when(tipo_cobertura=="LOCAL") %>% 
  mutate(id_row = 1, mont_tot = monto_conapesca)%>% 
  keep_when(mont_tot!=0) %>% 
  make_code()

aqua.subsidy.codes <- aqua.subsidy.table %>% 
  group_by(CVE_LOC, CVE_MUN) %>% 
  summarise(no_aqua=sum(id_row), tot_aqua=sum(mont_tot)) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  mutate(aqua_perc = (tot_aqua / POBTOT)) %>% 
  select(CVE_LOC, CVE_MUN, no_aqua, aqua_perc)


#subsidies to support seafood consumption
consump.subsidy<- readxl::read_xlsx(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/beneficiarios_consumo_2014-2019.xlsx"))

consump.subsidy.comms <- extract_comms(consump.subsidy, inegi.cost.comm)

consump.subsidy.table <- consump.subsidy.comms %>% 
  mutate(id_row = 1, mont_tot = monto_conapesca)%>% 
  keep_when(mont_tot!=0) %>% 
  make_code()

consump.subsidy.codes <- consump.subsidy.table %>% 
  group_by(CVE_LOC, CVE_MUN) %>% 
  summarise(no_cons=sum(id_row), tot_cons=sum(mont_tot)) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  mutate(cons_perc = (tot_cons / POBTOT)) %>% 
  select(CVE_LOC, CVE_MUN, no_cons, cons_perc)

#subsidies to support fishery value chains
value.subsidy<- readxl::read_xlsx(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/beneficiarios_cadenas_productivas_2011-2019.xlsx")) %>% 
  keep_when(año>=2014)

value.subsidy.comms <- extract_comms(value.subsidy, inegi.cost.comm)

value.subsidy.table <- value.subsidy.comms %>% 
  mutate(id_row = 1, mont_tot = monto_conapesca)%>% 
  keep_when(mont_tot!=0) %>% 
  make_code() 

value.subsidy.codes <- value.subsidy.table %>% 
  group_by(CVE_LOC, CVE_MUN) %>% 
  summarise(no_value=sum(id_row), tot_value=sum(mont_tot)) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  mutate(value_perc = (tot_value / POBTOT)) %>% 
  select(CVE_LOC, CVE_MUN, no_value, value_perc)


#subsidies to strengthen fisheries
str.subsidy<- readxl::read_xlsx(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/beneficiarios_fortalecimiento_2011-2019.xlsx")) %>% 
  keep_when(año>=2014)

str.subsidy.comms <- extract_comms(str.subsidy, inegi.cost.comm)

str.subsidy.table <- str.subsidy.comms %>% 
  mutate(id_row = 1, mont_tot = monto_conapesca)%>% 
  keep_when(mont_tot!=0) %>% 
  make_code() 

str.subsidy.codes <- str.subsidy.table %>% 
  group_by(CVE_LOC, CVE_MUN) %>% 
  summarise(no_str=sum(id_row), tot_str=sum(mont_tot)) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  mutate(str_perc = (tot_str / POBTOT)) %>% 
  select(CVE_LOC, CVE_MUN, no_str, str_perc)

#subsidies to strengthen inspection and surveillance
ins.subsidy <- readxl::read_xlsx(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/beneficiarios_vigilancia_2011-2019.xlsx")) %>% 
  keep_when(año>=2014) %>% 
  dplyr::rename(localidad = localidad_ue, municipio = municipio_ue)

ins.subsidy.comms <- extract_comms(ins.subsidy, inegi.cost.comm)

ins.subsidy.table <- ins.subsidy.comms %>% 
  mutate(id_row = 1, mont_tot = monto_conapesca)%>% 
  keep_when(mont_tot!=0) %>% 
  make_code() 

ins.subsidy.codes <- ins.subsidy.table %>% 
  group_by(CVE_LOC, CVE_MUN) %>% 
  summarise(no_ins=sum(id_row), tot_ins=sum(mont_tot)) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  mutate(ins_perc = (tot_ins / POBTOT)) %>% 
  select(CVE_LOC, CVE_MUN, no_ins, ins_perc)


#subsidies to strengthen the legal framework
leg.subsidy<- readxl::read_xlsx(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/beneficiarios_ordenamiento_2011-2019.xlsx")) %>% 
  keep_when(año>=2014) 

leg.subsidy.comms <- extract_comms(leg.subsidy, inegi.cost.comm)

leg.subsidy.table <- leg.subsidy.comms %>% 
  mutate(id_row = 1, mont_tot = monto_conapesca)%>% 
  keep_when(mont_tot!=0) %>% 
  dplyr::left_join(correct.loc, by =c("NOM_LOC","NOM_ENT")) %>% 
  mutate(NOM_LOC = dplyr::if_else(!is.na(NOM_LOC_REV), NOM_LOC_REV, NOM_LOC)) %>%
  make_code()

leg.subsidy.codes <- leg.subsidy.table %>% 
  keep_when(!is.na(CVE_LOC)) %>% 
  group_by(CVE_LOC, CVE_MUN) %>% 
  summarise(no_leg=sum(id_row), tot_leg=sum(mont_tot)) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  mutate(leg_perc = (tot_leg / POBTOT)) %>% 
  select(CVE_LOC, CVE_MUN, no_leg, leg_perc)


#subsidies to reduce effort in industrial fishing
eff.subsidy<- readxl::read_xlsx(paste0(input.dir,"/adaptive_capacity/fishery_subsidies/beneficiarios_reduccion_esfuerzo_2011-2018.xlsx")) %>% 
  keep_when(año>=2014)

eff.subsidy.comms <- extract_comms(eff.subsidy, inegi.cost.comm)

eff.subsidy.table <- eff.subsidy.comms %>% 
  mutate(id_row = 1, mont_tot = monto_conapesca)%>% 
  keep_when(mont_tot!=0) %>% 
  make_code()

eff.subsidy.codes <- eff.subsidy.table %>% 
  group_by(CVE_LOC, CVE_MUN) %>% 
  summarise(no_eff=sum(id_row), tot_eff=sum(mont_tot)) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(inegi.cost.comm, by = c("CVE_LOC","CVE_MUN")) %>% 
  mutate(eff_perc = (tot_eff / POBTOT)) %>% 
  select(CVE_LOC, CVE_MUN, no_eff, eff_perc)


all.fishery.subsidies <- inegi.cost.comm %>% 
  dplyr::left_join(bpesca.subsidy.res, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(seed.subsidy.res, by = c("CVE_LOC", "CVE_MUN")) %>%
  dplyr::left_join(gas.subsidy.codes,by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(boat.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(commerce.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(aqua.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(consump.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(value.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(str.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(ins.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(leg.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(eff.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(gen.subsidy.res, by = c("CVE_LOC", "CVE_MUN"))

fishery.tot.subs <- all.fishery.subsidies %>% 
  replace(is.na(.), 0) 

fishery.comm.subs <- fishery.tot.subs %>%
  mutate(sum = rowSums(dplyr::across(no_bpesca:gen_perc), na.rm=TRUE)) %>% 
  keep_when(sum>0)

#fishery.tot.subs %>% summarise(across(no_bpesca:gen_perc, sum)) #use to test that all columns have value

fishery.tot.subs %>% distinct(CVE_LOC)

readr::write_csv(fishery.tot.subs, paste0(input.dir,"/processed_data/adaptive_capacity/","fisheries_subsidies.csv"))

```

Extract permit information from the Registro Nacional de Pesca y Acuacultura RNPA 
https://www.gob.mx/conapesca/documentos/registro-nacional-de-pesca-y-acuacultura-rnpa

```{r get catch, echo=TRUE, message=TRUE, warning=TRUE}

#googlesheet to keep track of names that need correction
googlesheets4::gs4_deauth()
locs.pesca <- googlesheets4::read_sheet("1eJXjwlHqEzSAZaTmE_XyN93fu6EI0I8igRH4AdvXOl8")


ents.coast.selecc <- toupper(c("Baja California Sur", "Baja California", "Sonora", "Sinaloa", "Nayarit", "Jalisco", "Yucatán", "Campeche", "Quintana Roo"))
coast.selecc <- stringi::stri_trans_general(str = ents.coast.selecc, id = "Latin-ASCII")

#only communities considered in the analysis
inegi.cost.comm  <- readr::read_csv(paste0(input.dir,"/processed_data/","inegi_coast_comm.csv")) %>% 
  mutate(NOM_ENT= stringi::stri_trans_general(str = NOM_ENT, id = "Latin-ASCII"), NOM_ENT = toupper(NOM_ENT)) %>% 
  mutate(NOM_MUN = stringi::stri_trans_general(str = NOM_MUN, id = "Latin-ASCII"), NOM_MUN = toupper(NOM_MUN)) %>% 
  mutate(NOM_LOC = stringi::stri_trans_general(str = NOM_LOC, id = "Latin-ASCII"), NOM_LOC = toupper(NOM_LOC))

inegi.cost.mun <- inegi.cost.comm %>% 
  distinct(NOM_MUN, CVE_MUN)

permit.files <- list.files(path = paste0(input.dir,"/sensitivity/permit_data"), full.names = TRUE)
no.permitfiles <- 1:length(permit.files)

permit.data.inegi <- lapply(no.permitfiles, extract_permits, permit.files, inegi.cost.comm, coast.selecc, locs.pesca)

# to check location names
# permit.table <- permit.data.inegi %>% 
#   dplyr::bind_rows() %>% 
#   keep_when(!is.na(NOM_LOC)) %>% 
#   keep_when(is.na(CVE_MUN)) %>% distinct(NOM_ENT, NOM_MUN, NOM_LOC, CVE_MUN, CVE_LOC)
 
permit.table <- permit.data.inegi %>% 
  dplyr::bind_rows() %>% 
  keep_when(!is.na(CVE_LOC)) %>% 
  distinct(NOM_ENT, rnp_code, NOM_MUN, NOM_LOC, CVE_MUN, CVE_LOC,  deci_lat, deci_lon, POBTOT) %>% 
  select(-NOM_MUN) %>% 
  dplyr::left_join(inegi.cost.mun, by = "CVE_MUN")

permit.per.loc <- permit.table %>% 
  mutate(index_no = 1) %>% 
  group_by(NOM_ENT, NOM_MUN, NOM_LOC, CVE_MUN, CVE_LOC, deci_lat, deci_lon, POBTOT) %>% 
  summarise(tot_perm=sum(index_no)) %>% 
  dplyr::ungroup() %>% 
  mutate(perm_pcapita = tot_perm/POBTOT) %>% 
  select(CVE_MUN, CVE_LOC, tot_perm, perm_pcapita)

readr::write_csv(permit.per.loc, paste0(input.dir,"/processed_data/sensitivity/fishery_permits.csv"))

catch.files <- list.files(path = paste0(input.dir,"/catch"), full.names = TRUE)
no.catchfiles <- 1:length(catch.files)

#match to rnpa number

catch.rnpa <- lapply(no.catchfiles,get_rnpa_catch, catch.files, coast.selecc) 

rnpa.catch.table <- catch.rnpa %>%
  dplyr::bind_rows() %>% 
  mutate(rnp_code = as.character(rnp_code))

catch.rnpa.codes <- rnpa.catch.table %>%
  distinct(rnp_code) 

catch.permit.table <- catch.rnpa.codes %>% 
  dplyr::left_join(permit.table, by = c("rnp_code"))

catch.loc <- catch.permit.table %>% 
  dplyr::left_join(rnpa.catch.table, by = c("rnp_code")) %>% 
  select(-NOM_MUN) %>% 
  dplyr::left_join(inegi.cost.mun, by = "CVE_MUN") %>% 
  group_by(CVE_MUN, CVE_LOC, POBTOT) %>% 
  summarise(tot_catch_mt = sum(tot_weight_kg)/ 1000) %>% 
  mutate(catch_percapita = tot_catch_mt/ POBTOT) 

readr::write_csv(catch.loc, paste0(input.dir,"/processed_data/sensitivity/fishery_catch.csv"))


```



Assign catch to locations

```{r location catch, eval=FALSE, include=FALSE}

#googlesheet to keep track of names that need correction
googlesheets4::gs4_deauth()
locs.pesca <- googlesheets4::read_sheet("1eJXjwlHqEzSAZaTmE_XyN93fu6EI0I8igRH4AdvXOl8")

ents.coast.selecc <- toupper(c("Baja California Sur", "Baja California", "Sonora", "Sinaloa", "Nayarit", "Jalisco", "Yucatán", "Campeche", "Quintana Roo"))
coast.selecc <- stringi::stri_trans_general(str = ents.coast.selecc, id = "Latin-ASCII")
coast.selecc.pac <- c("BAJA CALIFORNIA SUR","BAJA CALIFORNIA","SONORA","SINALOA","NAYARIT","JALISCO")

loc.pacifico <- readxl::read_xlsx(paste0(input.dir,"/Localidades_pesqueras_Pacifico.xlsx")) %>% 
  dplyr::rename(NOM_ENT= ESTADO, NOM_LOC = LOCALIDAD_REVISADA) %>% 
  mutate(NOM_ENT= stringi::stri_trans_general(str = NOM_ENT, id = "Latin-ASCII"), NOM_ENT = toupper(NOM_ENT)) %>% 
  mutate(NOM_LOC = stringi::stri_trans_general(str = NOM_LOC, id = "Latin-ASCII"), NOM_LOC = toupper(NOM_LOC)) %>% 
  select(-LOCALIDAD_ORIGINAL, -ID) %>% 
  keep_when(NOM_ENT %in% coast.selecc.pac)

#all coastal communities, including those with no census data
inegi.cost.comm.all  <- readr::read_csv(paste0(input.dir,"/processed_data/","all_coastal_communities_INEGI.csv")) %>% 
  mutate(NOM_ENT= stringi::stri_trans_general(str = NOM_ENT, id = "Latin-ASCII"), NOM_ENT = toupper(NOM_ENT)) %>% 
  mutate(NOM_MUN = stringi::stri_trans_general(str = NOM_MUN, id = "Latin-ASCII"), NOM_MUN = toupper(NOM_MUN)) %>% 
  mutate(NOM_LOC = stringi::stri_trans_general(str = NOM_LOC, id = "Latin-ASCII"), NOM_LOC = toupper(NOM_LOC))

catch.files <- list.files(path = paste0(input.dir,"/catch"), full.names = TRUE)
no.catchfiles <- 1:length(catch.files)

catch.locations <- lapply(no.catchfiles, extract_locations, catch.files, coast.selecc, locs.pesca, inegi.cost.comm.all)
  
catch.locs.all <- catch.locations %>% 
  dplyr::bind_rows() %>% 
  distinct(NOM_ENT, NOM_LOC)

#check for duplicates
# catch.locs.inegi.all <-  catch.locs.all %>% 
#   group_by(NOM_ENT, NOM_LOC) %>%
#   mutate(dupe = dplyr::n()>1)
  
catch.locs.all %>% 
    readr::write_csv(paste0(input.dir,"/processed_data/localidades_captura_inegi.csv"))
 
  #subset locations in the pacific and match with landing sites
  catch.locs.pac <- catch.locs.all %>% 
    keep_when(NOM_ENT %in% coast.selecc.pac) %>% 
    dplyr::left_join(loc.pacifico, by = c("NOM_ENT","NOM_LOC"))
     
  #used to find duplicates https://stackoverflow.com/questions/6986657/find-duplicated-rows-based-on-2-columns-in-data-frame-in-r
  #there are multiple landing codes by location, so not using
  # catch.file.sites.table %>% 
  #   group_by(NOM_ENT, NOM_LOC) %>%
  #   mutate(dupe = dplyr::n()>1)
  # 
  
  
   
  
```


Natural protected areas

```{r}
crs.proj.utm <- "+proj=utm +zone=12 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +datum=NAD83"
crs.proj.wgs <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"

prot.area <- sf::st_read("~/coastalvulnerability-inputs/adaptive_capacity/natural_protected_areas/226_ANP_ITRF08_27022024.shp") %>% 
sf::st_transform(., 6367)

#estimate road access within community buffer

inegi.cost.buffer.proj <- sf::st_read(paste0(input.dir,"/shp_files/","inegi_comm_buffer_50k.shp")) %>% 
sf::st_transform(., 6367) 

prot.area.buff <- sf::st_intersection(prot.area, inegi.cost.buffer.proj)

area.int <- prot.area.buff %>% 
  sf::st_area() %>% 
  sf::st_drop_geometry() %>% 
  as.numeric() %>% 
  tidyr::as_tibble() %>% 
  dplyr::rename(area_loc_m2=value)

ext.area.proj.loc <- prot.area.buff %>% 
  dplyr::bind_cols(area.int)

area.loc.sum <- tidyr::as_tibble(ext.area.proj.loc) %>% 
  sf::st_drop_geometry() %>% 
  make_code() %>% 
  group_by(CVE_MUN, CVE_LOC) %>% 
  summarise(anp_area_loc_kmsq = (sum(area_loc_m2)/1e+6)) %>% 
  replace(is.na(.), 0) 


readr::write_csv(area.loc.sum, paste0(input.dir,"/processed_data/adaptive_capacity/natural_protected_area_buffer.csv"))

```

Aquaculture facilities

```{r}

inegi.cost.buffer.proj <- sf::st_read(paste0(input.dir,"/shp_files/","inegi_comm_buffer.shp")) %>% 
 sf::st_transform(., 6367) 

aquaculture.units <- sf::st_read(paste0(input.dir,"/sensitivity/aquaculture_polygons/","aquaculture_polygons_2023.shp")) 

ua.aqua.proj <- aquaculture.units %>% 
  sf::st_transform(., 6367)

#fixed geometries 
#https://github.com/r-spatial/sf/issues/870
ua.area.buff <-sf::st_intersection(sf::st_make_valid(ua.aqua.proj), inegi.cost.buffer.proj)

area.int <- ua.area.buff %>% 
  sf::st_area() %>% 
  sf::st_drop_geometry() %>% 
  as.numeric() %>% 
  tidyr::as_tibble() %>% 
  dplyr::rename(area_loc_m2=value)

ext.area.proj.loc <- ua.area.buff %>% 
  dplyr::bind_cols(area.int)

uarea.loc.sum <- tidyr::as_tibble(ext.area.proj.loc) %>% 
  sf::st_drop_geometry() %>% 
  make_code() %>% 
  group_by(CVE_MUN, CVE_LOC) %>% 
  summarise(ua_area_loc_kmsq = (sum(area_loc_m2)/1e+6)) %>% 
  replace(is.na(.), 0) 

readr::write_csv(uarea.loc.sum, paste0(input.dir,"/processed_data/sensitivity/aquaculture_units_buffer.csv"))


```


Adaptive capacity from 2020 census data

```{r}

inegi.table <- "inegi_coast_comm.csv"
inegi.comms <- fix_inegi(inegi.table)

inegi.comm.codes  <-  inegi.comms %>% 
  dplyr::pull(CVE_LOC)

inegi.data  <- readr::read_csv(paste0(input.dir,"/processed_data/","inegi_coast_census.csv"))
  
cost.data.pob <- inegi.data %>% 
  make_code() %>% 
  mutate(dplyr::across(dplyr::where(is.numeric), list(~tidyr::replace_na(., 0))))


#Infrastructure

# VPH_INTER Private dwelling with Internet
# VPH_CEL Private dwelling with cell phone
# VPH_TIC Private dwellings with information infrastructure: TOTHOG - VPH_SINTIC Private dwellings without information infrastructure
# VPH_C_SERV Private dwellings with electricity, water tubing inside or outside the home, but within the property, as well as sewer
# VPH_AEASP Private dwellings with water tubing and public water service

infra.com.in <- cost.data.pob %>% 
  dplyr::select(CVE_MUN, CVE_LOC, VPH_INTER, VPH_CEL, VPH_SINTIC, VPH_C_SERV, VPH_AEASP, TOTHOG) %>% 
  mutate(across(VPH_INTER:TOTHOG, as.numeric)) %>% 
  mutate(PVPH_INTER = VPH_INTER/ TOTHOG) %>% 
  mutate(PVPH_CEL = VPH_CEL/ TOTHOG) %>%
  mutate(PVPH_TIC = (TOTHOG - VPH_SINTIC)/TOTHOG) %>%
  mutate(PVPH_C_SERV = VPH_C_SERV/ TOTHOG) %>%
  mutate(PVPH_AEASP = VPH_AEASP/ TOTHOG) %>% 
  keep_when(!is.na(VPH_INTER)) %>% 
  select(CVE_MUN, CVE_LOC, PVPH_INTER:PVPH_AEASP) %>% 
  replace(is.na(.), 0)


# Household characteristics 
#VIVTOT Inhabited, uninhabited, and temporary-use private homes. Includes homes without occupant information
# TOTHOG Total census households, households in inhabited private homes. A household is considered in each private home. Includes single house on the land; apartment in building; housing in neighborhood; housing in a rooftop room; premises not built for habitation; mobile housing; shelter or class not specified
#OCUPVIVPAR Occupants in inhabited private homes
#PROM_OCUP Average number of occupants in inhabited private homes
#PRO_OCUP_C Average number of occupants per room in inhabited private homes

household.in <- cost.data.pob %>% 
  select(CVE_LOC, CVE_MUN, POBTOT, VIVTOT, TOTHOG, OCUPVIVPAR, PROM_OCUP, PRO_OCUP_C) %>% 
  mutate(across(POBTOT:PRO_OCUP_C, as.numeric)) %>% 
  mutate(PVIVTOT = VIVTOT/POBTOT) %>% 
  mutate(PTOTHOG = TOTHOG/POBTOT) %>% 
  mutate(POCUPVIVPAR = OCUPVIVPAR/POBTOT) %>% 
  dplyr::select(CVE_MUN, CVE_LOC, PVIVTOT, PTOTHOG, POCUPVIVPAR, PROM_OCUP, PRO_OCUP_C) %>% 
  replace(is.na(.), 0)


# Employment
# PEA Economically active population Population aged 12 years and older economically active
# POCUPADA Employed population Population aged 12 years and older employed
# GRAPROES Average level of education
# PDER_SS Population with health services Population affiliated with health services
# P18A24A Population aged 18 - 24 that attends school
# CPEA Change in the economically active population (2010-2020) Population aged 12 years and over economically active

census.2010 <- data.table::fread(paste0(input.dir,"/datos_INEGI_2010/iter_00_cpv2010/conjunto_de_datos/iter_00_cpv2010.csv")) 

census.2010.data <- census.2010 %>% 
  tidyr::as_tibble() %>% 
  keep_when(!is.na(longitud)) %>% 
  dplyr::rename(CVE_ENT=entidad, CVE_MUN = mun, CVE_LOC = loc) %>% 
  extract_comms() %>% 
  keep_when(!is.na(pobmas)) %>% 
  make_code()  
 
census.2010.emp <- census.2010.data %>% 
 select(CVE_ENT:nom_loc, pobtot, pobmas, pobfem, pea, p_12ymas, p12ym_solt, hogjef_f, psin_relig) %>% 
 select(CVE_LOC,pobtot:psin_relig)

employ.in <- cost.data.pob %>% 
  dplyr::left_join(census.2010.emp, by = "CVE_LOC") %>% 
  select(CVE_MUN, CVE_LOC, POBTOT, PEA, POCUPADA, GRAPROES, PDER_SS, P_12YMAS, P18A24A, pea, p_12ymas) %>% 
  mutate(across(PEA:P_12YMAS, as.numeric)) %>% 
  mutate(PPEA = PEA/P_12YMAS) %>% 
  mutate(PPOCUPADA = POCUPADA/P_12YMAS) %>%
  mutate(PPDER_SS = PDER_SS/POBTOT) %>% 
  mutate(PP18A24A = P18A24A/POBTOT) %>%  
  mutate(CPEA = (PEA/P_12YMAS) - (pea/p_12ymas)) %>%  
  select(CVE_MUN, CVE_LOC, PPEA, PPOCUPADA, GRAPROES, PPDER_SS, P18A24A, CPEA) %>% 
  replace(is.na(.), 0)


#Population change 
# PRESOE15 Population residing in another state Population aged 5 years and older residing in another state in March 2015		
# P12YM_SOLT Change in single population
# HOGJEF_F Change in female households Households in inhabited private homes where the reference person is a woman	
# PSIN_RELIG Population without religion or without religious affiliation People who declared that they had no religion or were not affiliated with one.
# P12YM_SEPA Population that was married and separated

census.2010.popch <- census.2010.data %>% 
 select(CVE_ENT:CVE_MUN, pobtot, pobmas, pobfem, pea, presoe05, p_5ymas, p_12ymas, p12ym_solt, hogjef_f, psin_relig, p12ym_sepa, graproes) 

dis.personal.in <- cost.data.pob %>% 
  dplyr::select(CVE_MUN, CVE_LOC, POBTOT, P_5YMAS, PRESOE15, P12YM_SOLT, P_12YMAS, HOGJEF_F, PSIN_RELIG, P12YM_SEPA, GRAPROES) %>% 
  mutate(dplyr::across(POBTOT:PSIN_RELIG, as.numeric)) %>% 
  dplyr::left_join(census.2010.popch, by=c("CVE_LOC","CVE_MUN")) %>% 
  mutate(CPRESOE15 = (PRESOE15/P_5YMAS) - (presoe05/p_5ymas)) %>% 
  mutate(CP12YM_SOLT = (P12YM_SOLT/P_12YMAS) - (p12ym_solt/p_12ymas)) %>% 
  mutate(CHOGJEF_F = (HOGJEF_F/POBTOT) - (hogjef_f/pobtot)) %>% 
  mutate(CPSIN_RELIG = (PSIN_RELIG/POBTOT) - (psin_relig/pobtot)) %>% 
  mutate(CP12YM_SEPA = (P12YM_SEPA/P_12YMAS) - (p12ym_sepa/p_12ymas)) %>% 
  mutate(CGRAPROES = GRAPROES - graproes) %>% 
  dplyr::select(CVE_MUN, CVE_LOC, CPRESOE15, CP12YM_SOLT, CHOGJEF_F, CPSIN_RELIG, CP12YM_SEPA, CGRAPROES) %>% 
  replace(is.na(.), 0)
 
#Community characteristics
#HOGJEF_F Households in inhabited private homes where the reference person is a woman
#PCON_DISC People who have great difficulty performing or carrying out tasks in daily life
#PROM_HNV Average number of daughters and sons born alive
#GRAPROES_F Average level of education of the female population
#P_15YMAS Population aged 15 years and over
#P12YM_SEPA Population that was married and separated
#P6A11_NOA Population from 6 to 11 years old that does not attend school

comm.char.in <- cost.data.pob %>% 
  dplyr::left_join(census.2010.emp, by = "CVE_LOC") %>% 
  select(CVE_MUN, CVE_LOC, POBTOT, TOTHOG, HOGJEF_F, P_6A11, P_12YMAS, P12YM_SEPA, P_15YMAS, PCON_DISC, P_60YMAS, GRAPROES_F, PROM_HNV, P6A11_NOA) %>% 
  mutate(across(TOTHOG:P6A11_NOA, as.numeric)) %>% 
  mutate(PHOGJEF_F = HOGJEF_F/TOTHOG) %>% 
  mutate(PPCON_DISC = PCON_DISC/POBTOT) %>%
  mutate(PP_60YMAS = P_60YMAS/POBTOT) %>% 
  mutate(PP_15YMAS = P_15YMAS/POBTOT) %>%  
  mutate(PP12YM_SEPA = P12YM_SEPA/P_12YMAS) %>% 
  mutate(PP6A11_NOA = P6A11_NOA/P_6A11) %>% 
  select(CVE_MUN, CVE_LOC, PHOGJEF_F, PPCON_DISC, PROM_HNV, GRAPROES_F, PP_60YMAS, PP_15YMAS, PP12YM_SEPA, PP6A11_NOA) %>% 
  replace(is.na(.), 0)

adap.census <- comm.char.in %>% 
  dplyr::left_join(dis.personal.in, by =c("CVE_MUN","CVE_LOC")) %>% 
  dplyr::left_join(employ.in, by =c("CVE_MUN","CVE_LOC")) %>% 
  dplyr::left_join(household.in, by =c("CVE_MUN","CVE_LOC")) %>% 
  dplyr::left_join(infra.com.in, by =c("CVE_MUN","CVE_LOC"))

readr::write_csv(adap.census, paste0(input.dir,"/processed_data/adaptive_capacity/","census_adaptive_capacity.csv"))



```



WorldClim terrestrial historical and future data

```{r worldclim, eval=FALSE, include=FALSE}

#mkdir ~/coastalvulnerability-inputs/exposure/worldclim
#cd ~/coastalvulnerability-inputs/exposure/worldclim
#wget https://biogeo.ucdavis.edu/data/worldclim/v2.1/base/wc2.1_30s_bio.zip
#wget https://geodata.ucdavis.edu/cmip6/30s/MPI-ESM1-2-HR/ssp126/wc2.1_30s_bioc_MPI-ESM1-2-HR_ssp126_2041-2060.tif
#wget https://geodata.ucdavis.edu/cmip6/30s/MPI-ESM1-2-HR/ssp585/wc2.1_30s_bioc_MPI-ESM1-2-HR_ssp585_2041-2060.tif

#see https://oceanhealthindex.org/news/raster_to_terra/

mexico.shp <- sf::st_read(paste0(input.dir,"/shp_files/mexico_contdv250kg.shp")) %>% 
  sf::st_transform(., 4326) 

extent.disp <- terra::ext(mexico.shp)
r.template <- terra::rast(resolution = c(0.008333333, 0.008333333), ext = extent.disp)

#projections
scenario.names <- c("ssp126", "ssp585")
file.names <- c("wc2.1_30s_bioc_MPI-ESM1-2-HR_ssp126_2041-2060.tif", "wc2.1_30s_bioc_MPI-ESM1-2-HR_ssp585_2041-2060.tif")
                
var.names <- tolower(c("Annual_Mean_Temp","Mean_Diurnal_Range","Max_Temp_Warm_Month","Min_Temp_Cold_Month","Ann_Precip","Precip_Wettest_Month","Precip_Driest_Month"))

layer.nums <- c(1,2,5,6,12,13,14)

sc.length <- 1:length(scenario.names)

this.path <- paste0(input.dir,"/exposure/cond_terrestrial")
dir.create(this.path)

lapply(sc.length, get_worldclim, scenario.names, file.names, var.names, layer.nums, input.dir, r.template)

var.names <- tolower(c("Annual_Mean_Temp","Mean_Diurnal_Range","Max_Temp_Warm_Month","Min_Temp_Cold_Month","Ann_Precip","Precip_Wettest_Month","Precip_Driest_Month"))
layer.nums <- c(1,2,5,6,12,13,14)

file.names <- paste0("wc2.1_30s_bio_",layer.nums,".tif")
file.length <- 1:length(file.names)


lapply(file.length, get_worldclim_historical, file.names, var.names, input.dir, r.template)

    
# variable list is here https://www.worldclim.org/data/bioclim.html
# BIO1 = Annual Mean Temperature
# BIO2 = Mean Diurnal Range (Mean of monthly (max temp - min temp))
# BIO5 = Max Temperature of Warmest Month
# BIO6 = Min Temperature of Coldest Month
# BIO12 = Annual Precipitation
# BIO13 = Precipitation of Wettest Month
# BIO14 = Precipitation of Driest Month



```

BioOracle future marine data

```{r}

```



Exposure data
```{r exposure_data, include=FALSE}

crs.proj.wgs <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"

googlesheets4::gs4_deauth()
vars.expo <- googlesheets4::read_sheet("1eJXjwlHqEzSAZaTmE_XyN93fu6EI0I8igRH4AdvXOl8", sheet="vars_exposure")

cost.data.pob <- readr::read_csv(paste0(input.dir,"/processed_data/","inegi_coast_comm.csv"))

mexico.shp <- sf::st_read(paste0(input.dir,"/shp_files/mexico_contdv250kg.shp")) %>% 
  sf::st_transform(., 4326) 

extent.disp <- terra::ext(mexico.shp)
r.template <- terra::rast(resolution = c(0.008333333, 0.008333333), ext = extent.disp)

#estados de la Republica
#est.2019 <- st_read(here("inputs","datos_INEGI_2020","dest2019gw.shp"))

inegi.cost.buffer.50 <- sf::st_read(paste0(input.dir,"/shp_files/","inegi_comm_buffer_50k.shp")) %>% 
 sf::st_transform(., 4326) 

#shapefile community points
#inegi.cost.wgs <- st_read("~/vulnerabilidadbid/outputs/shp_files/comunidades_costeras_30km.shp") %>% 
#  dplyr::select(COM_ID,ENTIDAD,NOM_ENT,MUN,NOM_MUN,LOC,NOM_LOC, POBTOT) %>% st_set_crs(crs.proj.wgs) 

#get states names
tabla.edos <- readr::read_csv(paste0(input.dir,"/processed_data/","edos_gcyuc.csv"))

#expo.num <- 29:30
expo.num <- 1:nrow(vars.expo)

lapply(expo.num, extract_raster, vars.expo, inegi.cost.buffer.50, cost.data.pob, r.template, crs.proj.wgs)



```

Copy processed data to input directory
```{r}

file.copy(paste0(input.dir,"/processed_data"), here::here("data-raw"), recursive=TRUE)
#file.copy(paste0(input.dir, "/processed_data/exposure"), here::here("data-raw/processed_data"), recursive=TRUE)


```

