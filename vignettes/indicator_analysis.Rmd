---
title: "Indicator analysis"
output: html_notebook
---

Set environment

```{r}
#rebuild and load the package
devtools::load_all() # restarts and loads

# List of packages for session
.packages = c("import")

# Install CRAN packages (if not already installed)
.inst <- .packages %in% installed.packages()
if(length(.packages[!.inst]) > 0) install.packages(.packages[!.inst])

# Load packages into session 
#lapply(.packages, require, character.only=TRUE)

#specifies what functions to import
# https://cran.r-project.org/web/packages/import/vignettes/import.html
import::from(dplyr, mutate, distinct, select, group_by, summarise, keep_when = filter)



```
Set data folder
```{r}
#set data dir
input.dir <- "~/coastalvulnerability/data-raw/processed_data"

```

read indicator table
```{r read indicators, eval=FALSE, include=FALSE}
#googlesheet with list of indicators
googlesheets4::gs4_deauth()

indicator.index <- googlesheets4::read_sheet("1yaA-tGQGDU7sz5ZYt61D9IaLI4L2G8r3LIeaA3jf8vw", sheet="indicators")


```

Combine sensitivity indices and standarize
```{r}

cost.data.pob <- readr::read_csv(here::here("data-raw", "processed_data","inegi_coast_comm.csv"))


indicator.list <- list.files(path=here::here("data-raw","processed_data","sensitivity"), pattern = "*.csv", full.names = TRUE)

sens.data <- merge_files(indicator.list, cost.data.pob)

#replace NAs by O's
#normalize 0-1

sens.indicators <- sens.data %>% 
  replace(is.na(.), 0) %>% 
  mutate(sum = rowSums(dplyr::across(ua_area_loc_kmsq:catch_percapita), na.rm=TRUE)) %>% 
  keep_when(sum>0)
  

sens.ind.data <- sens.indicators %>% 
  select(ua_area_loc_kmsq:catch_percapita) %>% 
  as.data.frame() 

  for(eachcol in 1:ncols(sensd.ind.data)){
    
    this.col <- sens.ind.data %>% 
      select(eachcol)
    
    this.col.sc <- caret::preProcess(this.col, method=c("range"))
  caret::preProcess(., method=c("range"))
  
  }
#sens.matrix <- sens.indicators %>% 
#  select(ua_area_loc_kmsq:catch_percapita) %>% 
#  as.matrix()

#com.names <- sens.indicators %>% 
#  dplyr::pull(NOM_LOC)

#rownames(sens.matrix) <- com.names

#example_NMDS <- vegan::metaMDS(sens.matrix, # Our community-by-species matrix
#                     k=2)
  
```


Combine exposure files

```{r}
cost.data.pob <- readr::read_csv(here::here("data-raw", "processed_data","inegi_coast_comm.csv"))


indicator.list <- list.files(path=here::here("data-raw","processed_data","exposure"), pattern = "*.csv", full.names = TRUE)

sens.data <- merge_files(indicator.list, cost.data.pob)

#replace NAs by O's
#normalize 0-1
sens.indicators <- sens.data %>% 
  replace(is.na(.), 0) %>% 
  mutate(sum = rowSums(dplyr::across(ua_area_loc_kmsq:catch_percapita), na.rm=TRUE)) %>% 
  keep_when(sum>0)
```

