---
title: "Indicator analysis"
output: html_notebook
---

Set environment

```{r}
#rebuild and load the package
devtools::load_all() # restarts and loads

# List of packages for session
.packages = c("import")

# Install CRAN packages (if not already installed)
.inst <- .packages %in% installed.packages()
if(length(.packages[!.inst]) > 0) install.packages(.packages[!.inst])

# Load packages into session 
#lapply(.packages, require, character.only=TRUE)

#specifies what functions to import
# https://cran.r-project.org/web/packages/import/vignettes/import.html
import::from(dplyr, mutate, distinct, select, group_by, summarise, keep_when = filter)



```
Set data folder
```{r}
#set data dir
input.dir <- "~/coastalvulnerability/data-raw/processed_data"

```

read indicator table
```{r read indicators, eval=FALSE, include=FALSE}
#https://www.namehero.com/blog/solve-temporary-failure-in-name-resolution-error-in-linux/
#googlesheet with list of indicators
googlesheets4::gs4_deauth()

indicator.index <- googlesheets4::read_sheet("1yaA-tGQGDU7sz5ZYt61D9IaLI4L2G8r3LIeaA3jf8vw", sheet="indicators_english")


```

Combine indices and select only communities with sensitivity > 0
```{r}

cost.data.comms <- readr::read_csv(here::here("data-raw", "processed_data","inegi_coast_comm.csv"))

cost.data.pob <- cost.data.comms
sens.indicator.list <- list.files(path=here::here("data-raw","processed_data","sensitivity"), pattern = "*.csv", full.names = TRUE)

sens.indicator.name  <- "sensitivity"
sens.data <- merge_files(indicator.list = sens.indicator.list, cost.data.pob, indicator.name= sens.indicator.name)


exp.indicator.list <- list.files(path=here::here("data-raw","processed_data","exposure"), pattern = "*.csv", full.names = TRUE) 

exp.indicator.name  <- "exposure"

exp.data <- merge_files(indicator.list = exp.indicator.list, cost.data.pob, indicator.name = exp.indicator.name)


adap.indicator.list <- list.files(path=here::here("data-raw","processed_data","adaptive_capacity"), pattern = "*.csv", full.names = TRUE) 

adap.indicator.name  <- "adaptive capacity"

adap.data <- merge_files(indicator.list = adap.indicator.list, cost.data.pob, indicator.name = adap.indicator.name)


#sens.matrix <- sens.indicators %>% 
#  select(ua_area_loc_kmsq:catch_percapita) %>% 
#  as.matrix()

#com.names <- sens.indicators %>% 
#  dplyr::pull(NOM_LOC)

#rownames(sens.matrix) <- com.names

#example_NMDS <- vegan::metaMDS(sens.matrix, # Our community-by-species matrix
#                     k=2)
  
```


Standarize indicators and get directionality

```{r}

cost.data.comms <- readr::read_csv(here::here("data-raw", "processed_data","inegi_coast_comm.csv"))

#read combined data by component
sensitivity.data <- readr::read_csv(here::here("data-raw", "tot_sensitivity.csv"))
exp.hist.data <- readr::read_csv(here::here("data-raw", "tot_exposure_historical.csv"))
exp.ssp126.data <- readr::read_csv(here::here("data-raw", "tot_exposure_ssp126.csv"))
exp.ssp585.data <- readr::read_csv(here::here("data-raw", "tot_exposure_ssp585.csv"))
adaptive.data <- readr::read_csv(here::here("data-raw", "tot_adaptive capacity.csv"))

#get directionality
sens.long.data <- get_directionality(sensitivity.data, indicator.name = "sensitivity")
exp.hist.long.data <- get_directionality(exp.hist.data, indicator.name = "exposure_historical")
exp.ssp126.long.data <- get_directionality(exp.ssp126.data, indicator.name = "exposure_ssp126")
exp.ssp585.long.data <- get_directionality(exp.ssp585.data, indicator.name = "exposure_ssp585")
adap.long.data <- get_directionality(adaptive.data, indicator.name = "adaptive_capacity")

#correct values by directionality and scale variables 0-1 by state
#counties with # or fewer communities will keep state-scaled values
sc.sensitivity.data <- scale_var_state(sens.long.data, cost.data.comms, indicator.name = "sensitivity")
sc.exp.hist.data <- scale_var_state(exp.hist.long.data, cost.data.comms, indicator.name = "exposure_historical")
sc.exp.ssp126.data <- scale_var_state(exp.ssp126.long.data, cost.data.comms, indicator.name = "exposure_ssp126")
sc.exp.ssp585.data <- scale_var_state(exp.ssp585.long.data, cost.data.comms, indicator.name = "exposure_ssp585")
sc.adaptive.data <- scale_var_state(adap.long.data, cost.data.comms, indicator.name = "adaptive_capacity")

sc.mun.sensitivity.data <- scale_var_mun(sc.sensitivity.data, indicator.name = "sensitivity")
sc.mun.exp.hist.data <- scale_var_mun(sc.exp.hist.data, indicator.name = "exposure_historical")
sc.mun.exp.ssp126.data <- scale_var_mun(sc.exp.ssp126.data, indicator.name = "exposure_ssp126")
sc.mun.exp.ssp585.data <- scale_var_mun(sc.exp.ssp585.data, indicator.name = "exposure_ssp585")
sc.mun.adaptive.data <- scale_var_mun(sc.adaptive.data, indicator.name = "adaptive_capacity")



cost.data.comms <- readr::read_csv(here::here("data-raw", "processed_data","inegi_coast_comm.csv"))

#scale variables 0-1 by state
sc.adaptive.data <- scale_var(adaptive.data, cost.data.comms, indicator.name = "adaptive_capacity")
sc.exp.hist.data <- scale_var(exp.hist.data, indicator.name = "exposure_historical")
sc.exp.ssp126.data <- scale_var(exp.ssp126.data, indicator.name = "exposure_ssp126")
sc.exp.ssp585.data <- scale_var(exp.ssp585.data, indicator.name = "exposure_ssp585")
sc.sensitivity.data <- scale_var(sensitivity.data, indicator.name = "sensitivity")

#check all columns have values
#sc.sensitivity.data %>% 
#  summarise(across(3:14, sum))

#determine municipalities with only one fishery-dependent community, these will not be included in the analysis

single.mun.coms <- sc.sensitivity.data %>% 
  mutate(index = 1) %>% 
  dplyr::group_by(CVE_MUN) %>% 
  dplyr::summarise(sum_loc = sum(index)) %>% 
  keep_when(sum_loc==1 | sum_loc==2 | sum_loc==3) %>% 
  dplyr::left_join(sc.sensitivity.data, by=c("CVE_MUN")) %>% 
  select(CVE_MUN, CVE_LOC) %>% 
  dplyr::left_join(cost.data.comms, by=c("CVE_LOC", "CVE_MUN"))
  
readr::write_csv(single.mun.coms,here::here("outputs","analysis","single_mun_comms.csv"))

single.codes <- single.mun.coms %>% 
  dplyr::distinct(CVE_LOC) %>% 
  dplyr::pull(CVE_LOC)
#assign directionality


readr::write_csv(sens.long.data, here::here("outputs","analysis","sens_long_data.csv"))
readr::write_csv(exp.hist.long.data, here::here("outputs","analysis","exp_hist_data.csv"))
readr::write_csv(exp.ssp126.long.data, here::here("outputs","analysis","exp_ssp126_long_data.csv"))
readr::write_csv(exp.ssp585.long.data, here::here("outputs","analysis","exp_ssp585_long_data.csv"))
readr::write_csv(adap.long.data, here::here("outputs","analysis","adap_long_data.csv"))




```



```{r}

sens.long.data <- readr::read_csv(here::here("outputs","analysis","sens_long_data.csv"))
exp.hist.long.data <- readr::read_csv(here::here("outputs","analysis","exp_hist_data.csv"))
exp.ssp126.long.data <- readr::read_csv(here::here("outputs","analysis","exp_ssp126_long_data.csv"))
exp.ssp585.long.data <- readr::read_csv(here::here("outputs","analysis","exp_ssp585_long_data.csv"))
adap.long.data <- readr::read_csv(here::here("outputs","analysis","adap_long_data.csv"))

pca_factor(sc.sensitivity.data, indicator.name = "sensitivity")
pca_factor(sc.adaptive.data, indicator.name = "adaptive_capacity")


tot.comp.data <- dplyr::bind_rows(sens.long.data, exp.hist.long.data, adap.long.data) %>% 
  dplyr::left_join(cost.data.comms, by= c("CVE_LOC", "CVE_MUN"))



ent.ord <- c("Baja California","Baja California Sur","Sonora","Sinaloa","Nayarit","Jalisco", "Campeche", "Quintana Roo","Yucatán" )           

vul.res.ord <-  tot.comp.data %>% 
  mutate(NOM_ENT_fac=factor(NOM_ENT, levels=ent.ord)) %>% # This trick update the factor levels
  mutate(category_fac=factor(category, levels=c("Alta","Mediana","Baja")))   # This trick update the factor levels

cols <- c("firebrick","gold","forestgreen")

pointplot.vulne <- vul.res.ord %>% 
  ggplot()+
  geom_point(aes(y= susceptibilidad, x=adaptacion, color=delta_expo_norm)) +
  facet_wrap(~ NOM_ENT_fac) +
  #scale_colour_gradientn(colours= cols) +
  scale_color_gradient(low=cols[2],high=cols[1]) +
  theme_light() +
  labs(x = "Capacidad de adaptación",
       y="Susceptibilidad",
       title = paste("Escenario",escenario.nom),
       color = "Exposición") +
  annotate("text",x = 0.3, y = 0.9, label = "Alta \n vulnerabilidad", color = "slategrey",size = 2.2) +
  annotate("text",x = 0.7, y = 0.1, label = "Baja \n vulnerabilidad", color = "slategrey",size = 2.2) +
  scale_x_reverse()


ggsave(here("outputs","figures",paste0(escenario.nom,"_ejes_vulnerabilidad_ent.png")), pointplot.vulne, device="png", width = 10, height = 8)



# plot_components <- function(sens.data, exp.data, adap.data){
#   
#   
#   
# }
# 
# #match to indicator categories to do analysis per category
# #also introduce PCA per county
# 
# pca_factor(sc.adaptive.data, indicator.name = "adaptive_capacity")
# pca_factor(sc.exp.hist.data, indicator.name = "exposure_historical")
# pca_factor(sc.exp.ssp126.data, indicator.name = "exposure_ssp126")
# pca_factor(sc.exp.ssp585.data, indicator.name = "exposure_ssp585")
# pca_factor(sc.sensitivity.data, indicator.name = "sensitivity")
# 
# adap.pca <- read_csv(here("outputs","analysis","factor_scores_adaptive_capacity.csv")) %>% 
#   mutate(PC1 = scales::rescale(PC1, to = c(0, 1)))
# 
# exp.hist.pca <- read_csv(here("outputs","analysis","factor_scores_exposure_historical.csv")) %>% 
#   mutate(PC1 = scales::rescale(PC1, to = c(0, 1)))
# 
# exp.hist.pca <- read_csv(here("outputs","analysis","factor_scores_exposure_historical.csv")) %>% 
#   mutate(PC1 = scales::rescale(PC1, to = c(0, 1)))
# 
# exp.hist.pca <- read_csv(here("outputs","analysis","factor_scores_exposure_historical.csv")) %>% 
#   mutate(PC1 = scales::rescale(PC1, to = c(0, 1)))
# 
# susc.pca <- read_csv(here("outputs","analysis","factor_scores_sensitivity.csv")) %>% 
#   mutate(PC1 = scales::rescale(PC1, to = c(0, 1)))

```

