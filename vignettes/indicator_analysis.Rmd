---
title: "Indicator analysis"
output: html_notebook
---

Set environment

```{r}
#rebuild and load the package
devtools::load_all() # restarts and loads

# List of packages for session
.packages = c("import")

# Install CRAN packages (if not already installed)
.inst <- .packages %in% installed.packages()
if(length(.packages[!.inst]) > 0) install.packages(.packages[!.inst])

# Load packages into session 
#lapply(.packages, require, character.only=TRUE)

#specifies what functions to import
# https://cran.r-project.org/web/packages/import/vignettes/import.html
import::from(dplyr, mutate, distinct, select, group_by, summarise, keep_when = filter)



```
Set data folder
```{r}
#set data dir
input.dir <- "~/coastalvulnerability/data-raw/processed_data"

```

read indicator table
```{r read indicators, eval=FALSE, include=FALSE}
#googlesheet with list of indicators
googlesheets4::gs4_deauth()

indicator.index <- googlesheets4::read_sheet("1yaA-tGQGDU7sz5ZYt61D9IaLI4L2G8r3LIeaA3jf8vw", sheet="indicators")


```

Combine indices and select only communities with sensitivity > 0
```{r}

cost.data.comms <- readr::read_csv(here::here("data-raw", "processed_data","inegi_coast_comm.csv"))

cost.data.pob <- cost.data.comms
sens.indicator.list <- list.files(path=here::here("data-raw","processed_data","sensitivity"), pattern = "*.csv", full.names = TRUE)

sens.indicator.name  <- "sensitivity"
sens.data <- merge_files(indicator.list = sens.indicator.list, cost.data.pob, indicator.name= sens.indicator.name)


exp.indicator.list <- list.files(path=here::here("data-raw","processed_data","exposure"), pattern = "*.csv", full.names = TRUE) 

exp.indicator.name  <- "exposure"

exp.data <- merge_files(indicator.list = exp.indicator.list, cost.data.pob, indicator.name = exp.indicator.name)


adap.indicator.list <- list.files(path=here::here("data-raw","processed_data","adaptive_capacity"), pattern = "*.csv", full.names = TRUE) 

adap.indicator.name  <- "adaptive capacity"

adap.data <- merge_files(indicator.list = adap.indicator.list, cost.data.pob, indicator.name = adap.indicator.name)


#sens.matrix <- sens.indicators %>% 
#  select(ua_area_loc_kmsq:catch_percapita) %>% 
#  as.matrix()

#com.names <- sens.indicators %>% 
#  dplyr::pull(NOM_LOC)

#rownames(sens.matrix) <- com.names

#example_NMDS <- vegan::metaMDS(sens.matrix, # Our community-by-species matrix
#                     k=2)
  
```


Combine exposure files

```{r}
cost.data.pob <- readr::read_csv(here::here("data-raw", "processed_data","inegi_coast_comm.csv"))


indicator.list <- list.files(path=here::here("data-raw","processed_data","exposure"), pattern = "*.csv", full.names = TRUE)

sens.data <- merge_files(indicator.list, cost.data.pob)

#replace NAs by O's
#normalize 0-1
sens.indicators <- sens.data %>% 
  replace(is.na(.), 0) %>% 
  mutate(sum = rowSums(dplyr::across(ua_area_loc_kmsq:catch_percapita), na.rm=TRUE)) %>% 
  keep_when(sum>0)
```

