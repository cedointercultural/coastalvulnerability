---
title: "Indicator analysis"
output: html_notebook
---

Set environment

```{r}
#rebuild and load the package
devtools::load_all() # restarts and loads

# List of packages for session
.packages = c("import")

# Install CRAN packages (if not already installed)
.inst <- .packages %in% installed.packages()
if(length(.packages[!.inst]) > 0) install.packages(.packages[!.inst])

# Load packages into session 
#lapply(.packages, require, character.only=TRUE)

#specifies what functions to import
# https://cran.r-project.org/web/packages/import/vignettes/import.html
import::from(dplyr, mutate, distinct, select, group_by, summarise, keep_when = filter)



```
Set data folder
```{r}
#set data dir
input.dir <- "~/coastalvulnerability/data-raw/processed_data"

```

read indicator table
```{r read indicators, eval=FALSE, include=FALSE}
#https://www.namehero.com/blog/solve-temporary-failure-in-name-resolution-error-in-linux/
#googlesheet with list of indicators
googlesheets4::gs4_deauth()

indicator.index <- googlesheets4::read_sheet("1yaA-tGQGDU7sz5ZYt61D9IaLI4L2G8r3LIeaA3jf8vw", sheet="indicators_english")


```

Combine indices and select only communities with sensitivity > 0
```{r combine_indices, include=FALSE}

cost.data.comms <- readr::read_csv(here::here("data-raw", "processed_data","inegi_coast_comm.csv"))

cost.data.pob <- cost.data.comms
sens.indicator.list <- list.files(path=here::here("data-raw","processed_data","sensitivity"), pattern = "*.csv", full.names = TRUE)

sens.indicator.name  <- "sensitivity"
sens.data <- merge_files(indicator.list = sens.indicator.list, cost.data.pob, indicator.name= sens.indicator.name)


exp.indicator.list <- list.files(path=here::here("data-raw","processed_data","exposure"), pattern = "*.csv", full.names = TRUE) 

exp.indicator.name  <- "exposure"

exp.data <- merge_files(indicator.list = exp.indicator.list, cost.data.pob, indicator.name = exp.indicator.name)


adap.indicator.list <- list.files(path=here::here("data-raw","processed_data","adaptive_capacity"), pattern = "*.csv", full.names = TRUE) 

adap.indicator.name  <- "adaptive capacity"

adap.data <- merge_files(indicator.list = adap.indicator.list, cost.data.pob, indicator.name = adap.indicator.name)


#sens.matrix <- sens.indicators %>% 
#  select(ua_area_loc_kmsq:catch_percapita) %>% 
#  as.matrix()

#com.names <- sens.indicators %>% 
#  dplyr::pull(NOM_LOC)

#rownames(sens.matrix) <- com.names

#example_NMDS <- vegan::metaMDS(sens.matrix, # Our community-by-species matrix
#                     k=2)
  
```


Get directionality and standarize indicators

```{r}

cost.data.comms <- readr::read_csv(here::here("data-raw", "processed_data","inegi_coast_comm.csv"))

#read combined data by component
sensitivity.data <- readr::read_csv(here::here("data-raw", "tot_sensitivity.csv"))
exp.hist.data <- readr::read_csv(here::here("data-raw", "tot_exposure_historical.csv"))
exp.ssp126.data <- readr::read_csv(here::here("data-raw", "tot_exposure_ssp126.csv"))
exp.ssp585.data <- readr::read_csv(here::here("data-raw", "tot_exposure_ssp585.csv"))
adaptive.data <- readr::read_csv(here::here("data-raw", "tot_adaptive capacity.csv"))

#determine municipalities with <3 fishery-dependent communities

single.mun.coms <- sensitivity.data %>% 
  mutate(index = 1) %>% 
  dplyr::group_by(CVE_MUN) %>% 
  dplyr::summarise(sum_loc = sum(index)) %>% 
  keep_when(sum_loc==1 | sum_loc==2) %>% 
  dplyr::pull(CVE_MUN)
  
#get directionality
#googlesheet with list of indicators
googlesheets4::gs4_deauth()
indicator.index <- googlesheets4::read_sheet("1yaA-tGQGDU7sz5ZYt61D9IaLI4L2G8r3LIeaA3jf8vw", sheet="indicators_english")

sens.long.data <- get_directionality(sensitivity.data, indicator.index, indicator.name = "sensitivity")
exp.hist.long.data <- get_directionality(exp.hist.data, indicator.index, indicator.name = "exposure_historical")
exp.ssp126.long.data <- get_directionality(exp.ssp126.data, indicator.index, indicator.name = "exposure_ssp126")
exp.ssp585.long.data <- get_directionality(exp.ssp585.data, indicator.index, indicator.name = "exposure_ssp585")
adap.long.data <- get_directionality(adaptive.data, indicator.index, indicator.name = "adaptive_capacity")

#correct values by directionality and scale variables 0-1 by state
#counties with 2 or fewer communities will keep state-scaled values
sc.sensitivity.data <- scale_var_state(sens.long.data, cost.data.comms, single.mun.coms, indicator.name = "sensitivity")
sc.exp.hist.data <- scale_var_state(exp.hist.long.data, cost.data.comms, single.mun.coms, indicator.name = "exposure_historical")
sc.exp.ssp126.data <- scale_var_state(exp.ssp126.long.data, cost.data.comms, single.mun.coms, indicator.name = "exposure_ssp126")
sc.exp.ssp585.data <- scale_var_state(exp.ssp585.long.data, cost.data.comms, single.mun.coms, indicator.name = "exposure_ssp585")
sc.adaptive.data <- scale_var_state(adap.long.data, cost.data.comms, single.mun.coms, indicator.name = "adaptive_capacity")

#correct values by directionality and scale variables 0-1 by municipality
#counties with 3 or more communities will use municipality values
sc.mun.sensitivity.data <- scale_var_mun(sens.long.data, cost.data.comms, single.mun.coms, indicator.name = "sensitivity")
sc.mun.exp.hist.data <- scale_var_mun(exp.hist.long.data, cost.data.comms, single.mun.coms, indicator.name = "exposure_historical")
sc.mun.exp.ssp126.data <- scale_var_mun(exp.ssp126.long.data, cost.data.comms, single.mun.coms, indicator.name = "exposure_ssp126")
sc.mun.exp.ssp585.data <- scale_var_mun(exp.ssp585.long.data, cost.data.comms, single.mun.coms, indicator.name = "exposure_ssp585")
sc.mun.adaptive.data <- scale_var_mun(adap.long.data, cost.data.comms, single.mun.coms, indicator.name = "adaptive_capacity")

#combine data scaled at the state level and municipality and calculate component scores 
sens.scaled.in <- get_comp_score(this.ent.data=sc.sensitivity.data, this.mun.data=sc.mun.sensitivity.data, indicator.name = "sensitivity")
exp.hist.scaled.in <- get_comp_score(this.ent.data=sc.exp.hist.data, this.mun.data=sc.mun.exp.hist.data, indicator.name = "exposure_historical")
exp.ssp126.scaled.in <- get_comp_score(this.ent.data=sc.exp.ssp126.data, this.mun.data=sc.mun.exp.ssp126.data, indicator.name = "exposure_ssp126")
exp.ssp585.scaled.in <- get_comp_score(this.ent.data=sc.exp.ssp585.data, this.mun.data=sc.mun.exp.ssp585.data, indicator.name = "exposure_ssp585")
adap.scaled.in <- get_comp_score(this.ent.data=sc.adaptive.data, this.mun.data=sc.mun.adaptive.data, indicator.name = "adaptive_capacity")


```


#plot components
```{r}

cost.data.comms <- readr::read_csv(here::here("data-raw", "processed_data","inegi_coast_comm.csv"))

ent.ord <- c("Baja California","Baja California Sur","Sonora","Sinaloa","Nayarit","Jalisco", "Campeche", "Quintana Roo","YucatÃ¡n" )           

cols <- c("#071952","#67C6E3")

tot.scores.comp.hist <- get_comp_data(indicator.name.sens="sensitivity", indicator.name.exp= "exposure_historical", indicator.name.adap= "adaptive_capacity", cost.data.comms)
tot.scores.comp.ssp126 <- get_comp_data(indicator.name.sens="sensitivity", indicator.name.exp= "exposure_ssp126", indicator.name.adap= "adaptive_capacity", cost.data.comms)
tot.scores.comp.ssp585 <- get_comp_data(indicator.name.sens="sensitivity", indicator.name.exp= "exposure_ssp585", indicator.name.adap= "adaptive_capacity", cost.data.comms)


plot.st.hist <- plot_comps(tot.scores.comp.hist, cost.data.comms, scenario.name="exposure_historical", cols, ent.ord, title.txt = "Condiciones actuales")
plot.st.ssp126 <- plot_comps(tot.scores.comp.ssp126, cost.data.comms, scenario.name="exposure_ssp126", cols, ent.ord, title.txt = "Escenario ssp126")
plot.st.ssp585 <- plot_comps(tot.scores.comp.ssp585, cost.data.comms, scenario.name="exposure_ssp585", cols, ent.ord, title.txt = "Escenario ssp585")

#CONTINUE HERE FIX THIS FUNCTION

plot.st.ssp126 <- plot_change(tot.scores.change.ssp126, cost.data.comms, scenario.name="exposure_ssp126_change", cols, ent.ord, title.txt = "Cambio escenario ssp126")


plot.st.hist
plot.st.ssp126
plot.st.ssp585

#summary statistics
#communites by state

 tot.locs.cost <- cost.data.comms %>% mutate(index = 1) %>% 
   group_by(NOM_ENT) %>% 
   dplyr::summarise(tot_ent = sum(index)) 
 
 tot.locs.dep <- tot.scores.comp.hist %>% 
   distinct(CVE_LOC,NOM_ENT) %>% 
   mutate(index = 1) %>% 
   group_by(NOM_ENT) %>% 
   dplyr::summarise(tot_dep = sum(index)) %>% 
   dplyr::left_join(tot.locs.cost, by = "NOM_ENT") %>% 
   mutate(per_loc = (tot_dep/tot_ent)*100)
 
tot.byent.high <- tot.scores.comp.hist %>% 
   mutate(index = 1) %>% 
   keep_when(component=="sensitivity") %>% 
   keep_when(tot_score>0.6666667) %>% 
   mutate(index = 1) %>% 
   group_by(NOM_ENT) %>% 
   dplyr::summarise(tot_score = sum(index))

tot.byent.low <- tot.scores.comp.hist %>% 
   mutate(index = 1) %>% 
   keep_when(component=="sensitivity") %>% 
   keep_when(tot_score<0.333333) %>% 
   mutate(index = 1) %>% 
   group_by(NOM_ENT) %>% 
   dplyr::summarise(tot_score = sum(index))

```

