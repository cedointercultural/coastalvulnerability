---
title: "Coastal vulnerability"

output:
  html_document

knit: (function(input, encoding) {
    rmarkdown::render(
      input = input,
      encoding = encoding,
      envir = globalenv()
    )
  })
---

Identify coastal communities

```{r}
#rebuild and load the package
devtools::load_all() # restarts and loads

```
```{r}
#set data dir
input.dir <- "~/coastalvulnerability-inputs"

```


```{r eval=FALSE, include=FALSE}
sheetlink = "https://docs.google.com/spreadsheets/d/1j9GJKPjKgpf4w3bDeS2c8uamN8-L79I1BINjpQe0lCk/edit#gid=1817952998"
# 
tabla.susc <- read_googlesheet(sheetlink, sheetname = "resumen_indicadores_susceptibilidad", coltypes = "cccccccccccccccccccc")
tabla.susc <- read_googlesheet(sheetlink, sheetname = "resumen_indicadores_exposicion", coltypes = "cccccccccccccccccccc")


for(i in 1:nrow(tabla.susc)){
  
  this.susc <- tabla.susc[i,]
  
}

```



```{r extract communities}

#coordinates
crs.proj.utm <- "+proj=utm +zone=12 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +datum=NAD83"
crs.proj.wgs <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"

#Gulf of California and Yucatan Peninsula states
ents.selecc <- c("['Baja California Sur']", "['Baja California']", "['Sonora']", "['Sinaloa']", "['Nayarit']", "['Jalisco']", "['Yucatán']", "['Campeche']", "['Quintana Roo']")
ents.coast.selecc <- c("Baja California Sur", "Baja California", "Sonora", "Sinaloa", "Nayarit", "Jalisco", "Yucatán", "Campeche", "Quintana Roo")

#all coastal states
#ents.coast <- c("Baja California Sur", "Baja California", "Sonora", "Sinaloa", "Nayarit", "Jalisco", "Colima", "Michoacán de Ocampo", "Guerrero", "Oaxaca", "Chiapas", "Quintana Roo", "Yucatán", "Campeche", "Tabasco", "Veracruz de Ignacio de la Llave", "Tamaulipas")

#read county (municipio) shape and subset selected states
municipios.selecc <- sf::st_read(paste0(input.dir, "/shp_files/georef-mexico-municipality-millesime.shp")) %>% 
dplyr::filter(sta_name %in% ents.selecc) 

#read atlantic ocean shp
atlantic.shp <- sf::st_read(paste0(input.dir,"/shp_files/atlantic_ocean.shp")) 
#read pacific ocean shp
pacific.shp <- sf::st_read(paste0(input.dir,"/shp_files/pacific_ocean.shp")) 

#read shp Mexico states
est.mex <- sf::st_read(paste0(input.dir,"/datos_INEGI_2020/dest2019gw.shp"))
estados.shp <- sf::st_read(paste0(input.dir,"/shp_files/ESTADOS.shp"))

#2020 Census data 
inegi.2020 <- readr::read_csv(paste0(input.dir,"/datos_INEGI_2020/conjunto_de_datos/conjunto_de_datos_iter_00_cpv2020.csv")) %>% 
  dplyr::filter(LONGITUD!=0) %>% 
  dplyr::filter(NOM_ENT %in% ents.coast.selecc)


#extract and save codes for states
ents.selecc.codes <- estados.shp %>% 
  sf::st_drop_geometry() %>% 
  dplyr::filter(NOM_ENT %in% ents.coast.selecc)

ents.selecc.codes %>% 
readr::write_csv(paste0(input.dir,"/procesados/edos_gcyuc.csv"))

#estados.mx <- cbind(est.2019, st_coordinates(st_centroid(est.2019)))

#select counties in selected states that are coastal
#pacific 
mun.cost.pac <- municipios.selecc %>% 
   dplyr::mutate(pac_distance=sf::st_distance(., pacific.shp)) %>% 
   dplyr::filter((as.numeric(pac_distance)) < 5000)
#atlantic
mun.cost.atl <- municipios.selecc %>% 
   dplyr::mutate(atl_distance=sf::st_distance(., atlantic.shp)) %>% 
   dplyr::filter((as.numeric(atl_distance)) < 5000)

#join counties from apcific and atlantic
mun.cost <- mun.cost.atl %>% 
  dplyr::bind_rows(mun.cost.pac)

#get codes for states and target municipalities
mun.ent.codes <- mun.cost %>% 
   sf::st_drop_geometry() %>% 
  dplyr::mutate(mun_cve = gsub("\\[","",mun_code), 
         mun_cve = gsub("\\]","",mun_cve),
         mun_cve = gsub("\\'","",mun_cve)) %>% 
  dplyr::mutate(mun_nam = gsub("\\[","",mun_name), 
         mun_nam = gsub("\\]","",mun_nam),
         mun_nam = gsub("\\'","",mun_nam)) %>% 
  dplyr::mutate(ent_nam = gsub("\\[","",sta_name), 
         ent_nam = gsub("\\]","",ent_nam),
         ent_nam = gsub("\\'","",ent_nam)) %>% 
   dplyr::mutate(ent_cve = gsub("\\[","",sta_name), 
         ent_cve = gsub("\\]","",ent_cve),
         ent_cve = gsub("\\'","",ent_cve)) %>% 
  dplyr::select(mun_cve,mun_nam, ent_cve, ent_nam)

mun.ent.codes %>% readr::write_csv(paste0(input.dir,"/procesados/","mun_ent_codes.csv"))


#get community data, output is spatial data layer
inegi.cost <- get_community_data(inegi.2020, crs.proj.utm, crs.proj.wgs, mun.cost, ents.coast.selecc)

inegi.cost.comm <- inegi.cost %>% 
  sf::st_drop_geometry() %>% 
  dplyr::distinct(NOM_ENT,ENTIDAD,NOM_MUN,MUN,NOM_LOC, LOC, CVE_MUN, CVE_LOC,COM_ID) 

#get location codes for target locations

inegi.cost.comm %>% readr::write_csv(here::here("outputs","inegi_coast_comm.csv"))
inegi.cost.comm %>% readr::write_csv(paste0(input.dir,"/procesados/","inegi_coast_comm.csv"))

sf::st_write(mun.cost, here::here("outputs","shp_files","mun_cost.shp"), delete_layer = TRUE)

make_map(mun.cost, inegi.cost, estados.shp, crs.proj.utm, thistitle="Total population",thisoutput=here::here("outputs","figures","map_locs_en.png"))

make_map(mun.cost, inegi.cost, estados.shp, crs.proj.utm, thistitle="Población total",thisoutput=here::here("outputs","figures","map_locs_sp.png"))


```

Descarga masiva de datos DENUE, Unidades economicas para todo el pais por tipo de actividad economica
Datos actualizados a Noviembre 2022
```{r get denue data}

inegi.comm.codes  <-  readr::read_csv(here::here("outputs","inegi_coast_comm.csv")) %>% 
  dplyr::pull(CVE_LOC)

denue.links= "links_DENUE_descarga_masiva_2023.csv"

unidades.denue <- readr::read_csv(paste0(input.dir,"/", denue.links))

#only run once to download and unzip files
#actividad.denue <- get_denue(unidades.denue, input.dir) 
#unzip_denue(input.dir)

denue.inegi <- list.files(path=paste0(input.dir,"/denue/conjunto_de_datos"), pattern="denue_inegi_*.*")
denue.inegi.full <- list.files(path=paste0(input.dir,"/denue/conjunto_de_datos"), pattern="denue_inegi_*.*", full.names = TRUE)

list.denue <- 1:length(denue.inegi)

lapply(list.denue, extract_denue, denue.inegi, denue.inegi.full, input.dir, inegi.comm.codes)

denue.cost.comms <- list.files(path=paste0(input.dir,"/procesados/denue"), pattern="denue_*.*", full.names = TRUE) 

# remove fisheries
denue.other.act <- denue.cost.comms[!denue.cost.comms %in% c("/home/atlantis/coastalvulnerability-inputs/procesados/denue/denue_fisheries_coms_cost.csv")]  

denue.other <- lapply(denue.other.act, combine_denue)
  
denue.other.comm <- denue.other %>% 
  dplyr::bind_rows()

denue.other.comm %>% readr::write_csv(paste0(input.dir,"/procesados/capacidad_adaptativa/","denue_other_ecactiv.csv"))

denue.other.comm %>% 
  dplyr::group_by(CVE_MUN, CVE_LOC, COM_ID) %>% 
  dplyr::summarise(tot_denue = sum(neg_tot)) %>% 
  readr::write_csv(paste0(input.dir,"/procesados/capacidad_adaptativa/","denue_tot_ecactiv.csv"))


```


```{r road access}

crs.proj.utm <- "+proj=utm +zone=12 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +datum=NAD83"
crs.proj.wgs <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"

ext.carr.proj <- sf::st_read("~/coastalvulnerability-inputs/Capacidad_adaptativa/Acceso_por_carretera/carre1mgw.shp") %>% 
sf::st_transform(., 6367)

length.mt <- ext.carr.proj %>% 
  sf::st_length() %>% 
  sf::st_drop_geometry() %>% 
  as.numeric() %>% 
  tidyr::as_tibble() %>% 
  dplyr::rename(length_m=value)

ext.carr.proj.dis <- ext.carr.proj %>% 
  dplyr::bind_cols(length.mt)

municipios.proj <- sf::st_read(here::here("outputs","shp_files","mun_cost.shp")) %>% 
sf::st_transform(., 6367)

#carretera.mun <- sf::st_join(ext.carr.proj.dis, municipios.proj, join = sf::st_within)

carretera.mun <- sf::st_intersection(ext.carr.proj.dis, municipios.proj)

carretera.mun %>% 
  dplyr::group_by(mun_nam)

length.mun <- carretera.mun %>% 
  sf::st_length() %>% 
  sf::st_drop_geometry() %>% 
  as.numeric() %>% 
  tidyr::as_tibble() %>% 
  dplyr::rename(length_mun=value)

ext.carr.proj.mun <- carretera.mun %>% 
  dplyr::bind_cols(length.mun)


carretera.mun.sum <- tidyr::as_tibble(ext.carr.proj.mun) %>% 
  sf::st_drop_geometry() %>% 
  dplyr::mutate(mun_cve = gsub("\\[","",mun_cod), 
         mun_cve = gsub("\\]","",mun_cve),
         mun_cve = gsub("\\'","",mun_cve)) %>% 
  dplyr::group_by(mun_cve) %>% 
  dplyr::summarise(tot_length_mun_km = (sum(length_m)/1000)) %>% 
  dplyr::rename(CVE_MUN=mun_cve)


readr::write_csv(carretera.mun.sum, paste0(input.dir,"/procesados/capacidad_adaptativa/longitud_carretera_mun.csv"))
```


```{r acceso a la informacion}

neg.educa <- data.table::fread("~/coastalvulnerability-inputs/Capacidad_adaptativa/Acceso_a_la_informacion/denue_inegi_61_.csv")

neg.educa.mun <- make_code(neg.educa)
  
neg.educa.mun.sum <- neg.educa.mun %>% 
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(est_educa = sum(id_row))
  
readr::write_csv(neg.educa.mun.sum, "~/coastalvulnerability-inputs/procesados/capacidad_adaptativa/establecimientos_edu_mun.csv")

```

```{r water capture and sewage}

mun.ent.codes <- readr::read_csv(paste0(input.dir,"/procesados/","mun_ent_codes.csv"))

#water storage capacity
captacion.agua <- readxl::read_xlsx(paste0(input.dir,"/Capacidad_adaptativa/Agua_potable_saneamiento/m5_cngmd_2015_captacion_drenaje.xlsx"), sheet = "puntos_captacion") %>% 
  dplyr::rename(ent_nam = entidad, mun_nam = municipio) %>% 
  dplyr::mutate(ent_nam = stringr::str_trim(ent_nam), mun_nam = stringr::str_trim(mun_nam))

capt.agua.mun <- mun.ent.codes %>% 
  dplyr::left_join(captacion.agua, by =c("ent_nam", "mun_nam")) %>% 
  dplyr::rename(CVE_MUN = mun_cve) %>% 
  dplyr::select(CVE_MUN, Pozo, Río, Presa, `Galería filtrante`, Manantial, `Canal o dren`, Cenote, Otra, ND) %>% 
  tidyr::pivot_longer(cols=Pozo:ND, names_to="captacion") %>% 
  dplyr::group_by(CVE_MUN) %>% 
  dplyr::mutate(value = as.numeric(value), value = dplyr::if_else(is.na(value),0,value)) %>% 
  dplyr::summarise(tot_captacion=sum(value))

descarga.drenaje <- readxl::read_xlsx(paste0(input.dir,"/Capacidad_adaptativa/Agua_potable_saneamiento/m5_cngmd_2015_captacion_drenaje.xlsx"), sheet = "puntos_descarga") %>% 
  dplyr::rename(ent_nam = entidad, mun_nam = municipio) %>% 
  dplyr::mutate(ent_nam = stringr::str_trim(ent_nam), mun_nam = stringr::str_trim(mun_nam)) 

desc.agua.mun <- mun.ent.codes %>% 
  dplyr::left_join(descarga.drenaje, by =c("ent_nam", "mun_nam")) %>% 
  dplyr::rename(CVE_MUN = mun_cve) %>% 
  dplyr::select(CVE_MUN, mar, `lago o laguna`, `rio o arroyo`, presa, `canal o dren`, `suelo o barranca` ,`gran colector`,otro,ND) %>% 
  tidyr::pivot_longer(cols=mar:ND, names_to="drenaje") %>% 
  dplyr::mutate(value = as.numeric(value), value = dplyr::if_else(is.na(value),0,value)) %>% 
  dplyr::group_by(CVE_MUN) %>% 
  dplyr::summarise(tot_drenaje=sum(value))

desc.capt.agua <- dplyr::left_join(desc.agua.mun, capt.agua.mun, by="CVE_MUN")

readr::write_csv(desc.capt.agua,paste0(input.dir,"/procesados/capacidad_adaptativa/drenaje_captacion_agua.csv"))

```
```{r fisheries subsidies}

inegi.cost.comm  <- readr::read_csv(paste0(input.dir,"/procesados/","inegi_coast_comm.csv")) %>% 
  dplyr::mutate(NOM_MUN = stringi::stri_trans_general(str = NOM_MUN, id = "Latin-ASCII")) %>% 
  dplyr::mutate(NOM_LOC = stringi::stri_trans_general(str = NOM_LOC, id = "Latin-ASCII"))

cost.codes.mun <- inegi.cost.comm %>%
  dplyr::mutate(entidad=toupper(NOM_ENT)) %>%
  dplyr::mutate(municipio=toupper(NOM_MUN)) %>%
  dplyr::rename(cve_mun= MUN) %>%
  dplyr::distinct(entidad, municipio, cve_mun) %>% 
  dplyr::mutate(municipio = stringi::stri_trans_general(str = municipio, id = "Latin-ASCII"))

cost.codes.loc <- inegi.cost.comm %>%
  dplyr::mutate(entidad=toupper(NOM_ENT)) %>%
  dplyr::mutate(municipio=toupper(NOM_MUN)) %>%
  dplyr::mutate(localidad=toupper(NOM_LOC)) %>%
  dplyr::rename(cve_loc= LOC) %>%
  dplyr::distinct(entidad, municipio, cve_loc, localidad)

#gas subsidies
gas.subsidy<- readxl::read_xlsx(paste0(input.dir,"/Capacidad_adaptativa/Subsidios_pesqueros/padron_beneficiarios_combustible_2011-2019.xlsx")) %>% 
  dplyr::mutate(cve_ent = as.numeric(cve_ent), cve_mun = as.numeric(cve_mun), cve_loc = as.numeric(cve_loc)) %>% 
  dplyr::mutate(entidad = dplyr::if_else(municipio=="HUATABAMPO", "SONORA", 
                                         dplyr::if_else(municipio=="ENSENADA", "BAJA CALIFORNIA",
                                                        dplyr::if_else(municipio=="CABORCA","SONORA", entidad)))) %>% 
  dplyr::mutate(municipio=dplyr::if_else(localidad=="MORONCARIT","HUATABAMPO",municipio)) %>%
  dplyr::mutate(localidad=gsub("-"," ",localidad)) %>% 
  dplyr::mutate(municipio = stringi::stri_trans_general(str = municipio, id = "Latin-ASCII")) %>% 
  dplyr::mutate(localidad = stringi::stri_trans_general(str = localidad, id = "Latin-ASCII"))

gas.subsidy.comms <- extract_comms(gas.subsidy)

#add municipality and location to rows missing info

missing.cve.mun <- gas.subsidy.comms %>% 
  dplyr::filter(is.na(cve_mun)) %>% 
  dplyr::select(-cve_mun) %>% 
  dplyr::left_join(cost.codes.mun, by=c("entidad","municipio"))

gas.subsidy.mun <- gas.subsidy.comms %>% 
  dplyr::filter(!is.na(cve_mun)) %>% 
  dplyr::bind_rows(missing.cve.mun)

missing.cve.loc <- gas.subsidy.mun %>% 
  dplyr::filter(is.na(cve_loc) & localidad!="NA") %>% 
  dplyr::select(-cve_loc) %>% 
  dplyr::left_join(cost.codes.loc, by=c("entidad","municipio","localidad"))

gas.subsidy.loc <- gas.subsidy.mun %>% 
  dplyr::filter(!is.na(cve_loc) | localidad=="NA") %>% 
  dplyr::bind_rows(missing.cve.loc) %>% 
  dplyr::filter(!is.na(cve_loc))

gas.subsidy.codes <- gas.subsidy.loc %>% 
  dplyr::filter(año>=2014) %>% 
  make_code() %>% 
  dplyr::mutate(id_row = 1) %>% 
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(no_bengas=sum(id_row), tot_bengas=sum(monto_conapesca)) %>% 
  dplyr::mutate(mont_gas = (tot_bengas / no_bengas)) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(CVE_LOC, CVE_MUN, mont_gas)


#BIENPESCA

bpesca.subsidy <- readxl::read_xlsx(paste0(input.dir,"/Capacidad_adaptativa/Subsidios_pesqueros/padron_BIENPESCA_2019.xlsx")) %>% 
  dplyr::select(`RECURSO FEDERAL APORTADO`,`RECURSO ESTATAL APORTADO`, `CLAVE MUNICIPIO`, cve_inegi, `NOMBRE ESTADO`, `NOMBRE MUNICIPIO`) %>% 
  dplyr::mutate(id_row = 1, mont_tot = `RECURSO FEDERAL APORTADO` + `RECURSO ESTATAL APORTADO`, CVE_MUN = `CLAVE MUNICIPIO`, entidad = `NOMBRE ESTADO`, municipio = `NOMBRE MUNICIPIO` ) %>% 
  dplyr::select(mont_tot,id_row, CVE_MUN, cve_inegi, entidad, municipio)

bpesca.subsidy2 <- readxl::read_xlsx(paste0(input.dir,"/Capacidad_adaptativa/Subsidios_pesqueros/beneficiarios_PROPESCA_BIENPESCA_2014-2018.xlsx")) %>% 
  dplyr::select(monto_conapesca,monto_gob_edo, cve_mun, cve_inegi, entidad, municipio) %>% 
  dplyr::mutate(id_row = 1, mont_tot = monto_conapesca + monto_gob_edo, CVE_MUN = cve_mun) %>% 
  dplyr::select(mont_tot,id_row, CVE_MUN, cve_inegi, entidad, municipio)

bpesca.subsidy.comms <- dplyr::bind_rows(bpesca.subsidy, bpesca.subsidy2) %>% 
  extract_comms()

bpesca.subsidy.codes <- bpesca.subsidy.comms %>% 
  dplyr::rename(CVE_LOC = cve_inegi) %>% 
  dplyr::filter(mont_tot!=0) %>% 
  make_code() %>% 
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(no_bpesca=sum(id_row), tot_bpesca=sum(mont_tot)) %>% 
  dplyr::mutate(mont_bpesca = (tot_bpesca / no_bpesca)) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(CVE_LOC, CVE_MUN, no_bpesca)


#vessel modernization

boat.subsidy<- readxl::read_xlsx(paste0(input.dir,"/Capacidad_adaptativa/Subsidios_pesqueros/beneficiarios_modernizacion_barcos_2011-2019.xlsx"))

boat.subsidy.comms <- extract_comms(boat.subsidy)

boat.subsidy.codes <- boat.subsidy.comms %>% 
  dplyr::filter(año>=2014) %>% 
  dplyr::filter(tipo_cobertura=="LOCAL") %>% 
  dplyr::rename(CVE_LOC = cve_inegi, CVE_MUN = cve_mun) %>% 
  dplyr::select(-cve_loc) %>% 
  dplyr::mutate(id_row = 1, monto_gob_edo = as.numeric(monto_gob_edo), monto_productor = as.numeric(monto_productor), mont_tot = (monto_productor + monto_gob_edo + monto_conapesca) )%>% 
  dplyr::filter(mont_tot!=0) %>% 
  make_code() %>%
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(no_boat=sum(id_row), tot_boat=sum(mont_tot)) %>% 
  dplyr::mutate(mont_boat = (tot_boat / no_boat)) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(CVE_LOC, CVE_MUN, mont_boat)


#subsidies for product commercialization
commerce.subsidy<- readxl::read_xlsx(paste0(input.dir,"/Capacidad_adaptativa/Subsidios_pesqueros/beneficiarios_comercializacion_2014-2019.xlsx"))

commerce.subsidy.comms <- extract_comms(commerce.subsidy)

commerce.subsidy.codes <- commerce.subsidy.comms %>% 
  dplyr::filter(tipo_cobertura=="LOCAL") %>% 
  dplyr::rename(CVE_LOC = cve_inegi, CVE_MUN = cve_mun) %>% 
  dplyr::select(-cve_loc) %>% 
  dplyr::mutate(mont_tot = (monto_gob_edo + monto_conapesca))%>% 
  dplyr::filter(mont_tot!=0) %>% 
  make_code() %>%
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(no_comm=sum(no_beneficiarios), tot_comm=sum(mont_tot)) %>% 
  dplyr::mutate(mont_comm = (tot_comm / no_comm)) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(CVE_LOC, CVE_MUN, mont_comm)

#subsidies for aquaculture
aqua.subsidy<- readxl::read_xlsx(paste0(input.dir,"/Capacidad_adaptativa/Subsidios_pesqueros/beneficiarios_acuacultura_2014-2019.xlsx"))

aqua.subsidy.comms <- extract_comms(aqua.subsidy)

aqua.subsidy.codes <- aqua.subsidy.comms %>% 
  dplyr::filter(tipo_cobertura=="LOCAL") %>% 
  dplyr::rename(CVE_LOC = cve_inegi, CVE_MUN = cve_mun) %>% 
  dplyr::select(-cve_loc) %>% 
  dplyr::mutate(id_row = 1, mont_tot = monto_conapesca)%>% 
  dplyr::filter(mont_tot!=0) %>% 
  make_code() %>%
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(no_aqua=sum(id_row), tot_aqua=sum(mont_tot)) %>% 
  dplyr::mutate(mont_aqua = (tot_aqua / no_aqua)) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(CVE_LOC, CVE_MUN, mont_aqua)

#subsidies for aquaculture
aqua.subsidy<- readxl::read_xlsx(paste0(input.dir,"/Capacidad_adaptativa/Subsidios_pesqueros/beneficiarios_acuacultura_2014-2019.xlsx"))

aqua.subsidy.comms <- extract_comms(aqua.subsidy)

aqua.subsidy.codes <- aqua.subsidy.comms %>% 
  dplyr::filter(tipo_cobertura=="LOCAL") %>% 
  dplyr::rename(CVE_LOC = cve_inegi, CVE_MUN = cve_mun) %>% 
  dplyr::select(-cve_loc) %>% 
  dplyr::mutate(id_row = 1, mont_tot = monto_conapesca)%>% 
  dplyr::filter(mont_tot!=0) %>% 
  make_code() %>%
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(no_aqua=sum(id_row), tot_aqua=sum(mont_tot)) %>% 
  dplyr::mutate(mont_aqua = (tot_aqua / no_aqua)) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(CVE_LOC, CVE_MUN, mont_aqua)


#subsidies to support seafood consumption
consump.subsidy<- readxl::read_xlsx(paste0(input.dir,"/Capacidad_adaptativa/Subsidios_pesqueros/beneficiarios_consumo_2014-2019.xlsx"))

consump.subsidy.comms <- extract_comms(consump.subsidy)

consump.subsidy.codes <- consump.subsidy.comms %>% 
  dplyr::filter(cve_inegi!="NA") %>% 
  dplyr::rename(CVE_LOC = cve_inegi, CVE_MUN = cve_mun) %>% 
  dplyr::select(-cve_loc) %>% 
  dplyr::mutate(id_row = 1, mont_tot = monto_conapesca)%>% 
  dplyr::filter(mont_tot!=0) %>% 
  make_code() %>%
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(no_cons=sum(id_row), tot_cons=sum(mont_tot)) %>% 
  dplyr::mutate(mont_cons = (tot_cons / no_cons)) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(CVE_LOC, CVE_MUN, mont_cons)

#subsidies to support fishery value chains
value.subsidy<- readxl::read_xlsx(paste0(input.dir,"/Capacidad_adaptativa/Subsidios_pesqueros/beneficiarios_cadenas_productivas_2011-2019.xlsx")) %>% 
  dplyr::filter(año>=2014)

value.subsidy.comms <- extract_comms(value.subsidy)

value.subsidy.codes <- value.subsidy.comms %>% 
  dplyr::rename(CVE_LOC = cve_inegi, CVE_MUN = cve_mun) %>% 
  dplyr::select(-cve_loc) %>% 
  dplyr::mutate(id_row = 1, mont_tot = monto_conapesca)%>% 
  dplyr::filter(mont_tot!=0) %>% 
  make_code() %>%
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(no_value=sum(id_row), tot_value=sum(mont_tot)) %>% 
  dplyr::mutate(mont_value = (tot_value / no_value)) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(CVE_LOC, CVE_MUN, mont_value)

#subsidies to strengthen fisheries
str.subsidy<- readxl::read_xlsx(paste0(input.dir,"/Capacidad_adaptativa/Subsidios_pesqueros/beneficiarios_fortalecimiento_2011-2019.xlsx")) %>% 
  dplyr::filter(año>=2014)

str.subsidy.comms <- extract_comms(str.subsidy)

str.subsidy.codes <- str.subsidy.comms %>% 
  dplyr::rename(CVE_LOC = cve_inegi, CVE_MUN = cve_mun) %>% 
  dplyr::select(-cve_loc) %>% 
  dplyr::mutate(id_row = 1, mont_tot = monto_conapesca)%>% 
  dplyr::filter(mont_tot!=0) %>% 
  make_code() %>%
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(no_str=sum(id_row), tot_str=sum(mont_tot)) %>% 
  dplyr::mutate(mont_str = (tot_str / no_str)) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(CVE_LOC, CVE_MUN, mont_str)

#subsidies to strengthen inspection and surveillance
ins.subsidy<- readxl::read_xlsx(paste0(input.dir,"/Capacidad_adaptativa/Subsidios_pesqueros/beneficiarios_vigilancia_2011-2019.xlsx")) %>% 
  dplyr::filter(año>=2014) %>% 
  dplyr::rename(municipio=municipio_ue)

ins.subsidy.comms <- extract_comms(ins.subsidy)

ins.subsidy.codes <- ins.subsidy.comms %>% 
  dplyr::rename(CVE_LOC = cve_inegi, CVE_MUN = cve_mun_ue) %>% 
  dplyr::mutate(id_row = 1, mont_tot = monto_conapesca)%>% 
  dplyr::filter(mont_tot!=0) %>% 
  make_code() %>%
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(no_ins=sum(id_row), tot_ins=sum(mont_tot)) %>% 
  dplyr::mutate(mont_ins = (tot_ins / no_ins)) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(CVE_LOC, CVE_MUN, mont_ins)

#subsidies to strengthen the legal framework
leg.subsidy<- readxl::read_xlsx(paste0(input.dir,"/Capacidad_adaptativa/Subsidios_pesqueros/beneficiarios_ordenamiento_2011-2019.xlsx")) %>% 
  dplyr::filter(año>=2014) 

leg.subsidy.comms <- extract_comms(leg.subsidy)

leg.subsidy.codes <- leg.subsidy.comms %>% 
  dplyr::rename(CVE_LOC = cve_inegi, CVE_MUN = cve_mun) %>% 
  dplyr::mutate(id_row = 1, mont_tot = monto_conapesca)%>% 
  dplyr::filter(mont_tot!=0) %>% 
  dplyr::filter(CVE_MUN!="NA") %>% 
  make_code() %>%
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(no_leg=sum(id_row), tot_leg=sum(mont_tot)) %>% 
  dplyr::mutate(mont_leg = (tot_leg / no_leg)) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(CVE_LOC, CVE_MUN, mont_leg)

#subsidies to reduce effort in industrial fishing
eff.subsidy<- readxl::read_xlsx(paste0(input.dir,"/Capacidad_adaptativa/Subsidios_pesqueros/beneficiarios_reduccion_esfuerzo_2011-2018.xlsx")) %>% 
  dplyr::filter(año>=2014)

eff.subsidy.comms <- extract_comms(eff.subsidy)

eff.subsidy.codes <- eff.subsidy.comms %>% 
  dplyr::rename(CVE_LOC = cve_inegi, CVE_MUN = cve_mun) %>% 
  dplyr::mutate(id_row = 1, mont_tot = monto_conapesca)%>% 
  dplyr::select(-cve_loc) %>% 
  dplyr::filter(mont_tot!=0) %>% 
  make_code() %>%
  dplyr::group_by(CVE_LOC, CVE_MUN) %>% 
  dplyr::summarise(no_eff=sum(id_row), tot_eff=sum(mont_tot)) %>% 
  dplyr::mutate(mont_eff = (tot_eff / no_eff)) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(CVE_LOC, CVE_MUN, mont_eff)

all.fishery.subsidies <- inegi.cost.comm %>% 
  dplyr::left_join(bpesca.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(gas.subsidy.codes,by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(boat.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(commerce.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(aqua.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(consump.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(value.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(str.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(ins.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(leg.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) %>% 
  dplyr::left_join(eff.subsidy.codes, by = c("CVE_LOC", "CVE_MUN")) 

fishery.tot.subs <- all.fishery.subsidies %>% 
  replace(is.na(.), 0) %>% 
  dplyr::mutate(sum_subs = rowSums(dplyr::across(mont_gas:mont_eff)))
```

```{r}
fishery.denue.subs <- fishery.tot.subs %>% 
  dplyr::left_join(denue_fisheries_coms_cost, by =c("CVE_MUN","CVE_LOC","COM_ID")) %>% 
  dplyr::mutate(neg_tot = dplyr::if_else(is.na(neg_tot),0,neg_tot)) %>% 
  dplyr::filter(sum_subs >0 | neg_tot >0)
```


