---
title: "Coastal vulnerability"

output:
  html_document

knit: (function(input, encoding) {
    rmarkdown::render(
      input = input,
      encoding = encoding,
      envir = globalenv()
    )
  })
---

Identify coastal communities

```{r}
#rebuild and load the package
devtools::load_all() # restarts and loads

```
```{r}
#set data dir
input.dir <- "~/coastalvulnerability-inputs"

```


```{r}

#coordinates
crs.proj.utm <- "+proj=utm +zone=12 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +datum=NAD83"
crs.proj.wgs <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"

#Gulf of California and Yucatan Peninsula states
ents.selecc <- c("['Baja California Sur']", "['Baja California']", "['Sonora']", "['Sinaloa']", "['Nayarit']", "['Jalisco']", "['Yucatán']", "['Campeche']", "['Quintana Roo']")
ents.coast.selecc <- c("Baja California Sur", "Baja California", "Sonora", "Sinaloa", "Nayarit", "Jalisco", "Yucatán", "Campeche", "Quintana Roo")

#all coastal states
#ents.coast <- c("Baja California Sur", "Baja California", "Sonora", "Sinaloa", "Nayarit", "Jalisco", "Colima", "Michoacán de Ocampo", "Guerrero", "Oaxaca", "Chiapas", "Quintana Roo", "Yucatán", "Campeche", "Tabasco", "Veracruz de Ignacio de la Llave", "Tamaulipas")

#read county (municipio) shape and subset selected states
municipios.selecc <- sf::st_read(paste0(input.dir, "/shp_files/georef-mexico-municipality-millesime.shp")) %>% 
dplyr::filter(sta_name %in% ents.selecc) 

#read atlantic ocean shp
atlantic.shp <- sf::st_read(paste0(input.dir,"/shp_files/atlantic_ocean.shp")) 
#read pacific ocean shp
pacific.shp <- sf::st_read(paste0(input.dir,"/shp_files/pacific_ocean.shp")) 

#read shp Mexico states
est.mex <- sf::st_read(paste0(input.dir,"/datos_INEGI_2020/dest2019gw.shp"))
estados.shp <- sf::st_read(paste0(input.dir,"/shp_files/ESTADOS.shp"))

#2020 Census data 
inegi.2020 <- readr::read_csv(paste0(input.dir,"/datos_INEGI_2020/conjunto_de_datos/conjunto_de_datos_iter_00_cpv2020.csv")) %>% 
  dplyr::filter(LONGITUD!=0) %>% 
  dplyr::filter(NOM_ENT %in% ents.coast.selecc)


#extract and save codes for states
estados.shp %>% 
  sf::st_drop_geometry() %>% 
  dplyr::filter(NOM_ENT %in% ents.selecc) %>% 
readr::write_csv(paste0(input.dir,"/procesados/edos_gcyuc.csv"))

#estados.mx <- cbind(est.2019, st_coordinates(st_centroid(est.2019)))

#select counties in selected states that are coastal
#pacific 
mun.cost.pac <- municipios.selecc %>% 
   dplyr::mutate(pac_distance=sf::st_distance(., pacific.shp)) %>% 
   dplyr::filter((as.numeric(pac_distance)) < 5000)
#atlantic
mun.cost.atl <- municipios.selecc %>% 
   dplyr::mutate(atl_distance=sf::st_distance(., atlantic.shp)) %>% 
   dplyr::filter((as.numeric(atl_distance)) < 5000)

#join counties from apcific and atlantic
mun.cost <- mun.cost.atl %>% 
  dplyr::bind_rows(mun.cost.pac)

#get community data, output is spatial data layer
inegi.cost <- get_community_data(inegi.2020, crs.proj.utm, crs.proj.wgs, mun.cost, ents.coast.selecc)

inegi.cost.comm <- inegi.cost %>% 
  sf::st_drop_geometry() %>% 
  dplyr::distinct(CVE_LOC) 

inegi.cost.comm %>% readr::write_csv(here::here("outputs","inegi_coast_comm.csv"))

sf::st_write(mun.cost, here::here("outputs","shp_files","mun_cost.shp"), delete_layer = TRUE)

make_map(mun.cost, inegi.cost, estados.shp, crs.proj.utm, thistitle="Total population",thisoutput=here::here("outputs","figures","map_locs_en.png"))

make_map(mun.cost, inegi.cost, estados.shp, crs.proj.utm, thistitle="Población total",thisoutput=here::here("outputs","figures","map_locs_sp.png"))


```

Descarga masiva de datos DENUE, Unidades economicas para todo el pais por tipo de actividad economica
Datos actualizados a Noviembre 2022
```{r}

inegi.comm.codes  <-  readr::read_csv(here::here("outputs","inegi_coast_comm.csv")) %>% 
  dplyr::pull(CVE_LOC)

denue.links= "links_DENUE_descarga_masiva_2023.csv"

unidades.denue <- readr::read_csv(paste0(input.dir,"/", denue.links))

#only run once
#actividad.denue <- get_denue(unidades.denue, input.dir) 

unzip_denue(input.dir)

denue.inegi <- list.files(path=paste0(input.dir,"/denue/conjunto_de_datos"), pattern="denue_inegi_*.*")
denue.inegi.full <- list.files(path=paste0(input.dir,"/denue/conjunto_de_datos"), pattern="denue_inegi_*.*", full.names = TRUE)

list.denue <- 1:length(denue.inegi)

lapply(list.denue, extract_denue, denue.inegi, denue.inegi.full, input.dir, inegi.comm.codes)

denue.cost.comms <- list.files(path=paste0(input.dir,"/denue"), pattern="denue_*.*", full.names = TRUE) 

# remove fisheries
denue.other.act <- denue.cost.comms[!denue.cost.comms %in% c("/home/atlantis/coastalvulnerability-inputs/denue/denue_fisheries_coms_cost.csv")]  

denue.other <- lapply(denue.other.act, combine_denue)
  
denue.other.comm <- denue.other %>% 
  dplyr::bind_rows()

denue.other.comm %>% readr::write_csv(here::here("outputs","denue_other_ecactiv.csv"))

denue.other.comm %>% 
  dplyr::group_by(CVE_LOC, COM_ID) %>% 
  dplyr::summarise(tot_denue = sum(neg_tot)) %>% 
  readr::write_csv(here::here("outputs","denue_tot_ecactiv.csv"))


```



```{r}
sheetlink = "https://docs.google.com/spreadsheets/d/1j9GJKPjKgpf4w3bDeS2c8uamN8-L79I1BINjpQe0lCk/edit#gid=1817952998"
# 
tabla.susc <- read_googlesheet(sheetlink, sheetname = "resumen_indicadores_susceptibilidad", coltypes = "cccccccccccccccccccc")
tabla.susc <- read_googlesheet(sheetlink, sheetname = "resumen_indicadores_exposicion", coltypes = "cccccccccccccccccccc")


for(i in 1:nrow(tabla.susc)){
  
  this.susc <- tabla.susc[i,]
  
}

```


```{calcular_carreteras}

crs.proj.utm <- "+proj=utm +zone=12 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +datum=NAD83"
crs.proj.wgs <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"

ext.carr.proj <- sf::st_read("~/coastalvulnerability-inputs/Capacidad_adaptativa/Acceso_por_carretera/carre1mgw.shp") %>% 
sf::st_transform(., 6367)

length.mt <- ext.carr.proj %>% 
  sf::st_length() %>% 
  sf::st_drop_geometry() %>% 
  as.numeric() %>% 
  tidyr::as_tibble() %>% 
  dplyr::rename(length_m=value)

ext.carr.proj.dis <- ext.carr.proj %>% 
  bind_cols(length.mt)

municipios.proj <- sf::st_read("~/coastalvulnerability-inputs/shp_files/georef-mexico-municipality-millesime.shp") %>% 
sf::st_transform(., 6367)

carretera.mun <- sf::st_join(ext.carr.proj.dis, municipios.proj, join = st_within)

carretera.mun.sum <- as_tibble(carretera.mun) %>% 
  sf::st_drop_geometry() %>% 
  dplyr::mutate(mun_cve = gsub("\\[","",mun_code), 
         mun_cve = gsub("\\]","",mun_cve),
         mun_cve = gsub("\\'","",mun_cve)) %>% 
  dplyr::group_by(mun_cve) %>% 
  dplyr::summarise(tot_length_mun = sum(length_m)) %>% 
  dplyr::rename(CVE_MUN=mun_cve)


readr::write_csv(carretera.mun.sum, "~/coastalvulnerability-inputs/procesados/capacidad_adaptativa/longitud_carretera_mun.csv")
```


```{r acceso a la informacion}

neg.educa <- data.table::fread("~/coastalvulnerability-inputs/Capacidad_adaptativa/Acceso_a_la_informacion/denue_inegi_61_.csv")

neg.educa.mun <- neg.educa %>% 
  mutate(no_loc = nchar(cve_loc), no_mun = nchar(cve_mun), no_ent = nchar(cve_ent)) %>% 
  mutate(cve_loc = as.character(cve_loc), cve_mun = as.character(cve_mun), cve_ent = as.character(cve_ent)) %>% 
  mutate(cveloc=if_else(no_loc==1,paste0("000",cve_loc),
                               if_else(no_loc==2,paste0("00",cve_loc),
                                        if_else(no_loc==3,paste0("0",cve_loc),
                                               if_else(no_loc==4,cve_loc, cve_loc))))) %>% 
  mutate(cvemun=if_else(no_mun==1,paste0("00",cve_mun),
                               if_else(no_mun==2,paste0("0",cve_mun), cve_mun))) %>% 
  mutate(cveent=if_else(no_ent==1,paste0("0",cve_ent), cve_ent)) %>% 
  mutate(CVE_LOC = paste0(cveent,cvemun,cveloc), INDEX = 1:nrow(.)) %>% 
  group_by(CVE_LOC) %>% 
  summarise(est_educa = sum(INDEX))
  

readr::write_csv(neg.educa.mun, "~/coastalvulnerability-inputs/procesados/capacidad_adaptativa/establecimientos_edu_mun.csv")

```

